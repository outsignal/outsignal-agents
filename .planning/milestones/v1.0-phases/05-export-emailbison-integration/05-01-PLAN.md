---
phase: 05-export-emailbison-integration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/export/verification-gate.ts
  - src/lib/export/csv.ts
  - src/app/api/lists/[id]/export/route.ts
autonomous: true
requirements:
  - EXPORT-02
  - EXPORT-03

must_haves:
  truths:
    - "Export is blocked when any person in the list has an unverified email"
    - "CSV contains all enriched Person and Company fields including phone and location"
    - "enrichmentData is flattened into individual CSV columns for both array and object formats"
    - "Company data is joined via companyDomain soft link"
    - "GET /api/lists/[id]/export returns a downloadable CSV file"
  artifacts:
    - path: "src/lib/export/verification-gate.ts"
      provides: "Export readiness check and verification trigger for TargetList members"
      exports: ["getListExportReadiness", "verifyAndFilter", "ExportReadiness"]
      min_lines: 50
    - path: "src/lib/export/csv.ts"
      provides: "CSV generation with enrichmentData flattening and verification gate"
      exports: ["flattenEnrichmentData", "escapeCsv", "generateListCsv"]
      min_lines: 80
    - path: "src/app/api/lists/[id]/export/route.ts"
      provides: "CSV download endpoint for target lists"
      exports: ["GET"]
      min_lines: 20
  key_links:
    - from: "src/lib/export/verification-gate.ts"
      to: "src/lib/verification/leadmagic.ts"
      via: "import getVerificationStatus, verifyEmail"
      pattern: "import.*from.*verification/leadmagic"
    - from: "src/lib/export/csv.ts"
      to: "src/lib/export/verification-gate.ts"
      via: "import getListExportReadiness"
      pattern: "import.*from.*verification-gate"
    - from: "src/app/api/lists/[id]/export/route.ts"
      to: "src/lib/export/csv.ts"
      via: "import generateListCsv"
      pattern: "import.*from.*export/csv"
---

<objective>
Build the verification gate that blocks any export (EmailBison or CSV) if any person in the list has an unverified email, and a CSV generation utility that flattens Person + Company data into a downloadable file. Wire the CSV endpoint into the existing lists API so `GET /api/lists/[id]/export` returns a CSV file.

Purpose: Enforces email verification requirement before any data leaves the system, and provides CSV export for external tools.

Output: verification-gate.ts (readiness check + verification trigger), csv.ts (CSV generation with enrichmentData flattening), and /api/lists/[id]/export route.
</objective>

<execution_context>
@/Users/jjay/.claude/get-shit-done/workflows/execute-plan.md
@/Users/jjay/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-export-emailbison-integration/05-RESEARCH.md

<interfaces>
<!-- Key types and contracts the executor needs. Extracted from codebase. -->

From src/lib/verification/leadmagic.ts:
```typescript
export async function getVerificationStatus(personId: string): Promise<VerificationResult | null>;
export async function verifyEmail(email: string, personId: string): Promise<VerificationResult>;
// VerificationResult has: { isExportable: boolean, status: string, ... }
```

From prisma/schema.prisma (TargetListPerson + Person):
```prisma
model TargetListPerson {
  id       String   @id @default(cuid())
  listId   String
  personId String
  list     TargetList @relation(...)
  person   Person     @relation(...)
  @@unique([listId, personId])
}

model Person {
  id             String   @id @default(cuid())
  email          String   @unique
  firstName      String?
  lastName       String?
  company        String?
  companyDomain  String?
  jobTitle       String?
  linkedinUrl    String?
  phone          String?
  location       String?
  vertical       String?
  enrichmentData String?
  @@map("Lead")
}

model Company {
  domain         String   @id
  name           String?
  industry       String?
  headcount      Int?
  location       String?
  revenue        String?
  yearFounded    Int?
  companyType    String?
  enrichmentData String?
}
```

From src/app/api/lists/[id]/route.ts (existing params pattern):
```typescript
export async function GET(
  request: Request,
  { params }: { params: Promise<{ id: string }> }
) { ... }
```
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create verification gate (getListExportReadiness + verifyAndFilter)</name>
  <files>src/lib/export/verification-gate.ts</files>
  <action>
Create `src/lib/export/verification-gate.ts` with two exported functions:

1. `getListExportReadiness(listId: string)` — returns a summary object:
   - Fetch all `TargetListPerson` records for the list with `person` include (select: id, email, firstName, lastName, jobTitle, company, companyDomain, linkedinUrl, phone, location, vertical, enrichmentData)
   - **CRITICAL: The person select MUST include `phone: true` and `location: true`** — these fields are used in CSV export (base headers) and in the EmailBison lead push (phone passed to createLead). Omitting them causes undefined values at runtime.
   - For each person, call `getVerificationStatus(person.id)` from `src/lib/verification/leadmagic.ts`
   - Categorize into: `ready` (isExportable=true), `needsVerification` (status is null — never verified), `blocked` (verified but not exportable: invalid/catch-all/unknown)
   - Compute:
     - `totalCount`: total members
     - `readyCount`: verified + exportable
     - `needsVerificationCount`: never verified
     - `blockedCount`: verified but blocked
     - `verifiedEmailPct`: `(readyCount / totalCount * 100).toFixed(1)`
     - `verticalBreakdown`: `Record<string, number>` from `person.vertical ?? 'Unknown'`
     - `enrichmentCoverage`: `{ companyDataPct, linkedinPct, jobTitlePct }` — percentage of members with `companyDomain`, `linkedinUrl`, `jobTitle` respectively
     - `readyPeople`: the Person[] array that are exportable (for downstream use)
     - `needsVerificationPeople`: the Person[] that need verification
     - `blockedPeople`: the Person[] that are blocked
   - Return type: `ExportReadiness` interface (export it)

The person select object must be:
```typescript
select: {
  id: true,
  email: true,
  firstName: true,
  lastName: true,
  jobTitle: true,
  company: true,
  companyDomain: true,
  linkedinUrl: true,
  phone: true,
  location: true,
  vertical: true,
  enrichmentData: true,
}
```

2. `verifyAndFilter(people: {id: string, email: string}[])` — runs `verifyEmail(email, personId)` for each person, returns `{ verified: VerificationResult[], excluded: VerificationResult[] }` where excluded means `isExportable === false`. This is called by the agent after user approves verification spend.

Import `getVerificationStatus`, `verifyEmail` from `@/lib/verification/leadmagic`.
Import `prisma` from `@/lib/db`.

Do NOT use the old tag-based query (`PersonWorkspace.tags`). Use `prisma.targetListPerson.findMany({ where: { listId } })`.
  </action>
  <verify>
    <automated>cd /Users/jjay/programs/outsignal-agents && npx tsc --noEmit src/lib/export/verification-gate.ts 2>&1 | head -20</automated>
  </verify>
  <done>
- `getListExportReadiness(listId)` compiles and returns ExportReadiness with all fields (totalCount, readyCount, needsVerificationCount, blockedCount, verifiedEmailPct, verticalBreakdown, enrichmentCoverage, readyPeople, needsVerificationPeople, blockedPeople)
- Person select includes phone, location, enrichmentData alongside all other fields
- `verifyAndFilter(people)` compiles and returns `{ verified, excluded }`
- Both functions use TargetListPerson model (not tags)
- Both import from existing verification module
  </done>
</task>

<task type="auto">
  <name>Task 2: Create CSV utility + API endpoint</name>
  <files>src/lib/export/csv.ts, src/app/api/lists/[id]/export/route.ts</files>
  <action>
**Part A: CSV utility (`src/lib/export/csv.ts`)**

Create with these exports:

1. `flattenEnrichmentData(enrichmentData: string | null): Record<string, string>` — handles both formats:
   - If `Array.isArray(parsed)`: treat as `[{name, value}]` → `enrichment_{name}` columns
   - If plain object: treat as `{key: value}` → `enrichment_{key}` columns
   - Returns empty record on null/parse error

2. `escapeCsv(s: string | null | undefined): string` — proper CSV escaping:
   - Null/undefined → empty string
   - Contains comma, double-quote, or newline → wrap in double-quotes, double any internal quotes
   - Otherwise return as-is

3. `generateListCsv(listId: string): Promise<{ csv: string; filename: string; count: number }>`:
   - First call `getListExportReadiness(listId)` from `./verification-gate` — if `needsVerificationCount > 0`, throw an error: `"Export blocked: ${needsVerificationCount} people have unverified emails. Verify first."`
   - If `blockedCount > 0`, only export `readyPeople` (auto-exclude blocked per CONTEXT.md: "invalid/undeliverable emails are automatically excluded")
   - Fetch Company records for all unique `companyDomain` values in a single query: `prisma.company.findMany({ where: { domain: { in: domains } } })`. Build a `Map<string, Company>` for O(1) lookup.
   - Base CSV headers (fixed order): `first_name, last_name, email, job_title, company, company_domain, linkedin_url, phone, location, vertical`
   - Company CSV headers: `company_industry, company_headcount, company_location, company_revenue, company_year_founded, company_type`
   - Enrichment headers: collect ALL unique `enrichment_*` keys from both person and company enrichmentData across the full list. Sort alphabetically. These become dynamic columns.
   - Build CSV string: header row + one data row per person
   - Filename convention: `{listName}_{YYYY-MM-DD}.csv` (sanitize list name: replace non-alphanumeric with underscore, lowercase)
   - To get the list name, fetch the `TargetList` record via `prisma.targetList.findUnique({ where: { id: listId } })`
   - Return `{ csv, filename, count: readyPeople.length }`

**Part B: CSV API endpoint (`src/app/api/lists/[id]/export/route.ts`)**

Create a `GET` handler:
- Extract `id` from route params (same pattern as `src/app/api/lists/[id]/route.ts` — use `Promise<{ id: string }>` for context.params)
- Call `generateListCsv(id)`
- Return the CSV as a `Response` with headers:
  - `Content-Type: text/csv; charset=utf-8`
  - `Content-Disposition: attachment; filename="${filename}"`
- On error, return JSON `{ error: message }` with status 400 (for verification gate block) or 500 (for unexpected errors)
- Distinguish gate errors by checking if error message includes "Export blocked"

Import `prisma` from `@/lib/db`.
Import Company type: use the Prisma-generated types.
  </action>
  <verify>
    <automated>cd /Users/jjay/programs/outsignal-agents && npx tsc --noEmit src/lib/export/csv.ts src/app/api/lists/[id]/export/route.ts 2>&1 | head -20</automated>
  </verify>
  <done>
- `flattenEnrichmentData` handles both array and object formats, returns `Record<string, string>`
- `escapeCsv` handles commas, quotes, newlines correctly
- `generateListCsv` enforces verification gate (throws on unverified), auto-excludes blocked, joins Company data, flattens enrichmentData, returns CSV string
- `GET /api/lists/[id]/export` returns CSV file response with Content-Disposition header
- Verification gate blocks CSV export of unverified emails (EXPORT-02 enforced)
  </done>
</task>

</tasks>

<verification>
After both tasks:
1. TypeScript compiles without errors
2. `src/lib/export/verification-gate.ts` exports `getListExportReadiness` and `verifyAndFilter` using TargetListPerson model
3. `src/lib/export/csv.ts` exports `flattenEnrichmentData`, `escapeCsv`, `generateListCsv`
4. `GET /api/lists/[id]/export` route exists and returns CSV content type
</verification>

<success_criteria>
- Verification gate blocks export when unverified emails exist
- CSV includes all Person fields (including phone and location) + Company fields + flattened enrichmentData
- Both array-format and object-format enrichmentData are handled
- TargetList model used (not tags)
</success_criteria>

<output>
After completion, create `.planning/phases/05-export-emailbison-integration/05-01-SUMMARY.md`
</output>
