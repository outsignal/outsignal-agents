---
phase: 03.1-api-security-hardening
plan: 01
subsystem: api
tags: [security, auth, cron, mcp, crypto]

# Dependency graph
requires:
  - phase: 03-icp-qualification-leads-agent
    provides: enrichment routes and MCP server that this plan secures
provides:
  - validateCronSecret helper using crypto.timingSafeEqual for constant-time auth
  - POST /api/enrichment/run protected with Bearer token auth (401 on fail)
  - POST /api/enrichment/jobs/process protected with Bearer token auth (401 on fail)
  - MCP server env forwarding for FIRECRAWL_API_KEY, ANTHROPIC_API_KEY, LEADMAGIC_API_KEY
affects: [03.1-02-PLAN, any future cron-triggered routes]

# Tech tracking
tech-stack:
  added: []
  patterns:
    - validateCronSecret: central auth helper using timingSafeEqual, fail-closed when CRON_SECRET not configured
    - Bearer token check placed as FIRST action in POST handler before any business logic
    - Request (not NextRequest) parameter type for process route — minimal interface, only needs .headers.get()

key-files:
  created:
    - src/lib/cron-auth.ts
  modified:
    - src/app/api/enrichment/run/route.ts
    - src/app/api/enrichment/jobs/process/route.ts
    - .mcp.json

key-decisions:
  - "Accept Request (not NextRequest) in validateCronSecret — minimal interface, only needs .headers.get()"
  - "crypto.timingSafeEqual for constant-time comparison — prevents timing attacks"
  - "Fail closed when CRON_SECRET not configured — rejects all requests"
  - "Check buffer lengths before timingSafeEqual to prevent ERR_CRYPTO_TIMING_SAFE_EQUAL_LENGTH throw"
  - "Return generic 401 {error: Unauthorized} — no details about auth mechanism exposed to caller"
  - "Log failed attempts to console only (timestamp + route) — visible in Vercel logs"

patterns-established:
  - "Auth guard pattern: import validateCronSecret, call as first action in POST handler, return 401 on failure"
  - "MCP env forwarding: use ${VAR} syntax (with braces) in .mcp.json env block"

requirements-completed: []

# Metrics
duration: 2min
completed: 2026-02-26
---

# Phase 03.1 Plan 01: API Security Hardening — Enrichment Routes Summary

**Timing-safe Bearer token auth on two unauthenticated enrichment trigger routes plus MCP API key env forwarding for enrichment, ICP scoring, and email verification**

## Performance

- **Duration:** 2 min
- **Started:** 2026-02-26T22:58:54Z
- **Completed:** 2026-02-26T22:59:30Z
- **Tasks:** 2
- **Files modified:** 4

## Accomplishments
- Created `src/lib/cron-auth.ts` with `validateCronSecret` using `crypto.timingSafeEqual` — prevents timing attacks, fails closed when `CRON_SECRET` not configured
- Hardened `POST /api/enrichment/run` — rejects unauthenticated requests with 401 before any DB or business logic runs
- Hardened `POST /api/enrichment/jobs/process` — added `request: Request` parameter and identical auth guard; previously accepted no request param (fully open)
- Added `FIRECRAWL_API_KEY`, `ANTHROPIC_API_KEY`, `LEADMAGIC_API_KEY` to `.mcp.json` env forwarding — MCP server can now run enrichment, ICP scoring, and email verification tools

## Task Commits

Each task was committed atomically:

1. **Task 1: Create validateCronSecret helper and harden both route handlers** - `56a863e` (feat)
2. **Task 2: Add missing env vars to .mcp.json** - `fc9cdb0` (feat)

**Plan metadata:** (see final docs commit)

## Files Created/Modified
- `src/lib/cron-auth.ts` - validateCronSecret helper using crypto.timingSafeEqual; fail-closed pattern
- `src/app/api/enrichment/run/route.ts` - Added validateCronSecret import and auth guard as first action in POST handler
- `src/app/api/enrichment/jobs/process/route.ts` - Added request: Request parameter, validateCronSecret import, and auth guard
- `.mcp.json` - Added FIRECRAWL_API_KEY, ANTHROPIC_API_KEY, LEADMAGIC_API_KEY to MCP server env block

## Decisions Made
- Accept `Request` (not `NextRequest`) in `validateCronSecret` — minimal interface sufficient (only needs `.headers.get()`), keeps helper decoupled from Next.js
- `crypto.timingSafeEqual` for constant-time comparison — prevents timing-based token enumeration attacks
- Fail closed when `CRON_SECRET` not configured — logs warning to console for visibility, rejects all requests
- Check buffer lengths before `timingSafeEqual` to prevent `ERR_CRYPTO_TIMING_SAFE_EQUAL_LENGTH` throw
- Return generic `{"error": "Unauthorized"}` 401 — no information about auth mechanism leaked to caller
- Log failed attempts with ISO timestamp and route path to console — visible in Vercel function logs without exposing to callers

## Deviations from Plan

None - plan executed exactly as written.

## Issues Encountered

None.

## User Setup Required

`CRON_SECRET` environment variable must be set in Vercel for the auth guards to pass. Without it, both enrichment routes will reject all requests (fail closed).

Vercel env var setup:
```bash
printf 'your-cron-secret-value' | vercel env add CRON_SECRET production
```

## Next Phase Readiness
- Both enrichment trigger routes are now protected — INT-01 gap closed
- MCP server has all required API keys for enrichment, ICP scoring, and email verification tools
- Ready for Phase 03.1 Plan 02 (if any further security hardening tasks exist)
- Any future cron-triggered routes should import `validateCronSecret` from `@/lib/cron-auth` and apply the same pattern

---
*Phase: 03.1-api-security-hardening*
*Completed: 2026-02-26*

## Self-Check: PASSED

- FOUND: src/lib/cron-auth.ts
- FOUND: src/app/api/enrichment/run/route.ts
- FOUND: src/app/api/enrichment/jobs/process/route.ts
- FOUND: .mcp.json
- Commit 56a863e: verified in git log
- Commit fc9cdb0: verified in git log
- TypeScript: `npx tsc --noEmit` passes with zero errors
- All 4 MCP env vars confirmed present: DATABASE_URL, FIRECRAWL_API_KEY, ANTHROPIC_API_KEY, LEADMAGIC_API_KEY
- `timingSafeEqual` usage confirmed in src/lib/cron-auth.ts
