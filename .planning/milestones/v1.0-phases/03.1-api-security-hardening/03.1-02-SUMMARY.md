---
phase: 03.1-api-security-hardening
plan: 02
subsystem: test-infrastructure
tags: [tests, vitest, typescript, enrichment-queue, mocks]
dependency_graph:
  requires: []
  provides: [dailyCostTotal-mock, DAILY_CAP_HIT-test-coverage, clean-tsc-for-emailbison-tests]
  affects: [src/__tests__/setup.ts, src/__tests__/enrichment-queue.test.ts, src/__tests__/emailbison-client.test.ts]
tech_stack:
  added: []
  patterns: [vitest-vi-fn-mock, double-cast-global-mock, processedCount-offset-testing]
key_files:
  created: []
  modified:
    - src/__tests__/setup.ts
    - src/__tests__/enrichment-queue.test.ts
    - src/__tests__/emailbison-client.test.ts
decisions:
  - "dailyCostTotal mock added adjacent to enrichmentJob — minimal scope, enables future waterfall cost cap tests"
  - "global.fetch cast as unknown as typeof fetch — idiomatic Vitest double-cast bridges Mock<Procedure> to typeof fetch through unknown"
  - "DAILY_CAP_HIT tests mock onProcess directly (not waterfall) — tests queue mechanics independently; waterfall-level tests enabled by dailyCostTotal mock addition"
metrics:
  duration: 76s
  completed: "2026-02-26T23:00:16Z"
  tasks_completed: 2
  files_modified: 3
---

# Phase 03.1 Plan 02: Test Infrastructure Gap Closure Summary

One-liner: Added dailyCostTotal Prisma mock, fixed TS2322 global.fetch cast, and added 3 DAILY_CAP_HIT test cases covering full/partial/zero-progress pause scenarios.

## Tasks Completed

| Task | Name | Commit | Files |
|------|------|--------|-------|
| 1 | Add dailyCostTotal mock + fix TS2322 | 40df12a | src/__tests__/setup.ts, src/__tests__/emailbison-client.test.ts |
| 2 | Add DAILY_CAP_HIT test cases | 58b3748 | src/__tests__/enrichment-queue.test.ts |

## What Was Built

### Task 1: Test Setup and TypeScript Fix

**src/__tests__/setup.ts** — Added `dailyCostTotal` mock with `findUnique` and `upsert` methods adjacent to the `enrichmentJob` block in the global Prisma mock. This enables future waterfall cost cap tests that need to mock `dailyCostTotal.upsert`.

**src/__tests__/emailbison-client.test.ts** — Fixed TS2322 type error on `global.fetch = fetchMock` by adding the double cast: `global.fetch = fetchMock as unknown as typeof fetch`. This is the idiomatic Vitest pattern — bridges `Mock<Procedure | Constructable>` to `typeof fetch` through `unknown`. `tsc --noEmit` now compiles cleanly.

### Task 2: DAILY_CAP_HIT Test Coverage

Added 3 new test cases to `describe("processNextChunk")` covering all DAILY_CAP_HIT paths in `queue.ts` lines 113-132:

1. **"pauses job when onProcess throws DAILY_CAP_HIT"** — p1 succeeds, p2 throws cap. Verifies: result `{processed:1, status:"paused", done:false}`, DB update has `{status:"paused", processedCount:1}`, `resumeAt` is a future Date.

2. **"pauses immediately when first entity hits DAILY_CAP_HIT (0 processed)"** — boundary case where first entity throws cap. Verifies: `{processed:0, status:"paused"}`, `onProcess` called exactly once.

3. **"pauses mid-chunk when DAILY_CAP_HIT fires after partial progress"** — resumes from offset 2, c3/c4 succeed, c5 throws cap. Verifies: `{processed:2, status:"paused"}`, DB `processedCount = 4` (chunkStart 2 + processedInChunk 2).

## Verification Results

- `tsc --noEmit` — clean, no errors
- `vitest run src/__tests__/enrichment-queue.test.ts` — 12/12 pass (9 existing + 3 new)
- `vitest run src/__tests__/emailbison-client.test.ts` — 19/19 pass
- `grep "dailyCostTotal" src/__tests__/setup.ts` — present
- `grep "DAILY_CAP_HIT" src/__tests__/enrichment-queue.test.ts` — 7 occurrences (3 test names + inline usage)

## Deviations from Plan

None - plan executed exactly as written.

## Self-Check: PASSED

- [x] src/__tests__/setup.ts modified — `dailyCostTotal` present (line 51)
- [x] src/__tests__/emailbison-client.test.ts modified — `as unknown as typeof fetch` present (line 76)
- [x] src/__tests__/enrichment-queue.test.ts modified — 3 DAILY_CAP_HIT tests added (lines 222, 271, 303)
- [x] Commit 40df12a exists (Task 1)
- [x] Commit 58b3748 exists (Task 2)
- [x] tsc --noEmit clean
- [x] All tests pass
