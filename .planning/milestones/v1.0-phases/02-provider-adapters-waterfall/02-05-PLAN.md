---
phase: 02-provider-adapters-waterfall
plan: 05
type: execute
wave: 4
depends_on: ["02-01", "02-04"]
files_modified:
  - src/app/api/enrichment/costs/route.ts
  - src/app/admin/enrichment-costs/page.tsx
autonomous: true
requirements: []

must_haves:
  truths:
    - "GET /api/enrichment/costs returns per-workspace, per-provider cost breakdown for a given date range"
    - "Cost dashboard page displays spend data using Recharts charts"
    - "Dashboard shows today's spend vs daily cap"
    - "Dashboard shows per-provider breakdown (Prospeo, LeadMagic, FindyMail, AI Ark, Firecrawl)"
    - "Dashboard shows per-workspace (client) costs"
  artifacts:
    - path: "src/app/api/enrichment/costs/route.ts"
      provides: "GET endpoint for cost aggregation data"
      exports: ["GET"]
    - path: "src/app/admin/enrichment-costs/page.tsx"
      provides: "Cost dashboard UI with Recharts charts"
      min_lines: 80
  key_links:
    - from: "src/app/api/enrichment/costs/route.ts"
      to: "prisma.enrichmentLog.groupBy"
      via: "Aggregate costs by provider and workspaceSlug"
      pattern: "prisma\\.enrichmentLog\\.groupBy"
    - from: "src/app/admin/enrichment-costs/page.tsx"
      to: "/api/enrichment/costs"
      via: "fetch in useEffect or server component data loading"
      pattern: "api/enrichment/costs"
---

<objective>
Build the cost dashboard API endpoint and UI page that shows enrichment spend per workspace and per provider.

Purpose: Cost visibility is essential for a pipeline that makes paid API calls. The dashboard lets the user see how much each workspace is spending and which providers are being used, so they can adjust the daily cap and monitor ROI.
Output: GET /api/enrichment/costs endpoint returning aggregated cost data, and an admin page at /admin/enrichment-costs with Recharts visualizations.
</objective>

<execution_context>
@/Users/jjay/.claude/get-shit-done/workflows/execute-plan.md
@/Users/jjay/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-provider-adapters-waterfall/02-RESEARCH.md
@.planning/phases/02-provider-adapters-waterfall/02-01-SUMMARY.md

@prisma/schema.prisma
@src/lib/enrichment/costs.ts

<interfaces>
<!-- Schema and cost types from Plan 01 -->

From prisma/schema.prisma (after Plan 01):
```prisma
model EnrichmentLog {
  id            String   @id @default(cuid())
  entityId      String
  entityType    String
  provider      String
  status        String   @default("success")
  fieldsWritten String?
  costUsd       Float?
  rawResponse   String?
  errorMessage  String?
  runAt         DateTime @default(now())
  workspaceSlug String?
  @@index([workspaceSlug, provider])
}

model DailyCostTotal {
  id        String   @id @default(cuid())
  date      String   @unique
  totalUsd  Float    @default(0)
  breakdown String?
  updatedAt DateTime @updatedAt
}
```

From src/lib/enrichment/costs.ts (from Plan 01):
```typescript
export const PROVIDER_COSTS: Record<string, number> = { prospeo: 0.002, leadmagic: 0.005, findymail: 0.001, aiark: 0.003, firecrawl: 0.001 };
export function todayUtc(): string;
export async function checkDailyCap(): Promise<boolean>;
```

Recharts (already installed, v3.7.0):
```typescript
import { BarChart, Bar, XAxis, YAxis, CartesianGrid, Tooltip, Legend, PieChart, Pie, Cell, ResponsiveContainer } from "recharts";
```
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Cost aggregation API endpoint</name>
  <files>src/app/api/enrichment/costs/route.ts</files>
  <action>
Create `src/app/api/enrichment/costs/route.ts` — GET endpoint that returns cost aggregation data.

Query params:
- `from` — start date (YYYY-MM-DD), defaults to 30 days ago
- `to` — end date (YYYY-MM-DD), defaults to today
- `workspace` — optional workspace slug filter

Response shape:
```typescript
{
  period: { from: string, to: string },
  dailyCap: number,
  todaySpend: number,
  capHit: boolean,
  totalSpend: number,
  byProvider: Array<{ provider: string, totalUsd: number, callCount: number }>,
  byWorkspace: Array<{ workspace: string, totalUsd: number, callCount: number }>,
  byDate: Array<{ date: string, totalUsd: number }>,
}
```

Implementation:
1. Parse query params from `request.nextUrl.searchParams`
2. Calculate date range defaults
3. **Total spend**: `prisma.enrichmentLog.aggregate({ _sum: { costUsd: true }, where: { status: "success", runAt: { gte, lte }, ...(workspace filter) } })`
4. **By provider**: `prisma.enrichmentLog.groupBy({ by: ["provider"], _sum: { costUsd: true }, _count: true, where: { status: "success", runAt: { gte, lte } } })`
5. **By workspace**: `prisma.enrichmentLog.groupBy({ by: ["workspaceSlug"], _sum: { costUsd: true }, _count: true, where: { status: "success", runAt: { gte, lte }, workspaceSlug: { not: null } } })`
6. **By date**: Use DailyCostTotal for efficient date-level aggregation: `prisma.dailyCostTotal.findMany({ where: { date: { gte: fromStr, lte: toStr } }, orderBy: { date: "asc" } })`
7. **Today's spend**: `prisma.dailyCostTotal.findUnique({ where: { date: todayUtc() } })` — returns `totalUsd`
8. **Daily cap**: from `getDailyCap()` (read from env, same logic as costs.ts)
9. **Cap hit**: `todaySpend >= dailyCap`

Return all data as JSON with `NextResponse.json()`.

Import `prisma` from `@/lib/db`, `todayUtc` from `@/lib/enrichment/costs`.
  </action>
  <verify>
    <automated>cd /Users/jjay/programs/outsignal-agents && npx tsc --noEmit --pretty 2>&1 | head -20</automated>
  </verify>
  <done>GET /api/enrichment/costs returns period, dailyCap, todaySpend, capHit, totalSpend, byProvider, byWorkspace, and byDate data. Filters by date range and optional workspace.</done>
</task>

<task type="auto">
  <name>Task 2: Cost dashboard page with Recharts visualizations</name>
  <files>src/app/admin/enrichment-costs/page.tsx</files>
  <action>
Create `src/app/admin/enrichment-costs/page.tsx` — a client-side page that fetches from `/api/enrichment/costs` and renders cost data.

Use `"use client"` directive. Brand color is `#F0FF7A`.

Layout:
1. **Header**: "Enrichment Costs" title with date range selector (simple from/to date inputs)
2. **Summary cards row** (4 cards in a grid):
   - Today's Spend: `$X.XX / $Y.YY cap` (show progress bar, red if cap hit)
   - Total Spend (period): `$X.XX`
   - API Calls (period): `N`
   - Cap Status: "Active" (green) or "Cap Hit" (red)

3. **Charts section** (two columns on desktop, stacked on mobile):
   - **Left: Provider Breakdown** — PieChart or BarChart showing spend by provider. Each provider gets a distinct color. Use `<PieChart>` with `<Pie>` and `<Cell>` components from Recharts.
   - **Right: Workspace Breakdown** — BarChart showing spend by workspace/client. Horizontal bars. Each bar labeled with workspace name.

4. **Daily trend** (full width below charts):
   - BarChart showing daily spend over the period. X-axis: dates, Y-axis: USD. A horizontal reference line at the daily cap level.

Styling:
- Use Tailwind CSS (already in project)
- Dark background consistent with existing admin pages: `bg-gray-950 text-white`
- Cards: `bg-gray-900 rounded-lg p-4 border border-gray-800`
- Accent color: `#F0FF7A` for highlights and chart accent
- Chart colors: use a palette array like `["#F0FF7A", "#4ECDC4", "#FF6B6B", "#45B7D1", "#96E6A1"]`

Data fetching:
- Use `useState` + `useEffect` with `fetch("/api/enrichment/costs?from=...&to=...")`
- Loading state with skeleton cards
- Error state with retry button
- Date range inputs trigger re-fetch

This is a new page — no existing files to modify. Follow the existing app directory structure. Check if `/admin` directory exists; if not, create it.

Import Recharts components: `BarChart, Bar, XAxis, YAxis, CartesianGrid, Tooltip, Legend, PieChart, Pie, Cell, ResponsiveContainer, ReferenceLine`.
  </action>
  <verify>
    <automated>cd /Users/jjay/programs/outsignal-agents && npx tsc --noEmit --pretty 2>&1 | head -20</automated>
  </verify>
  <done>Cost dashboard page renders at /admin/enrichment-costs with summary cards, provider/workspace breakdown charts, and daily trend chart. Fetches from /api/enrichment/costs with date range params.</done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` — both files compile without errors
2. GET /api/enrichment/costs returns valid JSON with all expected fields
3. Dashboard page renders without console errors
4. PieChart shows provider breakdown with distinct colors
5. BarChart shows workspace breakdown
6. Daily trend chart shows spend over time with cap reference line
7. Date range inputs trigger data re-fetch
8. Summary cards show today's spend vs cap
</verification>

<success_criteria>
- API endpoint aggregates cost data from EnrichmentLog using Prisma groupBy
- Dashboard displays per-workspace and per-provider cost breakdowns visually
- Today's spend vs daily cap is clearly visible with progress indicator
- Page is responsive (works on desktop and mobile)
</success_criteria>

<output>
After completion, create `.planning/phases/02-provider-adapters-waterfall/02-05-SUMMARY.md`
</output>
