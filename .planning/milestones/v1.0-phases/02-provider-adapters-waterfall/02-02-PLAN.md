---
phase: 02-provider-adapters-waterfall
plan: 02
type: execute
wave: 2
depends_on: ["02-01"]
files_modified:
  - src/lib/enrichment/providers/prospeo.ts
  - src/lib/enrichment/providers/leadmagic.ts
  - src/lib/enrichment/providers/findymail.ts
autonomous: true
requirements: [PROV-01, PROV-03, PROV-04, ENRICH-04]
user_setup:
  - service: prospeo
    why: "Email finding from LinkedIn URL"
    env_vars:
      - name: PROSPEO_API_KEY
        source: "Prospeo dashboard -> API Keys (prospeo.io)"
  - service: leadmagic
    why: "Email finding from LinkedIn URL + future email verification"
    env_vars:
      - name: LEADMAGIC_API_KEY
        source: "LeadMagic dashboard -> API Settings (leadmagic.io)"
  - service: findymail
    why: "Fallback email finding"
    env_vars:
      - name: FINDYMAIL_API_KEY
        source: "FindyMail dashboard -> API (findymail.com)"

must_haves:
  truths:
    - "Prospeo adapter finds an email given a LinkedIn URL via POST /enrich-person"
    - "Prospeo adapter falls back to name+company lookup when no LinkedIn URL is provided"
    - "LeadMagic adapter finds an email given a LinkedIn URL via POST /v1/people/b2b-profile-to-email"
    - "FindyMail adapter finds an email given a LinkedIn URL via POST /api/search/linkedin"
    - "All three adapters timeout after 10 seconds using AbortController"
    - "All three adapters return typed EmailProviderResult with source, rawResponse, and costUsd"
  artifacts:
    - path: "src/lib/enrichment/providers/prospeo.ts"
      provides: "Prospeo email adapter"
      exports: ["prospeoAdapter"]
    - path: "src/lib/enrichment/providers/leadmagic.ts"
      provides: "LeadMagic email adapter"
      exports: ["leadmagicAdapter"]
    - path: "src/lib/enrichment/providers/findymail.ts"
      provides: "FindyMail email adapter"
      exports: ["findymailAdapter"]
  key_links:
    - from: "src/lib/enrichment/providers/prospeo.ts"
      to: "https://api.prospeo.io/enrich-person"
      via: "fetch POST with X-KEY header"
      pattern: "api\\.prospeo\\.io"
    - from: "src/lib/enrichment/providers/leadmagic.ts"
      to: "https://api.leadmagic.io/v1/people/b2b-profile-to-email"
      via: "fetch POST with X-API-Key header"
      pattern: "api\\.leadmagic\\.io"
    - from: "src/lib/enrichment/providers/findymail.ts"
      to: "https://app.findymail.com/api/search/linkedin"
      via: "fetch POST with Bearer auth"
      pattern: "findymail\\.com"
---

<objective>
Build the three email-finding provider adapters (Prospeo, LeadMagic, FindyMail) that form the email waterfall pipeline.

Purpose: These adapters are the "dumb" fetch wrappers that the waterfall orchestrator (Plan 04) will call in sequence. Each adapter handles its own auth, timeout, and response parsing, returning a uniform EmailProviderResult.
Output: Three provider adapter files in src/lib/enrichment/providers/, each exporting a typed EmailAdapter function.
</objective>

<execution_context>
@/Users/jjay/.claude/get-shit-done/workflows/execute-plan.md
@/Users/jjay/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-provider-adapters-waterfall/02-RESEARCH.md
@.planning/phases/02-provider-adapters-waterfall/02-01-SUMMARY.md

@src/lib/enrichment/types.ts

<interfaces>
<!-- Types from Plan 01 that adapters implement -->

From src/lib/enrichment/types.ts (after Plan 01 extends it):
```typescript
export type Provider = "prospeo" | "aiark" | "leadmagic" | "findymail" | "firecrawl" | "clay" | "ai-normalizer";

export interface EmailProviderResult {
  email: string | null;
  firstName?: string;
  lastName?: string;
  jobTitle?: string;
  linkedinUrl?: string;
  location?: string;
  source: Provider;
  rawResponse: unknown;
  costUsd: number;
}

export interface EmailAdapterInput {
  linkedinUrl?: string;
  firstName?: string;
  lastName?: string;
  companyName?: string;
  companyDomain?: string;
}

export type EmailAdapter = (input: EmailAdapterInput) => Promise<EmailProviderResult>;
```

From src/lib/enrichment/costs.ts (from Plan 01):
```typescript
export const PROVIDER_COSTS: Record<string, number> = {
  prospeo: 0.002,
  leadmagic: 0.005,
  findymail: 0.001,
  aiark: 0.003,
  firecrawl: 0.001,
};
```
</interfaces>

### Provider API Reference (from research)

**Prospeo (HIGH confidence):**
- Endpoint: `POST https://api.prospeo.io/enrich-person`
- Auth: `X-KEY: {api_key}` header
- Input (LinkedIn): `{ data: { linkedin_url: "..." } }`
- Input (name+co): `{ data: { first_name, last_name, company_name, company_website } }`
- Email field: `response.person.email.email` (string or null)
- Error: `response.error` boolean
- Deprecated: `/social-url-finder` removed March 2026 — do NOT use

**LeadMagic (HIGH confidence):**
- Endpoint: `POST https://api.leadmagic.io/v1/people/b2b-profile-to-email`
- Auth: `X-API-Key: {api_key}` header
- Input: `{ profile_url: "https://linkedin.com/in/..." }`
- Email field: `response.email` (string or null)
- Cost field: `response.credits_consumed` (5 if found, 0 if not)

**FindyMail (MEDIUM confidence — field names may differ):**
- Endpoint: `POST https://app.findymail.com/api/search/linkedin`
- Auth: `Authorization: Bearer {api_key}` header
- Input (expected): `{ linkedin_url: "..." }` — field name UNCONFIRMED
- Email field: Likely `response.email` — UNCONFIRMED
- IMPORTANT: Use Zod safeParse on response. Log rawResponse on every call. Handle schema drift gracefully.
</context>

<tasks>

<task type="auto">
  <name>Task 1: Prospeo email adapter with LinkedIn URL and name+company fallback</name>
  <files>src/lib/enrichment/providers/prospeo.ts</files>
  <action>
Create `src/lib/enrichment/providers/prospeo.ts` implementing `EmailAdapter`.

Structure:
1. `getApiKey()` — reads `PROSPEO_API_KEY` from env, throws if missing
2. Zod schema for response validation: `ProspeoResponseSchema = z.object({ error: z.boolean(), person: z.object({ email: z.object({ email: z.string().nullable().optional() }).optional() }).optional() })`
3. `prospeoAdapter: EmailAdapter` — the exported adapter function

Adapter logic:
- Use `AbortController` with 10-second timeout (`setTimeout(() => controller.abort(), 10_000)`)
- If `input.linkedinUrl` exists: POST to `https://api.prospeo.io/enrich-person` with `{ data: { linkedin_url: input.linkedinUrl } }`
- If no linkedinUrl but has firstName + lastName + (companyName or companyDomain): POST with `{ data: { first_name, last_name, company_name, company_website: companyDomain } }`
- If neither: return `{ email: null, source: "prospeo", rawResponse: { skipped: "insufficient input" }, costUsd: 0 }` (no API call)
- Headers: `Content-Type: application/json`, `X-KEY: {apiKey}`
- Pass `signal: controller.signal` to fetch
- Parse response JSON, validate with Zod `safeParse`
- If Zod fails: log warning, return `{ email: null, source: "prospeo", rawResponse: raw, costUsd: PROVIDER_COSTS.prospeo }`
- HTTP error handling:
  - 429: throw error with `(err as any).status = 429` (waterfall handles retry)
  - 404, 422: throw error with `(err as any).status = res.status` (waterfall logs and moves on)
  - Other non-ok: throw generic error
- On success: extract `email = parsed.data.person?.email?.email ?? null`
- Return `{ email, source: "prospeo", rawResponse: raw, costUsd: PROVIDER_COSTS.prospeo }`
- ALWAYS `clearTimeout(timeout)` in finally block

Import `PROVIDER_COSTS` from `../costs` and `EmailAdapter` from `../types`.
  </action>
  <verify>
    <automated>cd /Users/jjay/programs/outsignal-agents && npx tsc --noEmit --pretty 2>&1 | head -20</automated>
  </verify>
  <done>prospeoAdapter is exported, implements EmailAdapter, handles LinkedIn URL input, falls back to name+company, validates response with Zod, respects 10s timeout.</done>
</task>

<task type="auto">
  <name>Task 2: LeadMagic and FindyMail email adapters</name>
  <files>src/lib/enrichment/providers/leadmagic.ts, src/lib/enrichment/providers/findymail.ts</files>
  <action>
**A) Create `src/lib/enrichment/providers/leadmagic.ts`** implementing `EmailAdapter`:

Structure follows Prospeo pattern:
1. `getApiKey()` — reads `LEADMAGIC_API_KEY` from env
2. Zod schema: `LeadMagicResponseSchema = z.object({ email: z.string().nullable().optional(), credits_consumed: z.number().optional() })`
3. `leadmagicAdapter: EmailAdapter`

Adapter logic:
- If no `input.linkedinUrl`: return `{ email: null, source: "leadmagic", rawResponse: { skipped: "no linkedin url" }, costUsd: 0 }`
- POST to `https://api.leadmagic.io/v1/people/b2b-profile-to-email`
- Headers: `Content-Type: application/json`, `X-API-Key: {apiKey}`
- Body: `{ profile_url: input.linkedinUrl }`
- 10-second AbortController timeout
- Same HTTP error handling as Prospeo (429 → throw with status, 404/422 → throw with status)
- Validate with Zod safeParse
- Extract `email = parsed.data.email ?? null`
- Cost: use `PROVIDER_COSTS.leadmagic` (not the response credits_consumed — we track fixed costs per decision)
- Return `EmailProviderResult`

**B) Create `src/lib/enrichment/providers/findymail.ts`** implementing `EmailAdapter`:

IMPORTANT: FindyMail has MEDIUM confidence API shape. Write DEFENSIVELY.

1. `getApiKey()` — reads `FINDYMAIL_API_KEY` from env
2. Zod schema — LOOSE validation to handle unknown response shape:
   `FindyMailResponseSchema = z.object({ email: z.string().nullable().optional() }).passthrough()`
   This accepts the response even if it has extra/different fields.
3. `findymailAdapter: EmailAdapter`

Adapter logic:
- If no `input.linkedinUrl`: return `{ email: null, source: "findymail", rawResponse: { skipped: "no linkedin url" }, costUsd: 0 }`
- POST to `https://app.findymail.com/api/search/linkedin`
- Headers: `Content-Type: application/json`, `Authorization: Bearer {apiKey}`
- Body: `{ linkedin_url: input.linkedinUrl }` (best guess — field name may differ)
- 10-second AbortController timeout
- Same HTTP error handling pattern
- Zod safeParse, but on failure: also try extracting email from common alternative paths:
  ```typescript
  // Fallback email extraction for unknown schema
  const email = parsed.success
    ? parsed.data.email ?? null
    : (raw as any)?.email ?? (raw as any)?.data?.email ?? (raw as any)?.verified_email ?? null;
  ```
- Log rawResponse on EVERY call (not just errors) via console.log for initial debugging
- Return `EmailProviderResult` with `costUsd: PROVIDER_COSTS.findymail`

Both files import `PROVIDER_COSTS` from `../costs` and `EmailAdapter`, `EmailProviderResult` from `../types`.
  </action>
  <verify>
    <automated>cd /Users/jjay/programs/outsignal-agents && npx tsc --noEmit --pretty 2>&1 | head -20</automated>
  </verify>
  <done>leadmagicAdapter and findymailAdapter are exported, both implement EmailAdapter, both handle missing LinkedIn URL gracefully, both have 10s timeout, FindyMail uses defensive Zod parsing with fallback email extraction.</done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` — all three adapter files compile without errors
2. Each file exports a single adapter function implementing `EmailAdapter` type
3. Each adapter returns `EmailProviderResult` with `source`, `rawResponse`, `costUsd`
4. Each adapter uses `AbortController` for 10-second timeout
5. Each adapter throws errors with `.status` property for 429/404/422
6. Prospeo handles both LinkedIn URL and name+company input paths
7. LeadMagic and FindyMail return early with costUsd=0 when no LinkedIn URL provided
8. FindyMail uses .passthrough() Zod schema and fallback email extraction
</verification>

<success_criteria>
- All three email adapters compile, are exported, and implement the EmailAdapter contract
- Provider-specific HTTP details are correct (URLs, headers, body shapes)
- Error handling distinguishes rate-limit (429) from permanent errors (404, 422)
- FindyMail is written defensively for unconfirmed API shape
</success_criteria>

<output>
After completion, create `.planning/phases/02-provider-adapters-waterfall/02-02-SUMMARY.md`
</output>
