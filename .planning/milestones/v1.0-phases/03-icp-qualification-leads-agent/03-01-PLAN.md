---
phase: 03-icp-qualification-leads-agent
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - prisma/schema.prisma
  - src/lib/enrichment/types.ts
  - src/lib/enrichment/costs.ts
  - src/mcp/leads-agent/index.ts
  - .mcp.json
  - package.json
autonomous: true
requirements: [AI-04, AI-05, ENRICH-05]

must_haves:
  truths:
    - "Company model has crawlMarkdown (TEXT) and crawledAt (DateTime) columns for caching Firecrawl homepage scrapes"
    - "PersonWorkspace model has icpScore (Int), icpReasoning (String), icpScoredAt (DateTime), icpConfidence (String) columns for workspace-scoped ICP scores"
    - "Workspace model has icpCriteriaPrompt, normalizationPrompt, outreachTonePrompt (all String?) columns for AI prompt overrides"
    - "Provider type includes 'leadmagic-verify' as a distinct provider for email verification cost tracking"
    - "MCP server starts via npx tsx and connects over stdio without errors"
    - ".mcp.json registers the outsignal-leads server at project root"
  artifacts:
    - path: "prisma/schema.prisma"
      provides: "Phase 3 schema additions"
      contains: "crawlMarkdown"
    - path: "src/lib/enrichment/types.ts"
      provides: "Updated Provider union with leadmagic-verify"
      exports: ["Provider"]
    - path: "src/lib/enrichment/costs.ts"
      provides: "Cost entry for leadmagic-verify"
      contains: "leadmagic-verify"
    - path: "src/mcp/leads-agent/index.ts"
      provides: "MCP server entry point"
      min_lines: 20
    - path: ".mcp.json"
      provides: "MCP server registration for Claude Code"
      contains: "outsignal-leads"
  key_links:
    - from: ".mcp.json"
      to: "src/mcp/leads-agent/index.ts"
      via: "command + args in mcpServers config"
      pattern: "leads-agent/index.ts"
    - from: "src/mcp/leads-agent/index.ts"
      to: "@modelcontextprotocol/sdk"
      via: "McpServer + StdioServerTransport imports"
      pattern: "McpServer|StdioServerTransport"
---

<objective>
Lay the schema foundation, install dependencies, and create the MCP server skeleton for Phase 3.

Purpose: All three Phase 3 concerns (ICP scoring, email verification, Leads Agent) need schema changes and the MCP server wiring. This plan delivers the foundation so subsequent plans can build business logic without infrastructure work.

Output: Updated Prisma schema pushed to DB, `@modelcontextprotocol/sdk` + `tsx` installed, MCP server entry point running over stdio, `.mcp.json` registered.
</objective>

<execution_context>
@/Users/jjay/.claude/get-shit-done/workflows/execute-plan.md
@/Users/jjay/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-icp-qualification-leads-agent/03-CONTEXT.md
@.planning/phases/03-icp-qualification-leads-agent/03-RESEARCH.md

<interfaces>
<!-- Key types and contracts the executor needs. Extracted from codebase. -->

From src/lib/enrichment/types.ts:
```typescript
export type Provider =
  | "prospeo"
  | "aiark"
  | "leadmagic"
  | "findymail"
  | "firecrawl"
  | "clay"
  | "ai-normalizer";

export type EntityType = "person" | "company";
export type EnrichmentStatus = "success" | "error" | "skipped";
```

From src/lib/enrichment/costs.ts:
```typescript
export const PROVIDER_COSTS: Record<string, number> = {
  prospeo: 0.002,
  leadmagic: 0.005,
  findymail: 0.001,
  aiark: 0.003,
  firecrawl: 0.001,
};
```

From prisma/schema.prisma (relevant models — current state):
```prisma
model Company {
  id             String   @id @default(cuid())
  name           String
  domain         String   @unique
  industry       String?
  headcount      Int?
  // ... other existing fields ...
  enrichmentData String?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  @@index([industry])
  @@index([headcount])
}

model PersonWorkspace {
  id        String   @id @default(cuid())
  personId  String   @map("leadId")
  workspace String
  sourceId  String?
  status    String   @default("new")
  vertical  String?
  tags      String?
  createdAt DateTime @default(now())
  person    Person   @relation(fields: [personId], references: [id], onDelete: Cascade)
  @@unique([personId, workspace], map: "LeadWorkspace_leadId_workspace_key")
  @@index([workspace])
  @@index([status])
  @@map("LeadWorkspace")
}

model Workspace {
  id       String  @id @default(cuid())
  slug     String  @unique
  name     String
  vertical String?
  // ... many existing fields ...
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  senders Sender[]
}
```
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Schema migration + dependency install + type updates</name>
  <files>
    prisma/schema.prisma
    src/lib/enrichment/types.ts
    src/lib/enrichment/costs.ts
    package.json
  </files>
  <action>
**1. Install MCP SDK and tsx:**
```bash
npm install @modelcontextprotocol/sdk
npm install --save-dev tsx
```

**2. Update `prisma/schema.prisma`** — add the following columns to existing models:

To `Company` model (add before `createdAt`):
```prisma
  crawlMarkdown  String?   // Raw homepage markdown from Firecrawl scrape (ICP scoring cache)
  crawledAt      DateTime? // When the homepage was last crawled (null = not yet crawled)
```

To `PersonWorkspace` model (add before `createdAt`):
```prisma
  icpScore       Int?       // 0-100 ICP fit score (workspace-specific)
  icpReasoning   String?    // 1-3 sentence explanation of score
  icpConfidence  String?    // "high" | "medium" | "low" — data completeness indicator
  icpScoredAt    DateTime?  // When ICP was last scored
```

To `Workspace` model (add before `createdAt`):
```prisma
  // AI prompt overrides (managed via MCP tools)
  icpCriteriaPrompt    String?  // e.g. "Our ICP is SaaS companies, 50-200 employees in UK"
  normalizationPrompt  String?  // e.g. "Classify 'promo products' as 'Branded Merchandise'"
  outreachTonePrompt   String?  // e.g. "Professional but friendly"
```

**3. Push schema to database:**
```bash
npx prisma db push
```
Use `db push`, NOT `migrate dev` — this project has no migration history and `migrate dev` would reset production data (14,563+ records). This is consistent with all prior schema changes (see STATE.md decision [01-01]).

**4. Update `src/lib/enrichment/types.ts`** — add `"leadmagic-verify"` to the Provider union:
```typescript
export type Provider =
  | "prospeo"
  | "aiark"
  | "leadmagic"
  | "leadmagic-verify"
  | "findymail"
  | "firecrawl"
  | "clay"
  | "ai-normalizer";
```

**5. Update `src/lib/enrichment/costs.ts`** — add LeadMagic verification cost entry:
```typescript
export const PROVIDER_COSTS: Record<string, number> = {
  prospeo: 0.002,
  leadmagic: 0.005,
  "leadmagic-verify": 0.05,  // Email verification — $0.05 per valid/invalid/valid_catch_all result
  findymail: 0.001,
  aiark: 0.003,
  firecrawl: 0.001,
};
```
Note: LeadMagic verification costs $0.05 per check for valid/invalid/valid_catch_all statuses. catch_all and unknown are free. The adapter (Plan 03-02) handles the conditional cost logic; this is the base cost per charged call.
  </action>
  <verify>
    <automated>cd /Users/jjay/programs/outsignal-agents && npx prisma db push --accept-data-loss 2>&1 | tail -5 && npx tsc --noEmit src/lib/enrichment/types.ts src/lib/enrichment/costs.ts 2>&1 | head -20</automated>
  </verify>
  <done>
    - Prisma schema has crawlMarkdown/crawledAt on Company, icpScore/icpReasoning/icpConfidence/icpScoredAt on PersonWorkspace, three prompt fields on Workspace
    - DB pushed successfully with no errors
    - Provider type includes "leadmagic-verify"
    - PROVIDER_COSTS includes "leadmagic-verify" at 0.05
    - @modelcontextprotocol/sdk and tsx are installed
  </done>
</task>

<task type="auto">
  <name>Task 2: MCP server entry point + .mcp.json registration</name>
  <files>
    src/mcp/leads-agent/index.ts
    .mcp.json
  </files>
  <action>
**1. Create `src/mcp/leads-agent/index.ts`** — MCP server skeleton:

```typescript
/**
 * Outsignal Leads Agent — MCP server for Claude Code.
 * Provides tools for lead search, enrichment, ICP scoring, list building,
 * export, and workspace configuration.
 *
 * CRITICAL: Do NOT use console.log anywhere in this file or imported modules
 * that run in this process. console.log writes to stdout which is reserved
 * for JSON-RPC protocol messages. Use console.error for all logging.
 */
import { McpServer } from "@modelcontextprotocol/sdk/server/mcp.js";
import { StdioServerTransport } from "@modelcontextprotocol/sdk/server/stdio.js";

const server = new McpServer({
  name: "outsignal-leads",
  version: "1.0.0",
});

// --- Tool registrations will be added in Plan 03-03 ---
// Placeholder: register a ping tool to verify the server starts correctly
import { z } from "zod";

server.tool(
  "ping",
  "Health check — returns pong. Use to verify the MCP server is running.",
  {},
  async () => {
    return { content: [{ type: "text" as const, text: "pong" }] };
  }
);

// --- Connect transport ---
const transport = new StdioServerTransport();
await server.connect(transport);
console.error("[outsignal-leads] MCP server connected via stdio");
```

Use top-level await (the file runs as a standalone Node.js process via tsx, which supports ESM top-level await).

**2. Create `.mcp.json`** at project root:

```json
{
  "mcpServers": {
    "outsignal-leads": {
      "command": "npx",
      "args": ["tsx", "src/mcp/leads-agent/index.ts"],
      "env": {
        "DATABASE_URL": "${DATABASE_URL}"
      }
    }
  }
}
```

Note: Only `DATABASE_URL` is needed for most tools. The ICP scorer needs `FIRECRAWL_API_KEY` and `ANTHROPIC_API_KEY`, and the email verifier needs `LEADMAGIC_API_KEY` — these will be read from `.env` or the shell environment by the tsx process (which inherits the parent environment). Do NOT put secrets in `.mcp.json` since this file is checked into version control. The `env` block is for variable forwarding only — `${DATABASE_URL}` references the value already in the environment.

**3. Verify the MCP server starts:**
Run `npx tsx src/mcp/leads-agent/index.ts` and confirm it exits cleanly (it will start the stdio loop and wait for input — just verify no crash on startup by checking stderr output).
  </action>
  <verify>
    <automated>cd /Users/jjay/programs/outsignal-agents && timeout 5 npx tsx src/mcp/leads-agent/index.ts 2>&1 || true</automated>
  </verify>
  <done>
    - `src/mcp/leads-agent/index.ts` exists and creates McpServer with StdioServerTransport
    - `.mcp.json` exists at project root with outsignal-leads server config
    - MCP server starts without crash (may timeout waiting for stdio input — that's expected)
    - No `console.log` calls in the MCP server file (only `console.error`)
  </done>
</task>

</tasks>

<verification>
1. `npx prisma db push` completes without error
2. `npx tsc --noEmit` passes for modified files
3. `@modelcontextprotocol/sdk` appears in package.json dependencies
4. `tsx` appears in package.json devDependencies
5. MCP server starts without import errors or crashes
6. `.mcp.json` is valid JSON with outsignal-leads entry
</verification>

<success_criteria>
- Schema is pushed to production DB with all new columns
- Provider type and cost config updated for email verification
- MCP server skeleton is runnable and registered in `.mcp.json`
- No existing functionality is broken (no model renames, no field removals)
</success_criteria>

<output>
After completion, create `.planning/phases/03-icp-qualification-leads-agent/03-01-SUMMARY.md`
</output>
