---
phase: 07.1-leads-agent-integration-fixes
plan: "01"
subsystem: api
tags: [leads-agent, emailbison, orchestrator, scoring, operations]

# Dependency graph
requires:
  - phase: 07-leads-agent-dashboard
    provides: operations.ts shared operations layer and agents/orchestrator.ts delegation tools
provides:
  - exportListToEmailBison returns actionable "not connected to EmailBison" error when apiToken is null
  - delegateToLeads Zod schema exposes conversationContext for multi-turn refinement
  - scoreList confirm=false dry-run returns unscoredCount without calling Anthropic API
affects: [07.1-02, 08-mcp-migration, plan-02-mcp]

# Tech tracking
tech-stack:
  added: []
  patterns:
    - "Validate apiToken at call site before delegating to shared client factory"
    - "Pass optional context fields through delegation chains for multi-turn conversations"
    - "Default-true confirm parameter for credit-gated operations"

key-files:
  created: []
  modified:
    - src/lib/leads/operations.ts
    - src/lib/agents/orchestrator.ts

key-decisions:
  - "Fix at call site in exportListToEmailBison, not in getClientForWorkspace — avoids changing shared utility used across many tools"
  - "conversationContext wired through orchestrator without modifying leads.ts (gap was only in orchestrator schema)"
  - "confirm defaults to true so existing agent wrapper calls in leads.ts remain backward-compatible with no changes"

patterns-established:
  - "Pre-validate required workspace fields (apiToken, icpCriteriaPrompt) before expensive operations"
  - "Optional context passthrough in delegation chains supports multi-turn agent refinement"

requirements-completed: [LEAD-04, LEAD-05]

# Metrics
duration: 15min
completed: 2026-02-27
---

# Phase 7.1 Plan 01: Leads Agent Integration Fixes Summary

**Three surgical fixes: actionable EmailBison token error, conversationContext threading through orchestrator, and confirm dry-run gate for scoreList**

## Performance

- **Duration:** ~15 min
- **Started:** 2026-02-27T21:10:00Z
- **Completed:** 2026-02-27T21:25:00Z
- **Tasks:** 3
- **Files modified:** 2

## Accomplishments

- exportListToEmailBison now surfaces "Workspace '...' is not connected to EmailBison. Set the API token in workspace settings to enable export." instead of the misleading "Workspace not found" when apiToken is null
- delegateToLeads Zod inputSchema exposes conversationContext field, threaded through to runLeadsAgent — enables multi-turn refinement like "narrow to London only" without restarting from scratch
- scoreList(listId, slug, false) dry-run returns {scored:0, unscoredCount:N} without invoking scorePersonIcp — MCP batch_score_list in Plan 02 can use this for credit-safe preview

## Task Commits

Each task was committed atomically:

1. **Task 1: Add apiToken null check to exportListToEmailBison** - `0d28136` (fix)
2. **Task 2: Wire conversationContext through delegateToLeads** - `0cdbfdd` (feat)
3. **Task 3: Add confirm gate to scoreList** - `e53b274` (feat)

## Files Created/Modified

- `src/lib/leads/operations.ts` - apiToken null check in exportListToEmailBison, unscoredCount in ScoreListResult, confirm param and dry-run early return in scoreList
- `src/lib/agents/orchestrator.ts` - conversationContext field in delegateToLeads inputSchema and execute function signature

## Decisions Made

- Fixed at the call site in exportListToEmailBison rather than modifying `getClientForWorkspace` in workspaces.ts. This keeps the shared client factory simple and avoids changing behavior for the many other tools that call it (getCampaigns, getReplies, getSenderHealth, etc.) which already have their own error handling.
- `confirm` defaults to `true` so the existing leads.ts agent wrapper (`operations.scoreList(listId, workspaceSlug)` with no third argument) continues scoring immediately without any modification.

## Deviations from Plan

None - plan executed exactly as written.

## Issues Encountered

None - all three fixes were clean and TypeScript compiled with zero errors after each change.

## User Setup Required

None - no external service configuration required.

## Next Phase Readiness

- Plan 01 complete. All integration gaps from LEAD-04 and LEAD-05 closed.
- Plan 02 (MCP migration) can now safely add `confirm: false` to its `batch_score_list` dry-run path in operations.scoreList.
- No blockers.

---
*Phase: 07.1-leads-agent-integration-fixes*
*Completed: 2026-02-27*
