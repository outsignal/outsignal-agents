---
phase: 07.1-leads-agent-integration-fixes
plan: "02"
type: execute
wave: 2
depends_on: ["07.1-01"]
files_modified:
  - src/mcp/leads-agent/tools/search.ts
  - src/mcp/leads-agent/tools/lists.ts
  - src/mcp/leads-agent/tools/score.ts
  - src/mcp/leads-agent/tools/export.ts
autonomous: true
requirements: [LEAD-05]
gap_closure: true

must_haves:
  truths:
    - "MCP search_people calls operations.searchPeople instead of inline Prisma query"
    - "MCP create_list calls operations.createList instead of inline Prisma query"
    - "MCP add_to_list resolves emails to IDs then calls operations.addPeopleToList"
    - "MCP view_list calls operations.getList for data then formats with existing markdown renderer"
    - "MCP batch_score_list calls operations.scoreList with confirm parameter for both dry-run and execute paths"
    - "MCP export_to_emailbison preview path uses getListExportReadiness (already shared — no change needed)"
  artifacts:
    - path: "src/mcp/leads-agent/tools/search.ts"
      provides: "search_people backed by operations.searchPeople"
      contains: "operations.searchPeople"
    - path: "src/mcp/leads-agent/tools/lists.ts"
      provides: "create_list, add_to_list, view_list backed by operations"
      contains: "operations.createList"
    - path: "src/mcp/leads-agent/tools/score.ts"
      provides: "batch_score_list backed by operations.scoreList with confirm gate"
      contains: "operations.scoreList"
    - path: "src/mcp/leads-agent/tools/export.ts"
      provides: "export_to_emailbison with operations.exportListToEmailBison for execute path"
      contains: "operations.exportListToEmailBison"
  key_links:
    - from: "src/mcp/leads-agent/tools/search.ts"
      to: "src/lib/leads/operations.ts (searchPeople)"
      via: "import and call"
      pattern: "operations\\.searchPeople"
    - from: "src/mcp/leads-agent/tools/lists.ts"
      to: "src/lib/leads/operations.ts (createList, addPeopleToList, getList)"
      via: "import and call"
      pattern: "operations\\.(createList|addPeopleToList|getList)"
    - from: "src/mcp/leads-agent/tools/score.ts"
      to: "src/lib/leads/operations.ts (scoreList)"
      via: "import and call with confirm param"
      pattern: "operations\\.scoreList"
---

<objective>
Migrate 6 MCP tool handlers from inline Prisma queries to operations.ts function calls, eliminating divergent implementations between the agent path and MCP path (LEAD-05).

Purpose: Single source of truth for all lead pipeline DB logic — operations.ts is the canonical layer, MCP tools only handle input translation and markdown formatting.
Output: All 4 MCP tool files updated to call operations functions.
</objective>

<execution_context>
@/Users/jjay/.claude/get-shit-done/workflows/execute-plan.md
@/Users/jjay/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/STATE.md
@.planning/ROADMAP.md
@.planning/phases/07.1-leads-agent-integration-fixes/07.1-RESEARCH.md
@.planning/phases/07.1-leads-agent-integration-fixes/07.1-01-SUMMARY.md

@src/lib/leads/operations.ts
@src/mcp/leads-agent/tools/search.ts
@src/mcp/leads-agent/tools/lists.ts
@src/mcp/leads-agent/tools/score.ts
@src/mcp/leads-agent/tools/export.ts

<interfaces>
<!-- Key operations functions the MCP tools will call. From src/lib/leads/operations.ts. -->

```typescript
// Parameters
export interface SearchPeopleParams {
  query?: string;
  jobTitle?: string;
  vertical?: string;
  location?: string;
  workspaceSlug?: string;
  minIcpScore?: number;
  hasVerifiedEmail?: boolean;
  page?: number;    // NOTE: page-based, not offset-based
  limit?: number;
}

export interface CreateListParams {
  name: string;
  workspaceSlug: string;
  description?: string;
}

export interface GetListsParams {
  workspaceSlug?: string;
  query?: string;
}

// Results
export interface SearchPeopleResult {
  people: PersonSearchResult[];
  total: number;
  page: number;
}

export interface AddPeopleToListResult {
  added: number;
  alreadyInList: number;
}

export interface ListDetail {
  id: string;
  name: string;
  workspaceSlug: string;
  description: string | null;
  createdAt: Date;
  peopleCount: number;
  people: PersonSearchResult[];
}

export interface ScoreListResult {
  scored: number;
  skipped: number;
  failed: number;
  results: ScoreResult[];
  unscoredCount?: number;  // Present when confirm=false (from Plan 01 Task 3)
}

export interface ExportListResult {
  exported: number;
  alreadyExported: number;
  needsVerification: number;
  blocked: number;
  errors: string[];
}

// Functions
export async function searchPeople(params: SearchPeopleParams): Promise<SearchPeopleResult>
export async function createList(params: CreateListParams): Promise<TargetList>
export async function addPeopleToList(listId: string, personIds: string[]): Promise<AddPeopleToListResult>
export async function getList(listId: string): Promise<ListDetail | null>
export async function getLists(params: GetListsParams): Promise<GetListsResult>
export async function scoreList(listId: string, workspaceSlug: string, confirm?: boolean): Promise<ScoreListResult>
export async function exportListToEmailBison(listId: string, workspaceSlug: string): Promise<ExportListResult>
```

<!-- MCP tool response shape (MUST NOT change): -->
```typescript
// All MCP tool handlers must return this shape:
{ content: [{ type: "text" as const, text: string }] }
```

<!-- Pagination translation (critical): -->
```
MCP uses: offset + limit
operations uses: page + limit
Translation: page = Math.floor(offset / limit) + 1
```
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Migrate search.ts and lists.ts to operations layer</name>
  <files>src/mcp/leads-agent/tools/search.ts, src/mcp/leads-agent/tools/lists.ts</files>
  <action>
**search.ts — search_people handler:**

1. Replace `import { prisma } from "@/lib/db"` with `import * as operations from "@/lib/leads/operations"`. Keep `formatPeopleTable` function as-is (presentation logic, stays in MCP tool).

2. Replace the inline Prisma query in the handler with:
```typescript
async (params) => {
  const { query, workspace, vertical, status, limit, offset } = params;

  const result = await operations.searchPeople({
    query,
    workspaceSlug: workspace,
    vertical,
    limit,
    page: Math.floor(offset / limit) + 1,
  });

  // Status filter: operations.searchPeople does not support status filter.
  // Apply post-filter when status is provided.
  let people = result.people;
  let total = result.total;
  if (status) {
    people = people.filter(p => p.status === status);
    // Note: total count may be inaccurate when post-filtering.
    // This is acceptable — full status support in operations is deferred.
    total = people.length;
  }

  const table = formatPeopleTable(people);
  const rangeStart = total === 0 ? 0 : offset + 1;
  const rangeEnd = offset + people.length;
  const text = `${total} results (showing ${rangeStart}-${rangeEnd})\n\n${table}`;

  return { content: [{ type: "text" as const, text }] };
}
```

The `formatPeopleTable` function signature needs to accept `PersonSearchResult` type — the existing inline type matches (firstName, lastName, email, company, jobTitle, status, vertical are all present in PersonSearchResult). No type change needed because the function uses structural typing.

**lists.ts — create_list handler:**

1. Add `import * as operations from "@/lib/leads/operations"` at the top. Keep `import { prisma } from "@/lib/db"` — it's still needed for the workspace validation in create_list and email resolution in add_to_list.

2. Replace the `create_list` handler body. Keep the workspace validation check (returns friendly error, not throw). Replace the `prisma.targetList.create` call with:
```typescript
const list = await operations.createList({
  name,
  workspaceSlug: workspace,
  description,
});
```
Keep the existing response formatting code after the create call (the text template with list.id, list.name, etc.).

**lists.ts — add_to_list handler:**

3. Keep the list validation check (prisma.targetList.findUnique) as-is — it returns a friendly error message.
4. Keep the email-to-ID resolution step (the Promise.all that resolves emails to personIds) — this is input translation, not business logic. The MCP tool takes emails; operations.addPeopleToList takes IDs.
5. Replace the `prisma.targetListPerson.createMany` call with:
```typescript
const result = await operations.addPeopleToList(
  list_id,
  found.map(f => f.personId),
);
```
6. Update the response text to use `result.added` and `result.alreadyInList`:
```typescript
let text = `Added ${result.added} people to list '${list.name}'.`;
if (result.alreadyInList > 0) text += ` ${result.alreadyInList} already in list.`;
```
Keep the "not found" emails section unchanged.

**lists.ts — view_list handler:**

7. Replace the entire view_list handler body with:
```typescript
async (params) => {
  const { list_id, limit, offset } = params;

  const listDetail = await operations.getList(list_id);
  if (!listDetail) {
    return {
      content: [
        { type: "text" as const, text: `Error: TargetList '${list_id}' not found.` },
      ],
    };
  }

  if (listDetail.peopleCount === 0) {
    const text = `0 people in list '${listDetail.name}'. Use add_to_list to add people.`;
    return { content: [{ type: "text" as const, text }] };
  }

  // Use getListExportReadiness for enrichment/verification data (already imported)
  const readiness = await getListExportReadiness(list_id);

  // ... keep all existing formatting code from here (statusMap, allPeople pagination,
  // summaryLines, member table, paginationLines) exactly as-is ...
  // The only change is: replace the initial list.name/list.workspaceSlug references
  // with listDetail.name/listDetail.workspaceSlug
```

Note: view_list still needs `getListExportReadiness` for enrichment coverage and verification status data that `operations.getList` doesn't provide. This is acceptable — getListExportReadiness is already a shared function from `@/lib/export/verification-gate`. The key LEAD-05 win is that the list lookup itself goes through operations.

Remove the `prisma` import from lists.ts ONLY if no remaining inline prisma calls exist. If the workspace validation in create_list and email resolution in add_to_list still use prisma directly, keep the import.

IMPORTANT: Do NOT change MCP tool names, Zod schemas, or response shapes. Only the handler internals change.
  </action>
  <verify>
    <automated>cd /Users/jjay/programs/outsignal-agents && npx tsc --noEmit --pretty 2>&1 | head -30</automated>
  </verify>
  <done>search_people calls operations.searchPeople with offset→page translation; create_list calls operations.createList; add_to_list resolves emails then calls operations.addPeopleToList; view_list calls operations.getList for data. Zero inline Prisma queries for core data operations in search.ts. lists.ts retains prisma only for workspace validation and email resolution (input translation, not business logic).</done>
</task>

<task type="auto">
  <name>Task 2: Migrate score.ts and export.ts to operations layer</name>
  <files>src/mcp/leads-agent/tools/score.ts, src/mcp/leads-agent/tools/export.ts</files>
  <action>
**score.ts — batch_score_list handler:**

1. Add `import * as operations from "@/lib/leads/operations"` at the top. Keep `import { scorePersonIcp } from "@/lib/icp/scorer"` — it's still needed for `score_person` tool.

2. The `score_person` tool is a direct call to `scorePersonIcp` — this is already shared and correct. Leave it unchanged.

3. Replace the `batch_score_list` handler body. The current implementation is workspace-scoped (finds all unscored people in a workspace); operations.scoreList is list-scoped. These are genuinely different granularities. The migration approach:

Since `batch_score_list` works on workspace-level (not list-level), and operations.scoreList requires a listId, we cannot directly replace with operations.scoreList. Instead:

**Keep `batch_score_list` as a workspace-level scorer** but refactor to share the scoring logic pattern. The `score_person` tool already calls the shared `scorePersonIcp`. The batch tool's inline Prisma query to find unscored PersonWorkspace records is workspace-level discovery (no operations equivalent exists). This is acceptable for LEAD-05 — the scoring execution already uses the shared `scorePersonIcp` function.

However, to maximize LEAD-05 compliance, add a comment documenting the divergence:
```typescript
// NOTE: batch_score_list operates at workspace level (all unscored people in workspace).
// operations.scoreList operates at list level (unscored people in a specific TargetList).
// The scoring itself uses the shared scorePersonIcp function.
// A workspace-level operations function could be added in a future phase if needed.
```

Remove the `import { prisma } from "@/lib/db"` ONLY if `score_person` doesn't need it. Check: `score_person` calls `scorePersonIcp` directly — no prisma needed. `batch_score_list` still needs prisma for the `personWorkspace.findMany` query. Keep the prisma import.

**export.ts — export_to_emailbison handler:**

4. Add `import * as operations from "@/lib/leads/operations"` at the top.

5. The `export_to_emailbison` tool has three code paths:
   - `verify_unverified=true` → verification path (uses `verifyAndFilter` — already shared)
   - `confirm=true` → execute push (creates campaign + pushes leads)
   - Default → pre-export summary (uses `getListExportReadiness` — already shared)

For the `confirm=true` execute path (starting around line 132):

The MCP export tool does MORE than `operations.exportListToEmailBison`:
- It creates/duplicates campaigns
- It calls `ensureCustomVariables`
- It pushes leads with custom variables (linkedin_url)
- It formats a rich completion message

`operations.exportListToEmailBison` only handles the lead upload portion (no campaign creation). The campaign management logic is MCP-specific functionality that has no operations equivalent.

**Migration approach for confirm=true path:**
Replace ONLY the lead-push loop with `operations.exportListToEmailBison(list_id, workspace)`. But wait — operations.exportListToEmailBison includes its own readiness check and credit-gate. The MCP tool has already done the readiness check. And operations creates an EmailBisonClient via `getClientForWorkspace`, while the MCP tool creates its own client for campaign management.

**Actually, the cleanest approach**: Keep the confirm=true path as-is. The campaign creation + custom variables + linkedin_url custom variable handling is genuinely richer than what operations provides. The MCP export tool is a superset of operations.exportListToEmailBison.

For LEAD-05 compliance, document the intentional divergence:
```typescript
// NOTE: The MCP export confirm=true path manages campaigns (create/duplicate) and
// custom variables, which operations.exportListToEmailBison does not support.
// The lead upload loop is structurally identical but includes custom variables.
// Campaign management will be unified when Campaign operations are added in Phase 8.
```

6. For the default summary path (confirm=false, verify_unverified=false): this already uses `getListExportReadiness` which is shared. No change needed.

7. **Workspace apiToken check**: The MCP export.ts already has a proper apiToken check at line 163 (`if (!wsWithToken?.apiToken)`) that returns a user-friendly message. This is correct. Keep it.

Remove `import { prisma } from "@/lib/db"` from export.ts ONLY if no remaining direct prisma usage exists. Check: The tool uses prisma for TargetList lookup (line 63) and workspace lookup (line 79, 160). Keep the import.

IMPORTANT: Do NOT change MCP tool names, Zod schemas, or response shapes. Only handler internals change where operations equivalents exist.
  </action>
  <verify>
    <automated>cd /Users/jjay/programs/outsignal-agents && npx tsc --noEmit --pretty 2>&1 | head -30</automated>
  </verify>
  <done>score.ts score_person unchanged (already shared via scorePersonIcp); batch_score_list documented as workspace-level divergence (scoring uses shared scorePersonIcp). export.ts confirm=true path documented as campaign-management superset; default summary path uses shared getListExportReadiness. All MCP tools that have direct operations equivalents (search, create_list, add_to_list, view_list) now call operations functions. Remaining inline code is either input translation (email→ID resolution) or MCP-specific functionality (campaign management).</done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes with zero errors
2. `grep -rn "operations\." src/mcp/leads-agent/tools/search.ts` shows operations.searchPeople call
3. `grep -rn "operations\." src/mcp/leads-agent/tools/lists.ts` shows operations.createList, operations.addPeopleToList, operations.getList calls
4. `grep -rn "prisma\.\(person\|targetList\)" src/mcp/leads-agent/tools/search.ts` returns no results (zero inline Prisma for core data)
5. All MCP tool Zod schemas unchanged (tool names, parameters, types identical)
6. All MCP tool response shapes unchanged (`{ content: [{ type: "text", text }] }`)
</verification>

<success_criteria>
- TypeScript compiles cleanly
- search.ts: zero inline Prisma queries, calls operations.searchPeople with offset→page translation
- lists.ts: create_list, add_to_list, view_list all call operations equivalents
- score.ts: batch_score_list divergence documented (workspace vs list scope), scoring via shared scorePersonIcp
- export.ts: campaign management divergence documented, summary path uses shared getListExportReadiness
- No MCP tool names, schemas, or response shapes changed
</success_criteria>

<output>
After completion, create `.planning/phases/07.1-leads-agent-integration-fixes/07.1-02-SUMMARY.md`
</output>
