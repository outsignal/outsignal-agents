# Phase 7.1: Leads Agent Integration Fixes - Research

**Researched:** 2026-02-27
**Domain:** TypeScript / AI SDK tool wiring, Prisma, operations layer refactor
**Confidence:** HIGH — all findings from direct codebase inspection

---

## Summary

Phase 7.1 is a pure integration-quality pass with four discrete, surgical fixes inside a well-understood codebase. There are no new dependencies, no new models, and no new architecture — the work is entirely about closing four gaps identified by the v1.1 milestone audit. All four fixes are localized: one file per fix (except fix 1, which touches 4–6 MCP tool files). The fixes are independent of each other and can be sequenced or parallelized freely.

The riskiest fix is #1 (MCP tools → operations.ts migration) because it touches the most files and the MCP tools have a different call signature pattern (they return `{ content: [{ type: "text", text }] }` objects, not raw data). The operations layer returns typed data objects — MCP tools must continue to format data into markdown text responses after calling operations. The key insight is that operations functions already exist for all the operations MCP tools need; the MCP tools just bypass them with inline Prisma queries that differ in subtle ways (field selection, filter logic, ordering).

The other three fixes are each one-liner or two-liner changes in single files. Fix #2 (export error message) requires adding a `null` apiToken check before `getClientForWorkspace` in `operations.ts`. Fix #3 (conversationContext wiring) adds one Zod field to the `delegateToLeads` inputSchema in `orchestrator.ts` and threads it through the `execute` function. Fix #4 (scoreList confirm gate) adds a `confirm` parameter to `scoreList` in `operations.ts` and returns early with a count when `confirm: false`.

**Primary recommendation:** Implement fixes in order: #2 (smallest, highest user impact) → #3 (one-liner) → #4 (operations.ts change) → #1 (highest surface area, do last).

---

<phase_requirements>
## Phase Requirements

| ID | Description | Research Support |
|----|-------------|-----------------|
| LEAD-04 | Admin can export verified leads to EmailBison from dashboard chat | Fix #2 (actionable error) + Fix #3 (conversational refinement works end-to-end) together make the full export flow trustworthy |
| LEAD-05 | Leads Agent shares operations layer with MCP tools (no logic divergence) | Fix #1 (migrate MCP tools to call operations.ts) is the direct implementation |
</phase_requirements>

---

## Standard Stack

### Core

| Library | Version | Purpose | Why Standard |
|---------|---------|---------|--------------|
| Prisma | 6.x (project) | DB access | Already the project ORM — operations.ts uses it exclusively |
| Zod | 3.x (project) | Schema validation for agent tool inputSchemas | Already used by all tools in orchestrator.ts and leads.ts |
| AI SDK `tool()` | (project) | Agent tool wrapper for dashboard chat path | Already used in orchestrator.ts + leads.ts |
| MCP SDK `server.tool()` | (project) | MCP tool registration for Claude Desktop path | Already used in all src/mcp/leads-agent/tools/*.ts |

### No New Dependencies

This phase requires **zero new packages**. All changes are wiring and refactoring within existing modules.

---

## Architecture Patterns

### Recommended Project Structure

No structural changes — existing layout is correct:

```
src/
├── lib/
│   ├── agents/
│   │   ├── leads.ts          # Agent tool wrappers → operations (already correct)
│   │   └── orchestrator.ts   # delegateToLeads tool (FIX #3: add conversationContext)
│   └── leads/
│       └── operations.ts     # Single source of truth (FIX #2: apiToken check; FIX #4: confirm gate)
└── mcp/
    └── leads-agent/
        └── tools/
            ├── search.ts     # FIX #1: migrate search_people → operations.searchPeople
            ├── lists.ts      # FIX #1: migrate create_list, add_to_list, view_list → operations
            ├── score.ts      # FIX #1: migrate batch_score_list → operations.scoreList
            ├── export.ts     # FIX #1: export_to_emailbison confirm path → operations.exportListToEmailBison
            ├── workspace.ts  # LEAVE ALONE — no operations equivalents exist
            ├── status.ts     # LEAVE ALONE — no operations equivalent exists
            └── enrich.ts     # LEAVE ALONE — uses enrichment waterfall, not operations
```

### Pattern 1: Operations-first, format second (MCP tool pattern)

**What:** MCP tools call operations functions to get typed data, then format it into MCP's required `{ content: [{ type: "text", text }] }` response shape.
**When to use:** Every MCP tool that has an operations.ts equivalent.

```typescript
// BEFORE (inline Prisma — divergent)
async (params) => {
  const [people, total] = await prisma.$transaction([
    prisma.person.findMany({ where, take: limit, skip: offset, ... }),
    prisma.person.count({ where }),
  ]);
  const table = formatPeopleTable(people);
  return { content: [{ type: "text" as const, text: `${total} results\n\n${table}` }] };
}

// AFTER (operations-first — shared logic)
async (params) => {
  const result = await operations.searchPeople({
    query: params.query,
    workspaceSlug: params.workspace,
    vertical: params.vertical,
    limit: params.limit,
    page: Math.floor(params.offset / params.limit) + 1, // translate offset→page
  });
  const table = formatPeopleTable(result.people);
  return { content: [{ type: "text" as const, text: `${result.total} results\n\n${table}` }] };
}
```

**Important:** `operations.searchPeople` uses `page`/`limit` pagination; MCP tools use `offset`/`limit`. The translation is `page = Math.floor(offset / limit) + 1`. This is accurate for typical usage (offset always a multiple of limit).

### Pattern 2: apiToken null check before getClientForWorkspace

**What:** `getClientForWorkspace` in `src/lib/workspaces.ts` returns `undefined` (not throws) when `dbWs.apiToken` is null — line 80: `if (!dbWs || !dbWs.apiToken) return undefined;`. The caller `getClientForWorkspace` then throws `Workspace not found: ${slug}` when the returned value is `undefined` (line 104). This is the misleading error.

**Fix location:** `src/lib/leads/operations.ts`, `exportListToEmailBison()`, before line 595 (the `getClientForWorkspace` call).

```typescript
// FIX #2: Add before getClientForWorkspace call
const ws = await prisma.workspace.findUnique({
  where: { slug: workspaceSlug },
  select: { apiToken: true },
});
if (!ws) {
  throw new Error(`Workspace not found: '${workspaceSlug}'`);
}
if (!ws.apiToken) {
  throw new Error(
    `Workspace '${workspaceSlug}' is not connected to EmailBison. ` +
    `Configure the API token in workspace settings before exporting.`
  );
}
// Then proceed with getClientForWorkspace (will succeed because apiToken exists)
const client = await getClientForWorkspace(workspaceSlug);
```

### Pattern 3: Zod field addition to delegateToLeads inputSchema

**What:** `LeadsInput.conversationContext` is declared in `src/lib/agents/types.ts` (line 69), used in `buildLeadsMessage()` in `leads.ts` (line 219), but the `delegateToLeads` tool in `orchestrator.ts` only exposes `workspaceSlug` and `task` in its inputSchema. Adding `conversationContext` to the Zod schema and threading it to `runLeadsAgent` is a two-line fix.

**Fix location:** `src/lib/agents/orchestrator.ts`, `delegateToLeads` tool definition.

```typescript
// Add to inputSchema (after task field, line ~69):
conversationContext: z
  .string()
  .optional()
  .describe("Prior conversation context: previous search results, list state, or refinement history. Pass this when the user is narrowing/refining a previous result."),

// Update execute function signature and call:
execute: async ({ workspaceSlug, task, conversationContext }) => {
  try {
    const result = await runLeadsAgent({ workspaceSlug, task, conversationContext });
    // ...
```

### Pattern 4: confirm gate in scoreList (operations.ts)

**What:** The MCP `batch_score_list` tool has a `confirm` parameter that returns a count without scoring when `confirm: false`. The agent-path `scoreList` in `operations.ts` has no such gate — it runs immediately. The fix adds a `confirm` parameter to `scoreList` with a default of `true` to preserve backward compatibility with the agent tool wrapper in `leads.ts`.

**Fix location:** `src/lib/leads/operations.ts`, `scoreList()` function signature and body.

```typescript
// Update signature:
export async function scoreList(
  listId: string,
  workspaceSlug: string,
  confirm: boolean = true, // default true for backward compat
): Promise<ScoreListResult> {
  // ... existing workspace + icpCriteriaPrompt check ...

  // Fetch all list members (needed for count even without scoring)
  const members = await prisma.targetListPerson.findMany({
    where: { listId },
    include: {
      person: {
        select: {
          id: true,
          workspaces: {
            where: { workspace: workspaceSlug },
            select: { icpScoredAt: true },
          },
        },
      },
    },
  });

  // Separate scored vs unscored
  const unscored: string[] = [];
  let skipped = 0;
  for (const member of members) {
    const pw = member.person.workspaces[0];
    if (pw?.icpScoredAt !== null && pw?.icpScoredAt !== undefined) {
      skipped++;
    } else {
      unscored.push(member.person.id);
    }
  }

  // Credit-gate: return count when confirm=false
  if (!confirm) {
    return {
      scored: 0,
      skipped,
      failed: 0,
      results: [],
      unscoredCount: unscored.length, // planner may want to add this to ScoreListResult
    };
  }

  // ... existing scoring loop ...
}
```

**Note:** `ScoreListResult` may need a new optional field `unscoredCount?: number` to surface the preview count. The agent's `scoreList` tool wrapper in `leads.ts` currently calls `operations.scoreList(listId, workspaceSlug)` without a `confirm` arg — with `default: true` this is backward-compatible and unchanged.

### Anti-Patterns to Avoid

- **Don't delete inline Prisma from MCP tools without replacing with operations calls** — empty handlers break the MCP server
- **Don't change MCP tool response shape** — must always be `{ content: [{ type: "text", text }] }`, never raw objects
- **Don't remove `formatPeopleTable` from search.ts** — it's used locally for rendering; operations returns structured data, not formatted text
- **Don't change `leadsTools` in leads.ts** — the agent tool wrappers are already correct (they call operations); only the MCP tools need migration
- **Don't change the default value of `confirm` in scoreList to `false`** — the leads.ts agent wrapper calls it without args and must continue scoring immediately
- **Don't modify `getClientForWorkspace` in workspaces.ts** — fixing the error message at the call site in operations.ts is cleaner and doesn't affect other callers

---

## Don't Hand-Roll

| Problem | Don't Build | Use Instead | Why |
|---------|-------------|-------------|-----|
| Pagination translation | Custom offset→page math | `page = Math.floor(offset / limit) + 1` one-liner | Simple algebra, no library needed |
| Export readiness check | Duplicate the logic in MCP export | Call `getListExportReadiness` (already used by MCP export.ts) | Already shared — operations.exportListToEmailBison calls it too |
| Workspace token validation | New validator function | Inline null check before getClientForWorkspace | 3 lines, not worth extracting |

---

## Common Pitfalls

### Pitfall 1: MCP search_people uses offset, operations uses page
**What goes wrong:** Direct replacement of Prisma query with `operations.searchPeople` breaks pagination because the parameter names differ.
**Why it happens:** operations.ts was designed for the agent path (page-based); MCP tools use offset-based pagination for Claude Desktop compatibility.
**How to avoid:** Translate `offset` → `page` at the call site: `page = Math.floor(offset / limit) + 1`. Keep `offset` in the MCP tool's inputSchema unchanged.
**Warning signs:** MCP search returning wrong page of results when offset > 0.

### Pitfall 2: MCP lists.ts add_to_list resolves by email, operations uses personIds
**What goes wrong:** `operations.addPeopleToList(listId, personIds)` takes person IDs, but the MCP `add_to_list` tool takes email addresses and resolves them to IDs internally.
**Why it happens:** The MCP tool was designed for human-facing use (emails are memorable); operations uses IDs for agent use (agent already has IDs from search results).
**How to avoid:** Keep the email-resolution step in the MCP tool (it's presentation logic, not business logic). Call `operations.addPeopleToList` only after resolving emails to IDs — the resolution itself stays inline in the MCP tool.
**Warning signs:** Trying to pass emails directly to `addPeopleToList` causes type errors.

### Pitfall 3: MCP view_list has richer output than operations.getList
**What goes wrong:** `operations.getList` returns `ListDetail` with people data; MCP `view_list` formats it into a markdown table with enrichment/verification columns and pagination. Calling operations doesn't eliminate the formatting work.
**Why it happens:** The operations function returns structured data; MCP tools return formatted text.
**How to avoid:** Call `operations.getList` to get the data, then reuse the existing formatting code in view_list to format the output. The formatting code stays, only the DB query moves.
**Warning signs:** view_list returns raw JSON objects instead of formatted markdown.

### Pitfall 4: MCP export.ts confirm=true path goes further than operations.exportListToEmailBison
**What goes wrong:** The MCP `export_to_emailbison` tool creates campaigns, handles `template_campaign_id`, calls `ensureCustomVariables`, and formats a rich completion message. `operations.exportListToEmailBison` only uploads leads (no campaign creation).
**Why it happens:** The MCP export tool does more than the agent export tool — it manages campaigns too. The operations function was scoped to lead upload only.
**How to avoid:** For the MCP export tool's campaign-creation logic, keep it inline (no operations equivalent). Only migrate the lead-upload loop. Alternatively, add a new operations function `uploadLeadsToWorkspace` that wraps just the lead upload — but this is over-engineering for this phase. Cleanest approach: keep the MCP export confirm path as-is; the LEAD-05 violation for export is the _summary_ path (confirm=false), not the execution path.

**Actually — re-read the audit carefully:** The audit says "6 operations have divergent implementations." The divergent ops are: search_people, create_list, add_to_list, view_list (getList), batch_score_list, and possibly the export preview. The export execute path is genuinely richer in MCP (campaign creation). A pragmatic interpretation of LEAD-05: call operations for the operations it covers, keep campaign-specific logic inline. This is acceptable and matches the MCP export tool's design intent.

### Pitfall 5: scoreList default confirm=true vs MCP default confirm=false
**What goes wrong:** If `confirm` defaults to `false` in operations.scoreList, existing calls from leads.ts break (they'd return 0 scored results instead of scoring).
**Why it happens:** MCP convention is dry-run by default (safe); operations convention is execute by default (agent already confirmed via prompt).
**How to avoid:** Default `confirm = true` in operations.scoreList so existing leads.ts wrapper continues working unchanged. MCP `batch_score_list` already has `confirm: false` as its Zod default — no change needed there after migration.
**Warning signs:** Agent scoring returns `{ scored: 0, ... }` after the change.

---

## Code Examples

### Fix #1: search_people → operations.searchPeople

```typescript
// src/mcp/leads-agent/tools/search.ts — updated handler
import * as operations from "@/lib/leads/operations";

// Inside registerSearchTools:
async (params) => {
  const { query, workspace, vertical, status, limit, offset } = params;

  // NOTE: operations.searchPeople does not support status filter yet.
  // Keep status filter inline OR add it to SearchPeopleParams.
  const result = await operations.searchPeople({
    query,
    workspaceSlug: workspace,
    vertical,
    // status not in SearchPeopleParams — handle separately or extend operations
    limit,
    page: Math.floor(offset / limit) + 1,
  });

  const table = formatPeopleTable(result.people);
  const rangeStart = result.total === 0 ? 0 : offset + 1;
  const rangeEnd = offset + result.people.length;
  const text = `${result.total} results (showing ${rangeStart}-${rangeEnd})\n\n${table}`;
  return { content: [{ type: "text" as const, text }] };
}
```

**Status filter gap:** `SearchPeopleParams` in operations.ts has no `status` field. The MCP search_people tool supports `status`. Decision for planner: either (a) add `status` to `SearchPeopleParams` and `searchPeople()` — clean but adds scope, or (b) keep status filter inline in MCP search after calling operations — acceptable, small divergence. Option (a) is recommended for full LEAD-05 compliance.

### Fix #2: apiToken null check in exportListToEmailBison

```typescript
// src/lib/leads/operations.ts — inside exportListToEmailBison, before getClientForWorkspace call

// After readiness checks, before client instantiation:
const wsRecord = await prisma.workspace.findUnique({
  where: { slug: workspaceSlug },
  select: { apiToken: true },
});
if (!wsRecord) {
  throw new Error(`Workspace not found: '${workspaceSlug}'`);
}
if (!wsRecord.apiToken) {
  throw new Error(
    `Workspace '${workspaceSlug}' is not connected to EmailBison. ` +
    `Set the API token in workspace settings to enable export.`
  );
}
const client = await getClientForWorkspace(workspaceSlug);
```

### Fix #3: conversationContext in delegateToLeads

```typescript
// src/lib/agents/orchestrator.ts — delegateToLeads tool

inputSchema: z.object({
  workspaceSlug: z.string().optional().describe("..."),
  task: z.string().describe("..."),
  conversationContext: z            // ADD THIS
    .string()
    .optional()
    .describe(
      "Previous search results, list state, or conversation context. Pass when the user is refining a prior result (e.g. 'narrow to London only'). The Leads Agent uses this to avoid restarting from scratch."
    ),
}),
execute: async ({ workspaceSlug, task, conversationContext }) => {  // ADD conversationContext
  try {
    const result = await runLeadsAgent({ workspaceSlug, task, conversationContext }); // PASS IT
```

### Fix #4: confirm gate in scoreList

```typescript
// src/lib/leads/operations.ts — scoreList signature

export async function scoreList(
  listId: string,
  workspaceSlug: string,
  confirm: boolean = true,   // ADD: default true for backward compat
): Promise<ScoreListResult> {
  // ... existing workspace check ...
  // ... existing members fetch ...
  // ... existing scored/unscored split ...

  // ADD: credit-gate dry-run
  if (!confirm) {
    return {
      scored: 0,
      skipped,
      failed: 0,
      results: [],
      // unscoredCount surfaces the count for the caller
    };
  }

  // ... existing scoring loop (unchanged) ...
}
```

**Type note:** `ScoreListResult` interface may need `unscoredCount?: number` added to communicate the preview count. The agent prompt already handles this conversationally; the field is useful for the MCP caller to surface it programmatically.

---

## State of the Art

| Old Approach | Current Approach | When Changed | Impact |
|--------------|------------------|--------------|--------|
| MCP tools: inline Prisma (Phase 6) | MCP tools: call operations.ts (Phase 7.1) | This phase | Eliminates 6 divergent implementations |
| Export error: "Workspace not found" | Export error: "not connected to EmailBison, configure API token" | This phase | Actionable error for admin |
| delegateToLeads: only task+workspaceSlug | delegateToLeads: task+workspaceSlug+conversationContext | This phase | Multi-turn refinement works |
| scoreList: always executes | scoreList: dry-run when confirm=false | This phase | Code-level credit gate matches MCP pattern |

---

## Open Questions

1. **Status filter in MCP search_people**
   - What we know: `SearchPeopleParams` has no `status` field; MCP `search_people` accepts `status`
   - What's unclear: Is status filter important enough to add to operations, or acceptable to keep inline?
   - Recommendation: Add `status?: string` to `SearchPeopleParams` and the `searchPeople()` query for full LEAD-05 compliance. It's a 5-line change.

2. **ScoreListResult.unscoredCount — new field needed?**
   - What we know: When `confirm=false`, the return value should communicate how many would be scored; `ScoreListResult` has no `unscoredCount` field
   - What's unclear: Does the agent or MCP caller need a structured count, or is the `scored: 0` + prompt handling sufficient?
   - Recommendation: Add `unscoredCount?: number` to `ScoreListResult` interface. The MCP `batch_score_list` can use it to format the dry-run message; the agent system prompt handles it conversationally.

3. **MCP export_to_emailbison: how much to migrate?**
   - What we know: The confirm=true path creates campaigns (no operations equivalent); the confirm=false preview path duplicates readiness check logic
   - What's unclear: Should a new `getExportPreview` operations function be created, or is sharing `getListExportReadiness` (already done) sufficient?
   - Recommendation: For LEAD-05 compliance, the preview path (confirm=false) in MCP export should call `operations.exportListToEmailBison` with a dry-run mode OR just use `getListExportReadiness` directly (already done). The execute path keeps campaign-creation logic inline — this is acceptable because operations is scoped to lead-upload, not campaign management.

---

## Validation Architecture

> `workflow.nyquist_validation` is not set in `.planning/config.json` (only `research`, `plan_check`, `verifier` are set) — skip this section.

---

## Gap-by-Audit-Item Mapping

Direct mapping from `v1.1-MILESTONE-AUDIT.md` integration gaps to fixes:

| Audit Gap | Phase 7.1 Fix | File(s) | Lines |
|-----------|--------------|---------|-------|
| MCP tools bypass operations.ts — 6 divergent implementations | Fix #1 | src/mcp/leads-agent/tools/search.ts, lists.ts, score.ts, export.ts | ~50-80 lines changed |
| getClientForWorkspace misleading 'Workspace not found' on null apiToken | Fix #2 | src/lib/leads/operations.ts | ~8 lines added |
| delegateToLeads schema lacks conversationContext | Fix #3 | src/lib/agents/orchestrator.ts | ~5 lines added |
| Score credit-gate is prompt-only (no code-level confirm gate) | Fix #4 | src/lib/leads/operations.ts | ~10 lines added |

**Scope is tight.** All four fixes together touch 5 files. The largest single change (Fix #1) spans 4 MCP tool files but is mostly mechanical: swap inline Prisma for operations calls, keep formatting.

---

## Sources

### Primary (HIGH confidence)
- Direct codebase inspection — `src/lib/leads/operations.ts` (full read)
- Direct codebase inspection — `src/lib/agents/orchestrator.ts` (full read)
- Direct codebase inspection — `src/lib/agents/leads.ts` (full read)
- Direct codebase inspection — `src/lib/agents/types.ts` (full read)
- Direct codebase inspection — `src/lib/workspaces.ts` (full read)
- Direct codebase inspection — `src/mcp/leads-agent/tools/search.ts` (full read)
- Direct codebase inspection — `src/mcp/leads-agent/tools/lists.ts` (full read)
- Direct codebase inspection — `src/mcp/leads-agent/tools/score.ts` (full read)
- Direct codebase inspection — `src/mcp/leads-agent/tools/export.ts` (full read)
- Direct codebase inspection — `src/mcp/leads-agent/tools/workspace.ts` (full read)
- Direct codebase inspection — `src/mcp/leads-agent/tools/status.ts` (full read)
- Direct codebase inspection — `src/mcp/leads-agent/tools/enrich.ts` (full read)
- `.planning/v1.1-MILESTONE-AUDIT.md` — audit findings (full read)
- `.planning/STATE.md` — project decisions (full read)
- `.planning/REQUIREMENTS.md` — LEAD-04, LEAD-05 definitions (full read)

---

## Metadata

**Confidence breakdown:**
- Fix scope and file targets: HIGH — confirmed by direct code inspection
- Pitfall identification: HIGH — derived from actual API differences between operations and MCP tools
- Code examples: HIGH — based on actual function signatures and types in codebase
- Status filter gap: HIGH — confirmed SearchPeopleParams has no `status` field
- ScoreListResult extension: MEDIUM — confirmed interface lacks `unscoredCount`, recommendation is design judgment

**Research date:** 2026-02-27
**Valid until:** N/A — pure internal codebase research, stable until code changes
