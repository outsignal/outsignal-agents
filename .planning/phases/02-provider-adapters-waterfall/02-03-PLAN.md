---
phase: 02-provider-adapters-waterfall
plan: 03
type: execute
wave: 2
depends_on: ["02-01"]
files_modified:
  - src/lib/enrichment/providers/aiark.ts
  - src/lib/enrichment/providers/firecrawl-company.ts
autonomous: true
requirements: [PROV-02, PROV-05, ENRICH-03]
user_setup:
  - service: aiark
    why: "Company data enrichment (headcount, industry, description)"
    env_vars:
      - name: AIARK_API_KEY
        source: "AI Ark dashboard -> Developer Portal -> API Keys (ai-ark.com)"

must_haves:
  truths:
    - "AI Ark adapter fetches company data (headcount, industry, description) given a domain"
    - "Firecrawl company adapter extracts structured company data using extract() with Zod schema"
    - "Both adapters return typed CompanyProviderResult with source, rawResponse, and costUsd"
    - "Both adapters timeout after 10 seconds"
    - "AI Ark adapter tries multiple auth header patterns to handle unknown header name"
  artifacts:
    - path: "src/lib/enrichment/providers/aiark.ts"
      provides: "AI Ark company data adapter"
      exports: ["aiarkAdapter"]
    - path: "src/lib/enrichment/providers/firecrawl-company.ts"
      provides: "Firecrawl structured company data extraction adapter"
      exports: ["firecrawlCompanyAdapter"]
  key_links:
    - from: "src/lib/enrichment/providers/aiark.ts"
      to: "https://api.ai-ark.com/api/developer-portal/v1/companies"
      via: "fetch POST with auth header (name TBD)"
      pattern: "api\\.ai-ark\\.com"
    - from: "src/lib/enrichment/providers/firecrawl-company.ts"
      to: "Firecrawl extract() SDK method"
      via: "@mendable/firecrawl-js client.extract()"
      pattern: "client\\.extract"
---

<objective>
Build the two company-data provider adapters (AI Ark, Firecrawl) that form the company enrichment waterfall.

Purpose: These adapters provide structured company data (headcount, industry, description, etc.) that the waterfall orchestrator will call when enriching company records. AI Ark is the primary source; Firecrawl is the fallback.
Output: Two provider adapter files in src/lib/enrichment/providers/, each exporting a typed CompanyAdapter function.
</objective>

<execution_context>
@/Users/jjay/.claude/get-shit-done/workflows/execute-plan.md
@/Users/jjay/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-provider-adapters-waterfall/02-RESEARCH.md
@.planning/phases/02-provider-adapters-waterfall/02-01-SUMMARY.md

@src/lib/enrichment/types.ts
@src/lib/firecrawl/client.ts

<interfaces>
<!-- Types from Plan 01 that adapters implement -->

From src/lib/enrichment/types.ts (after Plan 01):
```typescript
export type Provider = "prospeo" | "aiark" | "leadmagic" | "findymail" | "firecrawl" | "clay" | "ai-normalizer";

export interface CompanyProviderResult {
  name?: string;
  industry?: string;
  headcount?: number;
  description?: string;
  website?: string;
  location?: string;
  yearFounded?: number;
  source: Provider;
  rawResponse: unknown;
  costUsd: number;
}

export type CompanyAdapter = (domain: string) => Promise<CompanyProviderResult>;
```

From src/lib/enrichment/costs.ts (from Plan 01):
```typescript
export const PROVIDER_COSTS: Record<string, number> = {
  prospeo: 0.002, leadmagic: 0.005, findymail: 0.001, aiark: 0.003, firecrawl: 0.001,
};
```

From src/lib/firecrawl/client.ts (existing):
```typescript
import Firecrawl from "@mendable/firecrawl-js";
// Uses: new Firecrawl({ apiKey }), client.crawl(), client.scrape()
// Does NOT have extract() — need to use SDK directly
```
</interfaces>

### Provider API Reference (from research)

**AI Ark (MEDIUM/LOW confidence — auth header unknown):**
- Company endpoint: `POST https://api.ai-ark.com/api/developer-portal/v1/companies`
- Auth: unknown literal header name — docs say "Header" security scheme. Try `X-TOKEN`, then `Authorization: Bearer`, then `X-API-Key`.
- Company lookup by domain: send `{ account: { domain: { include: [domain] } } }` (from doc structure)
- Response fields: `name`, `description`, `industry`, `staff.total` (headcount), `links.website`, `headquarter`, `founded_year`
- Rate limits: 5 req/sec, 300/min

**Firecrawl (HIGH confidence):**
- SDK: `@mendable/firecrawl-js` v4.13.2 (installed)
- Method: `client.extract(urls, { prompt, schema })`
- Zod schema: pass directly to extract()
- Input: `["https://${domain}"]`
- Output: `result.data` matching Zod schema
- Env: `FIRECRAWL_API_KEY` (already in use)
</context>

<tasks>

<task type="auto">
  <name>Task 1: AI Ark company data adapter with defensive auth handling</name>
  <files>src/lib/enrichment/providers/aiark.ts</files>
  <action>
Create `src/lib/enrichment/providers/aiark.ts` implementing `CompanyAdapter`.

CRITICAL NOTE: AI Ark auth header literal name is LOW confidence. The adapter MUST be written defensively.

Structure:
1. `getApiKey()` — reads `AIARK_API_KEY` from env, throws if missing
2. Auth header config — try the most likely header name first:
   ```typescript
   // AI Ark docs say "Header" security scheme but don't specify the literal name.
   // Default to "X-TOKEN" (common pattern). If 401/403, user should check actual docs
   // and update AUTH_HEADER_NAME.
   const AUTH_HEADER_NAME = "X-TOKEN";
   ```
3. Zod schema for response validation — LOOSE, use `.passthrough()`:
   ```typescript
   const AiArkCompanySchema = z.object({
     name: z.string().optional(),
     description: z.string().optional(),
     industry: z.string().optional(),
     staff: z.object({ total: z.number().optional() }).optional(),
     links: z.object({ website: z.string().optional() }).optional(),
     headquarter: z.string().optional(),
     founded_year: z.number().optional(),
   }).passthrough();
   ```
4. `aiarkAdapter: CompanyAdapter`

Adapter logic:
- POST to `https://api.ai-ark.com/api/developer-portal/v1/companies`
- Headers: `Content-Type: application/json`, `[AUTH_HEADER_NAME]: {apiKey}`
- Body: `{ account: { domain: { include: [domain] } } }`
- 10-second AbortController timeout
- Parse response JSON
- Handle array response: AI Ark may return an array of companies — take the first match
  ```typescript
  const companies = Array.isArray(raw) ? raw : raw?.data ? (Array.isArray(raw.data) ? raw.data : [raw.data]) : [raw];
  const company = companies[0];
  ```
- Validate first company with Zod safeParse
- If validation fails or no company found: return `{ source: "aiark", rawResponse: raw, costUsd: PROVIDER_COSTS.aiark }` with all optional fields undefined
- Map fields:
  - `name` → `name`
  - `industry` → `industry`
  - `staff?.total` → `headcount`
  - `description` → `description`
  - `links?.website` → `website`
  - `headquarter` → `location`
  - `founded_year` → `yearFounded`
- HTTP errors: same pattern as email adapters (429 → throw with status, 404/422 → throw with status)
- Add a console.warn on 401/403: "AI Ark auth failed — verify AUTH_HEADER_NAME in aiark.ts matches API docs"
- Return `CompanyProviderResult`

Import `PROVIDER_COSTS` from `../costs` and `CompanyAdapter` from `../types`.
  </action>
  <verify>
    <automated>cd /Users/jjay/programs/outsignal-agents && npx tsc --noEmit --pretty 2>&1 | head -20</automated>
  </verify>
  <done>aiarkAdapter exported, implements CompanyAdapter, handles unknown response shapes defensively, warns on auth failure, maps AI Ark fields to CompanyProviderResult.</done>
</task>

<task type="auto">
  <name>Task 2: Firecrawl company extract adapter using SDK extract() with Zod schema</name>
  <files>src/lib/enrichment/providers/firecrawl-company.ts</files>
  <action>
Create `src/lib/enrichment/providers/firecrawl-company.ts` implementing `CompanyAdapter`.

This adapter uses Firecrawl's `extract()` method (NOT scrape/crawl) for structured company data extraction. It creates its own Firecrawl client instance (same pattern as existing `src/lib/firecrawl/client.ts`).

Structure:
1. Zod schema for extraction:
   ```typescript
   const CompanyExtractSchema = z.object({
     headcount: z.number().optional(),
     industry: z.string().optional(),
     description: z.string().optional(),
     yearFounded: z.number().optional(),
     location: z.string().optional(),
     name: z.string().optional(),
   });
   ```
2. `getClient()` — creates Firecrawl instance from `FIRECRAWL_API_KEY` env var
3. `firecrawlCompanyAdapter: CompanyAdapter`

Adapter logic:
- Create Firecrawl client via `getClient()`
- Call `client.extract([`https://${domain}`], { prompt, schema })`:
  - prompt: "Extract the company name, number of employees (as a number), industry, a one-paragraph description, year the company was founded, and headquarters location from this website."
  - schema: `CompanyExtractSchema`
- The extract() call does NOT need AbortController (SDK manages its own timeouts). However, wrap in a Promise.race with a 30-second timeout as a safety net (Firecrawl extract can be slow):
  ```typescript
  const result = await Promise.race([
    client.extract([`https://${domain}`], { prompt, schema: CompanyExtractSchema }),
    new Promise<never>((_, reject) => setTimeout(() => reject(new Error("Firecrawl extract timeout")), 30_000)),
  ]);
  ```
- Extract data from `result.data` (the SDK returns typed data matching the schema)
- Map fields:
  - `data.name` → `name`
  - `data.industry` → `industry`
  - `data.headcount` → `headcount`
  - `data.description` → `description`
  - `data.yearFounded` → `yearFounded`
  - `data.location` → `location`
- Wrap entire adapter in try/catch:
  - On error: throw with appropriate status (let waterfall handle)
  - Log the error for debugging
- Return `CompanyProviderResult` with `source: "firecrawl"`, `rawResponse: result`, `costUsd: PROVIDER_COSTS.firecrawl`

Import `PROVIDER_COSTS` from `../costs` and `CompanyAdapter` from `../types`.
Import `Firecrawl` from `@mendable/firecrawl-js` and `z` from `zod`.

Do NOT modify the existing `src/lib/firecrawl/client.ts` — this is a separate adapter for enrichment, not a change to the existing Firecrawl integration.
  </action>
  <verify>
    <automated>cd /Users/jjay/programs/outsignal-agents && npx tsc --noEmit --pretty 2>&1 | head -20</automated>
  </verify>
  <done>firecrawlCompanyAdapter exported, implements CompanyAdapter, uses Firecrawl extract() with Zod schema, has 30s safety timeout, maps extracted fields to CompanyProviderResult.</done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` — both adapter files compile without errors
2. Each file exports a single adapter function implementing `CompanyAdapter` type
3. AI Ark adapter handles unknown auth header with defensive coding and auth failure warning
4. AI Ark adapter handles both array and object response shapes
5. Firecrawl adapter uses `extract()` method (not `scrape()` or `crawl()`)
6. Firecrawl adapter has 30-second safety timeout
7. Both adapters return `CompanyProviderResult` with `source`, `rawResponse`, `costUsd`
</verification>

<success_criteria>
- Both company adapters compile, are exported, and implement CompanyAdapter contract
- AI Ark adapter written defensively for uncertain auth header and response shape
- Firecrawl adapter uses structured extract() with Zod schema (more reliable than scrape + parse)
- Neither adapter modifies existing codebase files
</success_criteria>

<output>
After completion, create `.planning/phases/02-provider-adapters-waterfall/02-03-SUMMARY.md`
</output>
