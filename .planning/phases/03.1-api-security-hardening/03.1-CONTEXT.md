# Phase 3.1: API Security + Hardening - Context

**Gathered:** 2026-02-26
**Status:** Ready for planning

<domain>
## Phase Boundary

Protect enrichment API routes from unauthorized access, fix MCP env var forwarding, close test infrastructure gaps (dailyCostTotal mock, TypeScript errors in test files). This is a gap closure phase — no new features, just hardening what exists.

</domain>

<decisions>
## Implementation Decisions

### Auth error responses
- Return generic 401 with `{"error": "Unauthorized"}` — no details about auth mechanism
- Log failed auth attempts to console only (timestamp + route) — visible in Vercel logs
- No Slack alerts or active notification on failed attempts
- Bare 401 response — no rate-limiting headers (rate limiting is a separate concern)
- Auth check applies to POST requests only — GET requests stay open

### Auth boundary pattern
- Shared helper function `validateCronSecret(req)` that each route calls at the top — explicit, per-route
- No Next.js middleware — keep auth visible in route handlers
- Read CRON_SECRET from `Authorization: Bearer <CRON_SECRET>` header — standard pattern for Vercel cron
- Use `crypto.timingSafeEqual()` for secret comparison — prevent timing attacks
- Protect only the two specified routes: `/api/enrichment/run` and `/api/enrichment/jobs/process` — don't audit other routes

### TypeScript error fixes
- Fix types properly — correct type annotations, fix mismatched types, update interfaces
- Update source types if needed — if a shared type/interface is wrong, fix at the source
- Fix under current tsconfig settings — don't tighten strictness as part of this phase
- Scope to test files only — don't fix unrelated TS errors elsewhere in the codebase

### Test mock strategy
- Minimal change — just add `dailyCostTotal` to existing mock objects
- Use simple test values (e.g., 5.00, 10.00) for readable assertions
- Test both under-cap and over-cap scenarios for waterfall cost cap
- Include boundary test where `dailyCostTotal` equals the cap exactly — catch off-by-one issues
- No broader mock cleanup — keep the diff small

### Claude's Discretion
- Exact placement and signature of `validateCronSecret` helper function
- Which test files have TypeScript errors and how to fix each
- Mock object structure details beyond adding `dailyCostTotal`

</decisions>

<specifics>
## Specific Ideas

No specific requirements — open to standard approaches

</specifics>

<deferred>
## Deferred Ideas

None — discussion stayed within phase scope

</deferred>

---

*Phase: 03.1-api-security-hardening*
*Context gathered: 2026-02-26*
