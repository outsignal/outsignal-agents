---
phase: 04-search-filter-list-building
plan: 04
type: execute
wave: 2
depends_on: ["04-01"]
files_modified:
  - src/app/api/lists/route.ts
  - src/app/api/lists/[id]/route.ts
  - src/app/api/lists/[id]/people/route.ts
  - src/app/(admin)/lists/page.tsx
  - src/app/(admin)/lists/[id]/page.tsx
  - src/components/search/list-index-page.tsx
  - src/components/search/list-detail-page.tsx
autonomous: true
requirements:
  - LIST-01
  - LIST-03
  - LIST-04

must_haves:
  truths:
    - "User can create a named list scoped to a workspace"
    - "User can view all lists with people count, workspace, and enrichment completeness bar"
    - "User can search lists by name in the list index"
    - "User can view a list's contents with enrichment summary bars (% email, % LinkedIn, % company)"
    - "Each row in list detail shows green/yellow/red enrichment status"
    - "User can delete a list (people remain in database)"
    - "User can remove individual people from a list in the detail view"
  artifacts:
    - path: "src/app/api/lists/route.ts"
      provides: "GET (list all) + POST (create) for TargetList"
      exports: ["GET", "POST"]
    - path: "src/app/api/lists/[id]/route.ts"
      provides: "GET (detail) + DELETE for a single TargetList"
      exports: ["GET", "DELETE"]
    - path: "src/app/api/lists/[id]/people/route.ts"
      provides: "POST (add people) + DELETE (remove person) for list membership"
      exports: ["POST", "DELETE"]
    - path: "src/app/(admin)/lists/page.tsx"
      provides: "List index page wrapper"
      min_lines: 5
    - path: "src/app/(admin)/lists/[id]/page.tsx"
      provides: "List detail page wrapper"
      min_lines: 5
    - path: "src/components/search/list-index-page.tsx"
      provides: "Client component: list index with search, enrichment bars, delete"
      min_lines: 80
    - path: "src/components/search/list-detail-page.tsx"
      provides: "Client component: list detail with enrichment summary, people table, remove"
      min_lines: 100
  key_links:
    - from: "src/components/search/list-index-page.tsx"
      to: "/api/lists"
      via: "fetch GET for list index, POST for create"
      pattern: "fetch.*api/lists"
    - from: "src/components/search/list-detail-page.tsx"
      to: "/api/lists/[id]"
      via: "fetch GET for detail + DELETE for list, POST/DELETE for people"
      pattern: "fetch.*api/lists/"
    - from: "src/app/api/lists/route.ts"
      to: "prisma.targetList"
      via: "Prisma queries for list CRUD"
      pattern: "prisma\\.targetList"
---

<objective>
Build list management — API routes for CRUD operations on named, workspace-scoped target lists, plus the list index page and list detail page with enrichment completeness summaries.

Purpose: Lists are the output of the search/filter workflow. Users assemble qualified prospects into named lists for export (Phase 5). Each list shows enrichment completeness so users can see what's missing before export.

Output: Three API route files (lists CRUD, list detail, list people management), list index page, list detail page.
</objective>

<execution_context>
@/Users/jjay/.claude/get-shit-done/workflows/execute-plan.md
@/Users/jjay/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-search-filter-list-building/04-RESEARCH.md
@.planning/phases/04-search-filter-list-building/04-01-SUMMARY.md

<interfaces>
<!-- Key types and contracts from Plan 01 -->

From prisma/schema.prisma (created in Plan 01):
```prisma
model TargetList {
  id            String   @id @default(cuid())
  name          String
  workspaceSlug String
  description   String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  people TargetListPerson[]
  @@index([workspaceSlug])
}

model TargetListPerson {
  id       String   @id @default(cuid())
  listId   String
  personId String
  addedAt  DateTime @default(now())
  list   TargetList @relation(...)
  person Person     @relation(...)
  @@unique([listId, personId])
  @@index([listId])
  @@index([personId])
}
```

From src/lib/enrichment/status.ts (created in Plan 01):
```typescript
export function getEnrichmentStatus(person: {...}): EnrichmentStatus;
export const ENRICHMENT_COLORS: Record<EnrichmentStatus, string>;
export const ENRICHMENT_LABELS: Record<EnrichmentStatus, string>;
```

From src/components/search/enrichment-badge.tsx (created in Plan 02):
```typescript
export function EnrichmentBadge({ person }: EnrichmentBadgeProps): JSX.Element;
```
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: List management API routes</name>
  <files>src/app/api/lists/route.ts, src/app/api/lists/[id]/route.ts, src/app/api/lists/[id]/people/route.ts</files>
  <action>
**1. Create `src/app/api/lists/route.ts`:**

**GET /api/lists** — List all target lists with summary stats.

Query params:
- `q` (string, optional) — search list names (contains, case-insensitive)
- `workspace` (string, optional) — filter by workspaceSlug

Response:
```typescript
{
  lists: Array<{
    id: string;
    name: string;
    workspaceSlug: string;
    description: string | null;
    createdAt: string;
    peopleCount: number;
    enrichment: {
      withEmail: number;
      withLinkedin: number;
      withCompany: number;
    };
  }>;
}
```

Implementation:
- Query TargetList with optional name filter and workspace filter
- For each list, include `_count: { people: true }` for the people count
- For enrichment summary, include `people: { select: { person: { select: { email: true, linkedinUrl: true, companyDomain: true } } } }`
- Compute enrichment counts in-memory from the people data
- OrderBy: { updatedAt: 'desc' }

Performance note: This fetches all list members' enrichment fields which could be expensive for large lists. At Phase 4 scope (manually assembled lists, likely <500 people each), this is fine. If performance becomes an issue, switch to raw SQL aggregate in a future pass.

**POST /api/lists** — Create a new target list.

Request body:
```typescript
{ name: string; workspaceSlug: string; description?: string }
```

Validation: name is required (non-empty string), workspaceSlug is required. Return 400 on missing fields.

Response: `{ list: { id, name, workspaceSlug, description, createdAt } }` with 201 status.

**2. Create `src/app/api/lists/[id]/route.ts`:**

**GET /api/lists/[id]** — Get list detail with paginated people and enrichment summary.

Query params:
- `page` (number, default 1) — paginate people in the list

Response:
```typescript
{
  list: { id, name, workspaceSlug, description, createdAt, updatedAt };
  people: Array<{
    id: string; // TargetListPerson.id (for removal)
    personId: string;
    addedAt: string;
    person: {
      id: string;
      email: string;
      firstName: string | null;
      lastName: string | null;
      company: string | null;
      jobTitle: string | null;
      vertical: string | null;
      linkedinUrl: string | null;
      companyDomain: string | null;
    };
  }>;
  total: number;
  page: number;
  pageSize: number;
  summary: {
    total: number;
    withEmail: number;
    withLinkedin: number;
    withCompany: number;
  };
}
```

Implementation:
- Fetch the TargetList by id (return 404 if not found)
- Paginated people: findMany on TargetListPerson where listId, include person select, orderBy addedAt desc, skip/take
- Summary: separate query for ALL members (not just current page) — count non-null email/linkedinUrl/companyDomain. Use `prisma.targetListPerson.findMany({ where: { listId }, select: { person: { select: { email: true, linkedinUrl: true, companyDomain: true } } } })` and aggregate in-memory.
- Combine in Promise.all: [list, paginatedPeople, totalCount, allMembersForSummary]

**DELETE /api/lists/[id]** — Delete a target list.

Deletes the TargetList record. TargetListPerson records cascade-delete (onDelete: Cascade). People records remain in database.

Return: `{ ok: true }` with 200 status, or 404 if list not found.

**3. Create `src/app/api/lists/[id]/people/route.ts`:**

**POST /api/lists/[id]/people** — Add people to a list.

Request body option A (individual selection):
```typescript
{ personIds: string[] }
```

Request body option B (select all matching — server-side filter):
```typescript
{ selectAllFilters: { q?: string; vertical?: string[]; workspace?: string; enrichment?: string; company?: string } }
```

Implementation:
- If `personIds` provided: use `createMany` with `skipDuplicates: true` to add people
- If `selectAllFilters` provided: run the same WHERE clause logic as GET /api/people/search (extract shared filter-building logic or inline it), get all matching person IDs, then createMany
- Return: `{ added: number }` (count of newly added, excluding duplicates)

**DELETE /api/lists/[id]/people** — Remove a person from a list.

Request body:
```typescript
{ personId: string }
```

Implementation: Delete the TargetListPerson record matching the compound unique [listId, personId]. Return 404 if not found.

Return: `{ ok: true }` with 200 status.
  </action>
  <verify>
    <automated>cd /Users/jjay/programs/outsignal-agents && npx tsc --noEmit src/app/api/lists/route.ts src/app/api/lists/\[id\]/route.ts src/app/api/lists/\[id\]/people/route.ts 2>&1 | head -30</automated>
  </verify>
  <done>Three API routes provide full list CRUD: GET/POST /api/lists, GET/DELETE /api/lists/[id], POST/DELETE /api/lists/[id]/people. Lists include enrichment summary stats. People can be added individually or via "select all matching" server-side filter.</done>
</task>

<task type="auto">
  <name>Task 2: List index page and list detail page</name>
  <files>src/app/(admin)/lists/page.tsx, src/app/(admin)/lists/[id]/page.tsx, src/components/search/list-index-page.tsx, src/components/search/list-detail-page.tsx</files>
  <action>
**1. Create `src/components/search/list-index-page.tsx`:**

"use client" component for the list index.

**Features:**
- Search bar at top to filter lists by name (client-side filter on the fetched data — lists are few enough to filter in-memory)
- Each list card/row shows:
  - List name (bold)
  - Workspace slug (badge)
  - People count
  - Mini enrichment completeness bar: three thin horizontal bars showing % with email, % with LinkedIn, % with company data. Use inline styles with the ENRICHMENT_COLORS or a simple progress bar pattern.
  - Created date
- Delete button on each list row with confirmation dialog (shadcn Dialog): "Delete list '{name}'? People will remain in the database." [Cancel] [Delete]

**Layout options:** Cards grid or table rows — use table rows for consistency with people/companies pages. Columns: Name, Workspace, People, Enrichment, Created, Actions (delete).

**Data fetching:**
- Fetch from `/api/lists` on mount (and on create/delete to refresh)
- Loading: skeleton rows
- Empty state: "No lists yet. Add people from search results to create your first list."

**Create list flow** is NOT in this page — it's triggered from the search page's "Add to List" action (Plan 05). However, the user can see the list index and navigate to detail views.

**Navigation:** Clicking a list name navigates to `/lists/{id}` (list detail page).

**2. Create `src/components/search/list-detail-page.tsx`:**

"use client" component for a single list's detail view.

**Props:** Receives `listId` from the page wrapper.

**Enrichment summary bars at top:**
Three horizontal progress bars showing:
- "Email: X%" (withEmail / total * 100)
- "LinkedIn: X%" (withLinkedin / total * 100)
- "Company: X%" (withCompany / total * 100)

Use brand yellow (#F0FF7A) for the filled portion, gray-800 for the background. Show percentage text to the right of each bar.

**People table:**
Same columns as people search (Name, Email, Company, Title, Vertical, Enrichment Status via EnrichmentBadge from Plan 02). Plus a "Remove" action column — clicking Remove deletes the TargetListPerson entry (DELETE /api/lists/[id]/people with { personId }).

**Pagination:** Same pattern as search pages (50 per page, Previous/Next).

**Header:**
- Back link to /lists
- List name as h1
- Workspace badge
- Total people count
- Delete list button (with confirmation dialog)

**Data fetching:**
- Fetch from `/api/lists/{id}?page={page}` on mount and page change
- Use `useParams` from next/navigation to get id, or receive as prop from page wrapper
- 404 handling: if API returns 404, show "List not found" message

**3. Create page wrappers:**

`src/app/(admin)/lists/page.tsx`:
```typescript
import { ListIndexPage } from "@/components/search/list-index-page";
export const dynamic = "force-dynamic";
export default function ListsPage() {
  return <ListIndexPage />;
}
```

`src/app/(admin)/lists/[id]/page.tsx`:
```typescript
import { ListDetailPage } from "@/components/search/list-detail-page";
export const dynamic = "force-dynamic";

interface ListDetailPageProps {
  params: Promise<{ id: string }>;
}

export default async function ListDetailRoute({ params }: ListDetailPageProps) {
  const { id } = await params;
  return <ListDetailPage listId={id} />;
}
```

Note: In Next.js 15+, `params` is a Promise that must be awaited in server components. The page wrapper awaits it and passes the id as a prop to the client component.

**Styling:** Same dark theme as other Phase 4 pages.
  </action>
  <verify>
    <automated>cd /Users/jjay/programs/outsignal-agents && npx tsc --noEmit src/app/\(admin\)/lists/page.tsx src/app/\(admin\)/lists/\[id\]/page.tsx src/components/search/list-index-page.tsx src/components/search/list-detail-page.tsx 2>&1 | head -30</automated>
  </verify>
  <done>List index page at /lists shows all lists with people count and enrichment bars. List detail page at /lists/[id] shows enrichment summary + paginated people table with remove action. Delete list works with confirmation.</done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` — no TypeScript errors in all new files
2. GET /api/lists returns list of all target lists with people count and enrichment stats
3. POST /api/lists creates a new list and returns it
4. GET /api/lists/[id] returns list detail with paginated people and enrichment summary
5. DELETE /api/lists/[id] deletes list, people remain
6. POST /api/lists/[id]/people adds people to list (skips duplicates)
7. DELETE /api/lists/[id]/people removes a person from list
8. /lists page renders with list cards, search, and delete
9. /lists/[id] page renders with enrichment bars, people table, remove action, pagination
</verification>

<success_criteria>
- User can create named lists scoped to a workspace via the API
- List index page shows list name, people count, workspace, and enrichment completeness bars
- List index has search for finding lists by name
- Delete list removes list container only — people remain in database
- List detail shows enrichment summary (% email, % LinkedIn, % company) as progress bars
- Each person in list detail shows green/yellow/red enrichment indicator
- User can remove individual people from lists in the detail view
- Pagination works for lists with many people
</success_criteria>

<output>
After completion, create `.planning/phases/04-search-filter-list-building/04-04-SUMMARY.md`
</output>
