---
phase: 04-search-filter-list-building
plan: 03
type: execute
wave: 2
depends_on: ["04-01"]
files_modified:
  - src/app/api/companies/search/route.ts
  - src/app/(admin)/companies/page.tsx
  - src/components/search/companies-search-page.tsx
autonomous: true
requirements:
  - SEARCH-03
  - SEARCH-04
  - SEARCH-05

must_haves:
  truths:
    - "User can search companies by name, domain, or vertical"
    - "Each company row shows enrichment status (enriched/partial/missing)"
    - "User can filter companies by vertical and enrichment status"
    - "User can paginate through 17k+ companies with 50 per page"
  artifacts:
    - path: "src/app/api/companies/search/route.ts"
      provides: "GET /api/companies/search with multi-field text search, filters, pagination"
      exports: ["GET"]
    - path: "src/app/(admin)/companies/page.tsx"
      provides: "Thin server page wrapper for companies search"
      min_lines: 5
    - path: "src/components/search/companies-search-page.tsx"
      provides: "Client component: full companies search with debounce, filters, results table, pagination"
      min_lines: 80
  key_links:
    - from: "src/components/search/companies-search-page.tsx"
      to: "/api/companies/search"
      via: "fetch in useEffect triggered by nuqs URL state changes"
      pattern: "fetch.*api/companies/search"
    - from: "src/components/search/companies-search-page.tsx"
      to: "src/lib/enrichment/status.ts"
      via: "imports getCompanyEnrichmentStatus"
      pattern: "getCompanyEnrichmentStatus"
---

<objective>
Build the companies search experience — API route with multi-field search and filters, plus a client-driven search page with instant search, enrichment indicators, and pagination.

Purpose: Users need to search and browse the 17k+ company database by name, domain, or vertical, with enrichment visibility on each record. This is the companion to the people search page.

Output: GET /api/companies/search route, companies search page at /companies, reusing enrichment badge from Plan 02.
</objective>

<execution_context>
@/Users/jjay/.claude/get-shit-done/workflows/execute-plan.md
@/Users/jjay/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-search-filter-list-building/04-RESEARCH.md
@.planning/phases/04-search-filter-list-building/04-01-SUMMARY.md

<interfaces>
<!-- Key types and contracts from Plan 01 -->

From src/lib/enrichment/status.ts (created in Plan 01):
```typescript
export type EnrichmentStatus = "full" | "partial" | "missing";
export function getCompanyEnrichmentStatus(company: {
  industry: string | null;
  headcount: number | null;
  description: string | null;
}): EnrichmentStatus;
export const ENRICHMENT_COLORS: Record<EnrichmentStatus, string>;
export const ENRICHMENT_LABELS: Record<EnrichmentStatus, string>;
```

From prisma/schema.prisma (Company model fields for search):
```prisma
model Company {
  id, name (String), domain (String @unique), industry?, headcount?, location?,
  website?, linkedinUrl?, description?, revenue?, yearFounded?, companyType?,
  techStack?, enrichmentData?, crawlMarkdown?, crawledAt?
  @@index([industry]), @@index([headcount])
}
```

From src/components/search/enrichment-badge.tsx (created in Plan 02 — person-specific):
Note: The EnrichmentBadge component in Plan 02 is person-specific. For companies, create a CompanyEnrichmentBadge inline in companies-search-page.tsx (or make enrichment-badge.tsx accept both) that calls getCompanyEnrichmentStatus instead.

nuqs is installed (Plan 01) and NuqsAdapter wraps admin layout.
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Companies search API route</name>
  <files>src/app/api/companies/search/route.ts</files>
  <action>
Create `src/app/api/companies/search/route.ts` — a GET endpoint that accepts URL query params and returns paginated, filtered companies.

**URL params:**
- `q` (string) — free-text search across name, domain, industry (OR across fields, case-insensitive via `contains` + `mode: 'insensitive'`)
- `vertical` (multi-value via getAll) — filter by industry/vertical (OR within)
- `enrichment` (string: "full" | "partial" | "missing") — filter by derived enrichment status
- `page` (number, default 1) — pagination offset
- Page size: 50 (constant)

**WHERE clause construction:**
Same `andConditions` array approach as people search. Build conditions, push to array, set `where.AND = andConditions` if non-empty.

For text search `q`: push `{ OR: [{ name: { contains: q, mode: 'insensitive' } }, { domain: { contains: q, mode: 'insensitive' } }, { industry: { contains: q, mode: 'insensitive' } }] }`

For vertical/industry filter: push `{ industry: { in: verticals } }`

For enrichment status:
- "full": push `{ industry: { not: null }, headcount: { not: null }, description: { not: null } }`
- "partial": companies with at least one but not all three. Push: `{ NOT: { AND: [{ industry: { not: null } }, { headcount: { not: null } }, { description: { not: null } }] }, OR: [{ industry: { not: null } }, { headcount: { not: null } }, { description: { not: null } }] }`
  Simpler: one of the three is not null AND one of the three is null. Since there are 3 fields and you need "some but not all", use `AND: [{ OR: [{ industry: { not: null } }, { headcount: { not: null } }, { description: { not: null } }] }, { OR: [{ industry: null }, { headcount: null }, { description: null }] }]`
- "missing": push `{ industry: null, headcount: null, description: null }`

**Response shape:**
```typescript
{
  companies: Array<{
    id: string;
    name: string;
    domain: string;
    industry: string | null;
    headcount: number | null;
    location: string | null;
    description: string | null;
    website: string | null;
    yearFounded: number | null;
  }>;
  total: number;
  page: number;
  pageSize: number;
  filterOptions: {
    industries: string[];  // distinct non-null industry values
  };
}
```

**Implementation:**
- Select: id, name, domain, industry, headcount, location, description, website, yearFounded
- OrderBy: { createdAt: 'desc' }
- Promise.all with findMany + count + groupBy for distinct industries
- try/catch, 500 on error
  </action>
  <verify>
    <automated>cd /Users/jjay/programs/outsignal-agents && npx tsc --noEmit src/app/api/companies/search/route.ts 2>&1 | head -20</automated>
  </verify>
  <done>GET /api/companies/search returns paginated companies with text search across name/domain/industry, compound filters (vertical, enrichment), and distinct industry options for the filter sidebar.</done>
</task>

<task type="auto">
  <name>Task 2: Companies search page with filters and enrichment indicators</name>
  <files>src/app/(admin)/companies/page.tsx, src/components/search/companies-search-page.tsx</files>
  <action>
**1. Create `src/components/search/companies-search-page.tsx`:**

"use client" component. Same architectural pattern as people-search-page.tsx (Plan 02) but simpler — fewer filters, different columns.

**URL state (nuqs):**
```typescript
const [params, setParams] = useQueryStates({
  q: parseAsString.withDefault(''),
  vertical: parseAsArrayOf(parseAsString).withDefault([]),
  enrichment: parseAsString.withDefault(''),
  page: parseAsInteger.withDefault(1),
})
```

**Layout:**
Simpler than people — no workspace filter or company sub-filter needed. Use a narrower filter section (can be inline above table instead of full sidebar, or keep sidebar for consistency — use your judgment, just keep it consistent with the people page).

Recommendation: Keep the left sidebar pattern but with fewer filter sections (Vertical + Enrichment only). This maintains visual consistency across both search pages.

**Columns (Claude's discretion per CONTEXT.md):**
Recommended: Name, Domain, Industry, Headcount, Location, Year Founded, Enrichment Status

**Enrichment badge for companies:**
Create a small inline component (or extend the enrichment-badge.tsx from Plan 02 to accept a `type` prop). For companies, call `getCompanyEnrichmentStatus` from `@/lib/enrichment/status`. Render the same colored dot + label pattern.

**Data fetching, search input, filter chips, pagination, loading/empty/error states:**
Same patterns as people-search-page.tsx. Fetch from `/api/companies/search`, debounce 300ms, skeleton loading, pagination with Previous/Next.

**Styling:**
Same dark theme as people search page (bg-gray-950, bg-gray-900, border-gray-800).

**2. Create `src/app/(admin)/companies/page.tsx`:**

Thin wrapper:
```typescript
import { CompaniesSearchPage } from "@/components/search/companies-search-page";

export const dynamic = "force-dynamic";

export default function CompaniesPage() {
  return <CompaniesSearchPage />;
}
```

This is a NEW page (no existing /companies page to replace).
  </action>
  <verify>
    <automated>cd /Users/jjay/programs/outsignal-agents && npx tsc --noEmit src/app/\(admin\)/companies/page.tsx src/components/search/companies-search-page.tsx 2>&1 | head -20</automated>
  </verify>
  <done>Companies search page loads at /companies, shows instant debounced search across name/domain/industry, sidebar filters for vertical + enrichment, dense table with enrichment indicators, and pagination across 17k+ companies.</done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` — no TypeScript errors in new files
2. GET /api/companies/search returns JSON with companies array, total, filterOptions
3. GET /api/companies/search?q=google returns companies matching "google" in name/domain/industry
4. GET /api/companies/search?enrichment=full returns only companies with all three key fields
5. /companies page renders with search, filters, table, and pagination
6. Pagination works across 17k+ companies dataset
</verification>

<success_criteria>
- User can search companies by name, domain, or vertical with results in under 2 seconds
- Each company row shows green/yellow/red enrichment status indicator
- Vertical and enrichment filters work with live count updates
- Pagination works across the full dataset with 50 per page
- Page is bookmarkable (URL-driven state via nuqs)
</success_criteria>

<output>
After completion, create `.planning/phases/04-search-filter-list-building/04-03-SUMMARY.md`
</output>
