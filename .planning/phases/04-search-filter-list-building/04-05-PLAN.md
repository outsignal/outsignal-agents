---
phase: 04-search-filter-list-building
plan: 05
type: execute
wave: 3
depends_on: ["04-02", "04-03", "04-04"]
files_modified:
  - src/components/search/people-search-page.tsx
  - src/components/search/bulk-action-bar.tsx
  - src/components/search/add-to-list-dropdown.tsx
  - src/components/layout/sidebar.tsx
autonomous: true
requirements:
  - LIST-02
  - LIST-03

must_haves:
  truths:
    - "User can select people from search results individually via row checkboxes"
    - "User can select all on the current page via header checkbox"
    - "User can select all matching results across all pages via 'Select all X matching' link"
    - "Sticky action bar appears at bottom when selections are active, showing count and 'Add to List' button"
    - "Add to List opens dropdown to pick existing list or create new"
    - "New list creation from the dropdown requires name and workspace"
    - "Lists and Companies appear as items in the sidebar navigation"
  artifacts:
    - path: "src/components/search/bulk-action-bar.tsx"
      provides: "Sticky bottom bar with selection count and Add to List button"
      exports: ["BulkActionBar"]
    - path: "src/components/search/add-to-list-dropdown.tsx"
      provides: "Dropdown with existing lists + create new list option + modal"
      exports: ["AddToListDropdown"]
    - path: "src/components/search/people-search-page.tsx"
      provides: "Updated with checkbox selection, bulk action bar, add-to-list integration"
      contains: "BulkActionBar"
    - path: "src/components/layout/sidebar.tsx"
      provides: "Updated with Lists and Companies nav items"
      contains: "Lists"
  key_links:
    - from: "src/components/search/add-to-list-dropdown.tsx"
      to: "/api/lists"
      via: "fetch GET for existing lists, POST to create new list"
      pattern: "fetch.*api/lists"
    - from: "src/components/search/add-to-list-dropdown.tsx"
      to: "/api/lists/[id]/people"
      via: "POST to add selected people to chosen list"
      pattern: "fetch.*api/lists.*people"
    - from: "src/components/search/people-search-page.tsx"
      to: "src/components/search/bulk-action-bar.tsx"
      via: "renders BulkActionBar when selections are active"
      pattern: "BulkActionBar"
---

<objective>
Wire bulk selection and list-building actions into the people search page — row checkboxes, "select all matching," sticky action bar, and "Add to List" dropdown with create-new-list capability. Also add Lists and Companies to sidebar navigation.

Purpose: This is the bridge between search/filter and list building. Without selection + add-to-list, users can view data but can't assemble lists. This plan completes the loop from search to list.

Output: Bulk selection on people search, sticky action bar, add-to-list dropdown with create-new-list modal, sidebar navigation updated.
</objective>

<execution_context>
@/Users/jjay/.claude/get-shit-done/workflows/execute-plan.md
@/Users/jjay/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-search-filter-list-building/04-RESEARCH.md
@.planning/phases/04-search-filter-list-building/04-02-SUMMARY.md
@.planning/phases/04-search-filter-list-building/04-04-SUMMARY.md

<interfaces>
<!-- Key interfaces from Plans 02 and 04 -->

From src/components/search/people-search-page.tsx (created in Plan 02):
- "use client" component with nuqs URL state (q, vertical, enrichment, workspace, company, page)
- Fetches from /api/people/search
- Renders FilterSidebar + results table + pagination
- This plan adds checkboxes, selection state, and BulkActionBar to this component

From src/app/api/lists/route.ts (created in Plan 04):
- GET /api/lists — returns { lists: Array<{ id, name, workspaceSlug, ... }> }
- POST /api/lists — creates list, body { name, workspaceSlug, description? }

From src/app/api/lists/[id]/people/route.ts (created in Plan 04):
- POST /api/lists/[id]/people — body A: { personIds: string[] }, body B: { selectAllFilters: {...} }
- Returns { added: number }

From src/components/layout/sidebar.tsx (existing):
- mainNav array with { href, label, icon } entries
- Currently: Dashboard, People, Proposals, Onboarding, Settings
- Need to add: Companies, Lists

From src/components/ui/ (available shadcn components):
- checkbox.tsx, dialog.tsx, dropdown-menu.tsx, button.tsx, input.tsx, label.tsx, select.tsx
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Bulk selection components + Add to List dropdown</name>
  <files>src/components/search/bulk-action-bar.tsx, src/components/search/add-to-list-dropdown.tsx</files>
  <action>
**1. Create `src/components/search/bulk-action-bar.tsx`:**

Sticky bottom bar that appears when selections are active (similar to Gmail's bulk action bar per user's reference).

Props:
```typescript
interface BulkActionBarProps {
  selectedCount: number;           // number of individually selected IDs
  selectAllMatching: boolean;      // true if "select all X matching" is active
  totalMatching: number;           // total count from search results
  onClearSelection: () => void;    // clear all selections
  children: React.ReactNode;       // action buttons (Add to List)
}
```

Layout:
- Fixed to bottom of viewport: `fixed bottom-0 left-64 right-0` (left-64 accounts for sidebar width)
- Background: bg-gray-900 with border-t border-gray-700
- Padding: px-6 py-3
- Left side: count display — "{N} selected" or "All {X} matching selected"
- Left side also: "Clear selection" text button
- Right side: action buttons (children — the AddToListDropdown)
- Animate in/out: use a simple conditional render (don't show when count is 0)

**2. Create `src/components/search/add-to-list-dropdown.tsx`:**

Dropdown button that opens a list picker + "Create new list" option.

Props:
```typescript
interface AddToListDropdownProps {
  selectedPersonIds: string[];      // for individual selection mode
  selectAllFilters: Record<string, unknown> | null; // for "select all matching" mode (current filter params)
  onComplete: () => void;          // called after adding to list (to clear selection, show toast)
}
```

**Behavior:**
1. On click, shows a dropdown (shadcn DropdownMenu) with:
   - Header: "Add to List"
   - Search input to filter existing lists (client-side filter)
   - List of existing lists fetched from GET /api/lists (each shows name + workspace badge)
   - Separator
   - "+ Create New List" option
2. Clicking an existing list:
   - POST /api/lists/{id}/people with either `{ personIds }` or `{ selectAllFilters }`
   - Show brief success feedback (update button text to "Added {N}!" for 2s, or use a simple alert — keep it simple, no toast library needed)
   - Call onComplete()
3. Clicking "Create New List":
   - Opens a Dialog (shadcn Dialog) with form fields:
     - List name (required text input)
     - Workspace (required — use a select dropdown populated from available workspaces, fetched from the lists endpoint or hardcoded from existing workspace slugs)
     - Description (optional textarea)
   - On submit: POST /api/lists to create, then POST /api/lists/{newId}/people to add selected people
   - Close dialog, call onComplete()

**Fetching lists:**
- Fetch GET /api/lists on dropdown open (not on mount — avoids unnecessary calls when user doesn't click Add to List)
- Cache the result while dropdown is open

**Workspace options for create form:**
- Fetch from the lists response (extract unique workspaceSlugs) or use a hardcoded list from the 6 known clients. Better: fetch all workspace slugs from a separate lightweight endpoint, or reuse the filter options from the people search response (if available in parent state).
- Simplest approach: accept `workspaces` as a prop from the parent component, which already has it from the search API response's filterOptions.workspaces.

Updated props:
```typescript
interface AddToListDropdownProps {
  selectedPersonIds: string[];
  selectAllFilters: Record<string, unknown> | null;
  workspaces: string[];            // for create-new-list workspace picker
  onComplete: () => void;
}
```
  </action>
  <verify>
    <automated>cd /Users/jjay/programs/outsignal-agents && npx tsc --noEmit src/components/search/bulk-action-bar.tsx src/components/search/add-to-list-dropdown.tsx 2>&1 | head -20</automated>
  </verify>
  <done>BulkActionBar renders fixed at bottom with selection count and action buttons. AddToListDropdown fetches existing lists, allows picking one, supports creating a new list via modal, and POSTs selected people to the chosen list.</done>
</task>

<task type="auto">
  <name>Task 2: Wire selection into people search page + Update sidebar navigation</name>
  <files>src/components/search/people-search-page.tsx, src/components/layout/sidebar.tsx</files>
  <action>
**1. Update `src/components/search/people-search-page.tsx`:**

Add checkbox selection, "select all matching" functionality, and BulkActionBar integration.

**Selection state:**
```typescript
const [selectedIds, setSelectedIds] = useState<Set<string>>(new Set());
const [selectAllMatching, setSelectAllMatching] = useState(false);
```

**Important:** Keep selection state in the component's useState, NOT in URL state (nuqs). Selection is ephemeral UI state, not bookmarkable.

**Checkbox per row:**
- Import Checkbox from `@/components/ui/checkbox`
- Add a Checkbox column as the first column in the table header and each row
- Header checkbox: checked when all people on current page are selected (or when selectAllMatching is true). onChange toggles all current page IDs.
- Row checkbox: checked if person.id is in selectedIds (or selectAllMatching is true). onChange adds/removes from selectedIds.

**"Select all X matching" prompt:**
When header checkbox is checked and all current-page IDs are selected, show a banner above the table:
"All {pageSize} people on this page are selected. Select all {total} matching people?" [Select all {total}]

Clicking "Select all {total}" sets `selectAllMatching = true`. When selectAllMatching is true, the selection count shows the total matching count, and the Add to List action sends `selectAllFilters` (current URL params) instead of individual IDs.

**Clear selection on filter/search change:**
When any nuqs param changes (q, vertical, enrichment, workspace, company), clear selectedIds and set selectAllMatching to false. Use a useEffect that depends on the stringified params.

**BulkActionBar:**
Render at the bottom when selectedIds.size > 0 or selectAllMatching is true. Pass:
- selectedCount: selectAllMatching ? data.total : selectedIds.size
- selectAllMatching
- totalMatching: data.total
- children: `<AddToListDropdown selectedPersonIds={[...selectedIds]} selectAllFilters={selectAllMatching ? currentFilterParams : null} workspaces={filterOptions.workspaces} onComplete={handleAddComplete} />`

Where `handleAddComplete` clears the selection and optionally shows a brief success message.

Where `currentFilterParams` is an object built from the current nuqs params (q, vertical, enrichment, workspace, company) — the same params used for the search API call.

**2. Update `src/components/layout/sidebar.tsx`:**

Add "Companies" and "Lists" to the mainNav array:

Current mainNav:
```typescript
const mainNav = [
  { href: "/", label: "Dashboard", icon: LayoutDashboard },
  { href: "/people", label: "People", icon: Users },
  { href: "/onboard", label: "Proposals", icon: UserPlus },
  { href: "/onboarding", label: "Onboarding", icon: ClipboardList },
  { href: "/settings", label: "Settings", icon: Settings },
];
```

Updated mainNav — add Companies after People and Lists after Companies:
```typescript
import { Building2, ListChecks } from "lucide-react"; // add these imports

const mainNav = [
  { href: "/", label: "Dashboard", icon: LayoutDashboard },
  { href: "/people", label: "People", icon: Users },
  { href: "/companies", label: "Companies", icon: Building2 },
  { href: "/lists", label: "Lists", icon: ListChecks },
  { href: "/onboard", label: "Proposals", icon: UserPlus },
  { href: "/onboarding", label: "Onboarding", icon: ClipboardList },
  { href: "/settings", label: "Settings", icon: Settings },
];
```

Also update the `isActive` check for /companies and /lists. The current check is `pathname === item.href` which works for exact matches. For /lists/[id] to highlight the Lists nav item, use `pathname === item.href || pathname.startsWith(item.href + '/')` — or use startsWith for all items. Check existing behavior: if `/workspace/rise` highlights correctly via `pathname.startsWith(wsPath)`, then use the same startsWith pattern for mainNav.

Current: `const isActive = pathname === item.href;`
Updated: `const isActive = item.href === "/" ? pathname === "/" : pathname === item.href || pathname.startsWith(item.href + "/");`

This ensures /lists/[id] highlights the "Lists" nav item and /companies highlights "Companies". The special case for "/" prevents every route from matching the dashboard.
  </action>
  <verify>
    <automated>cd /Users/jjay/programs/outsignal-agents && npx tsc --noEmit src/components/search/people-search-page.tsx src/components/layout/sidebar.tsx 2>&1 | head -20</automated>
  </verify>
  <done>People search page has row checkboxes, "select all page" header checkbox, "select all X matching" prompt, and sticky BulkActionBar with AddToListDropdown. Sidebar shows Companies and Lists navigation items with correct active state highlighting.</done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` — no TypeScript errors in all modified files
2. /people page shows checkboxes on each row and in the header
3. Clicking header checkbox selects all 50 rows on the current page
4. "Select all X matching" prompt appears after selecting all on page
5. Sticky action bar appears at bottom with selection count and "Add to List" button
6. "Add to List" dropdown shows existing lists with search
7. Picking a list adds selected people and shows success feedback
8. "Create New List" opens modal with name + workspace fields
9. Creating a list and adding people works end-to-end
10. Selection clears when filters change
11. Sidebar shows Companies and Lists navigation items
12. Clicking Lists in sidebar navigates to /lists
13. /lists/[id] highlights the Lists nav item in sidebar
</verification>

<success_criteria>
- User can select people individually via row checkboxes
- User can select all on current page via header checkbox
- "Select all X matching" link selects across all pages (sends filters to server)
- Sticky action bar shows count and "Add to List" button when selections active
- Add to List dropdown shows existing lists, allows creating new
- New list creation requires name + workspace
- After adding to list, selection clears and user sees success feedback
- Companies and Lists appear in sidebar navigation and highlight correctly
</success_criteria>

<output>
After completion, create `.planning/phases/04-search-filter-list-building/04-05-SUMMARY.md`
</output>
