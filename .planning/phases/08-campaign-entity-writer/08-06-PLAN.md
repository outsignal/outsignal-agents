---
phase: 08-campaign-entity-writer
plan: "06"
type: execute
wave: 3
depends_on:
  - "08-04"
files_modified:
  - src/app/api/webhooks/emailbison/route.ts
  - src/lib/notifications.ts
  - src/lib/agents/writer.ts
autonomous: true
requirements:
  - WRITER-06
  - WRITER-07

must_haves:
  truths:
    - "When a reply webhook fires (LEAD_REPLIED, LEAD_INTERESTED), the writer generates a suggested response"
    - "Suggested response appears in Slack notification as a 'Suggested Response' block below the reply preview"
    - "Suggested response appears in email notification as an additional HTML section"
    - "Reply suggestions use conversation history, workspace context, and knowledge base"
    - "Admin can refine reply suggestions via Cmd+J: 'draft a response to John's reply'"
    - "Reply suggestions follow a subset of quality rules: no em dashes, under 70 words, simple language, NO PVP/spintax"
  artifacts:
    - path: "src/app/api/webhooks/emailbison/route.ts"
      provides: "Reply suggestion generation on LEAD_REPLIED and LEAD_INTERESTED webhooks"
      contains: "suggestedResponse\\|generateReplySuggestion"
    - path: "src/lib/notifications.ts"
      provides: "Slack and email notifications with suggested response blocks"
      contains: "Suggested Response"
  key_links:
    - from: "src/app/api/webhooks/emailbison/route.ts"
      to: "src/lib/agents/writer.ts"
      via: "runWriterAgent in reply suggestion mode"
      pattern: "runWriterAgent\\|suggest.*reply"
    - from: "src/app/api/webhooks/emailbison/route.ts"
      to: "src/lib/notifications.ts"
      via: "notifyReply with suggestedResponse parameter"
      pattern: "notifyReply.*suggestedResponse"
---

<objective>
Add reply suggestion generation to webhook handling — when a lead replies, the writer agent generates a suggested response that appears in Slack and email notifications. Admin can refine via Cmd+J.

Purpose: Reduces response time by having an AI-drafted reply ready the moment a notification fires. Admin reviews and sends via the Outsignal inbox.
Output: Webhook generates reply suggestions, notifications display them, orchestrator supports reply refinement.
</objective>

<execution_context>
@/Users/jjay/.claude/get-shit-done/workflows/execute-plan.md
@/Users/jjay/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-campaign-entity-writer/08-CONTEXT.md
@.planning/phases/08-campaign-entity-writer/08-04-SUMMARY.md

<interfaces>
<!-- Webhook handler -->
From src/app/api/webhooks/emailbison/route.ts:
Available context at webhook receipt:
- leadEmail, leadName, subject, textBody (reply content)
- senderEmail (our sender), workspaceSlug, campaignId
- interested (boolean)
- eventType: LEAD_REPLIED | LEAD_INTERESTED | UNTRACKED_REPLY_RECEIVED

Current notification call (lines 118-126):
```typescript
await notifyReply({
  workspaceSlug,
  leadName,
  leadEmail: leadEmail ?? "unknown",
  senderEmail: senderEmail ?? "unknown",
  subject,
  bodyPreview: textBody,
  interested,
});
```

<!-- Notification interface -->
From src/lib/notifications.ts:
```typescript
export async function notifyReply(params: {
  workspaceSlug: string;
  leadName?: string | null;
  leadEmail: string;
  senderEmail: string;
  subject: string | null;
  bodyPreview: string | null;
  interested?: boolean;
}): Promise<void>
```

<!-- Writer agent -->
From src/lib/agents/writer.ts:
```typescript
export async function runWriterAgent(input: WriterInput): Promise<WriterOutput>
```

From src/lib/agents/types.ts:
```typescript
export interface WriterInput {
  workspaceSlug: string;
  task: string;
  channel?: "email" | "linkedin" | "email_linkedin";
  campaignName?: string;
  campaignId?: string;
  feedback?: string;
  stepNumber?: number;
}
```
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add reply suggestion generation to webhook handler</name>
  <files>src/app/api/webhooks/emailbison/route.ts</files>
  <action>
Add reply suggestion generation when LEAD_REPLIED or LEAD_INTERESTED webhooks fire (matching the trigger decision from CONTEXT.md — all reply webhooks, not just interested).

**Step 1: Create a lightweight reply suggestion function.**

Add a helper function at the top of the webhook route file (or create `src/lib/agents/reply-suggestion.ts` if cleaner):

```typescript
async function generateReplySuggestion(params: {
  workspaceSlug: string;
  leadName: string | null;
  leadEmail: string;
  subject: string | null;
  replyBody: string | null;
  interested: boolean;
}): Promise<string | null> {
  try {
    const { runWriterAgent } = await import("@/lib/agents/writer");
    const result = await runWriterAgent({
      workspaceSlug: params.workspaceSlug,
      task: `Suggest a reply to this incoming email from ${params.leadName ?? params.leadEmail}.

Subject: ${params.subject ?? "(no subject)"}
Their message: ${params.replyBody ?? "(no body)"}
${params.interested ? "Note: This lead is marked as INTERESTED." : ""}

Write a brief, conversational response (under 70 words). This is a reply to an existing conversation, NOT a cold outreach. Do not use spintax or PVP framework. Sound human and natural. Reference what they said and move the conversation forward.`,
      channel: "email",
    });

    // Extract the reply text from the writer output
    if (result.emailSteps && result.emailSteps.length > 0) {
      return result.emailSteps[0].body;
    }
    return result.reviewNotes || null;
  } catch (error) {
    console.error("Reply suggestion generation failed:", error);
    return null; // Non-blocking — notification still fires without suggestion
  }
}
```

**Step 2: Call generateReplySuggestion in the webhook handler.**

In the notification section (after the LinkedIn fast-track, before `notifyReply`), add:

```typescript
let suggestedResponse: string | null = null;

// Generate reply suggestion for reply/interested events (non-blocking)
const replyTriggerEvents = ["LEAD_REPLIED", "LEAD_INTERESTED"];
if (replyTriggerEvents.includes(eventType) && !automatedReply && textBody) {
  suggestedResponse = await generateReplySuggestion({
    workspaceSlug,
    leadName,
    leadEmail: leadEmail ?? "unknown",
    subject,
    replyBody: textBody,
    interested,
  });
}
```

Then pass `suggestedResponse` to `notifyReply`:
```typescript
await notifyReply({
  workspaceSlug,
  leadName,
  leadEmail: leadEmail ?? "unknown",
  senderEmail: senderEmail ?? "unknown",
  subject,
  bodyPreview: textBody,
  interested,
  suggestedResponse, // NEW
});
```

IMPORTANT: Reply suggestion generation must NOT block the webhook response. If generation fails, the notification still fires without a suggestion. The `try/catch` in `generateReplySuggestion` ensures this.

NOTE: This will add latency to the webhook (writer agent takes 10-30s). This is acceptable because:
1. The webhook caller (EmailBison) doesn't wait for the response — fire-and-forget
2. Notifications arrive slightly later but with a useful suggestion
3. If speed becomes an issue later, we can move to background job (Phase 10 infra)
  </action>
  <verify>
    <automated>cd /Users/jjay/programs/outsignal-agents && npx tsc --noEmit 2>&1 | head -20</automated>
  </verify>
  <done>Webhook handler generates reply suggestions on LEAD_REPLIED and LEAD_INTERESTED events, passes suggestedResponse to notifyReply, generation is non-blocking (fails gracefully)</done>
</task>

<task type="auto">
  <name>Task 2: Add suggested response to Slack and email notifications</name>
  <files>src/lib/notifications.ts</files>
  <action>
Update `notifyReply()` to accept and display the suggested response.

**Step 1: Update function signature.**

Add `suggestedResponse` to the params type:
```typescript
export async function notifyReply(params: {
  workspaceSlug: string;
  leadName?: string | null;
  leadEmail: string;
  senderEmail: string;
  subject: string | null;
  bodyPreview: string | null;
  interested?: boolean;
  suggestedResponse?: string | null; // NEW
}): Promise<void>
```

**Step 2: Add Suggested Response block to Slack notification.**

After the body preview section and before the action button, add a conditional block:

```typescript
...(params.suggestedResponse
  ? [
      {
        type: "divider" as const,
      },
      {
        type: "section" as const,
        text: {
          type: "mrkdwn" as const,
          text: `*Suggested Response:*\n${params.suggestedResponse}`,
        },
      },
    ]
  : []),
```

This adds a divider and then the suggested response in a Slack section block. The mrkdwn formatting makes "Suggested Response:" bold.

**Step 3: Add Suggested Response block to email notification.**

In the HTML email body, after the body preview paragraph and before the button, add:

```html
${params.suggestedResponse ? `
<hr style="border:none;border-top:1px solid #e5e7eb;margin:16px 0;" />
<p style="font-size:12px;color:#6b7280;margin-bottom:4px;">SUGGESTED RESPONSE</p>
<div style="background-color:#f9fafb;border-left:3px solid #F0FF7A;padding:12px 16px;margin:8px 0 16px 0;border-radius:4px;">
  <p style="white-space:pre-wrap;margin:0;color:#374151;">${params.suggestedResponse}</p>
</div>
` : ""}
```

This displays the suggested response in a styled box with:
- A divider above
- "SUGGESTED RESPONSE" label in small gray text
- The response text in a left-bordered box with brand-color accent (#F0FF7A)
- Pre-wrap for preserving line breaks
  </action>
  <verify>
    <automated>cd /Users/jjay/programs/outsignal-agents && npx tsc --noEmit 2>&1 | head -5 && grep -c "suggestedResponse\|Suggested Response" src/lib/notifications.ts</automated>
  </verify>
  <done>notifyReply accepts suggestedResponse parameter, Slack notification includes "Suggested Response" mrkdwn block, email notification includes styled HTML block with brand color accent</done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes with no errors
2. Webhook handler calls generateReplySuggestion for LEAD_REPLIED and LEAD_INTERESTED
3. suggestedResponse is passed to notifyReply
4. Slack notification has "Suggested Response" block with divider
5. Email notification has styled suggested response box with #F0FF7A accent
6. Generation failure doesn't block notification (graceful fallback to null)
7. UNTRACKED_REPLY_RECEIVED still fires notification but without suggestion (no trigger for it per user decision)
8. Writer is called in reply mode (no PVP/spintax per context decision)
</verification>

<success_criteria>
When a lead replies or is marked interested, the writer agent generates a suggested response that appears inline in both Slack and email notifications. The suggestion is non-blocking — notifications fire even if generation fails. Admin can refine suggestions via Cmd+J (WRITER-07 is satisfied by the existing delegateToWriter + reply mode in the writer system prompt from Plan 04).
</success_criteria>

<output>
After completion, create `.planning/phases/08-campaign-entity-writer/08-06-SUMMARY.md`
</output>
