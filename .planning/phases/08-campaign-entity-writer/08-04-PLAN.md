---
phase: 08-campaign-entity-writer
plan: "04"
type: execute
wave: 2
depends_on:
  - "08-02"
files_modified:
  - src/lib/agents/writer.ts
  - src/lib/agents/types.ts
autonomous: true
requirements:
  - WRITER-01
  - WRITER-02
  - WRITER-04
  - WRITER-05

must_haves:
  truths:
    - "Writer agent system prompt contains all 11 quality rules from the user's production checklist"
    - "Writer generates default 3-step email sequences (initial + 2 follow-ups) with subject A/B variants"
    - "Writer generates LinkedIn sequences: blank connection request + 2 message follow-ups"
    - "Writer auto-searches knowledge base before generating content (no admin action needed)"
    - "Merge tokens use uppercase single curly braces: {FIRSTNAME}, {COMPANYNAME}"
    - "Email body is under 70 words, subject lines 3-6 words lowercase"
    - "Smart iteration: feedback about specific step regenerates that step only"
  artifacts:
    - path: "src/lib/agents/writer.ts"
      provides: "Upgraded Writer Agent with production quality rules and campaign-aware generation"
      contains: "QUALITY_RULES"
    - path: "src/lib/agents/types.ts"
      provides: "Updated WriterInput with campaignId field for campaign-aware generation"
      contains: "campaignId"
  key_links:
    - from: "src/lib/agents/writer.ts"
      to: "src/lib/knowledge/store.ts"
      via: "searchKnowledge for auto-searching best practices"
      pattern: "searchKnowledge"
    - from: "src/lib/agents/writer.ts"
      to: "src/lib/campaigns/operations.ts"
      via: "getCampaign for loading campaign context"
      pattern: "getCampaign"
---

<objective>
Upgrade the Writer Agent with production-quality rules from the user's checklist, campaign-aware sequence generation, and smart iteration behavior.

Purpose: The writer must produce deployment-ready copy that passes the client's quality checklist on first draft. Campaign awareness lets it generate content directly linked to a Campaign entity.
Output: Rewritten writer system prompt with hardcoded quality rules, campaign-aware tools, smart iteration.
</objective>

<execution_context>
@/Users/jjay/.claude/get-shit-done/workflows/execute-plan.md
@/Users/jjay/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-campaign-entity-writer/08-CONTEXT.md
@.planning/phases/08-campaign-entity-writer/08-02-SUMMARY.md

<interfaces>
<!-- Current writer agent interface -->

From src/lib/agents/types.ts:
```typescript
export interface WriterInput {
  workspaceSlug: string;
  task: string;
  channel?: "email" | "linkedin" | "email_linkedin";
  campaignName?: string;
  feedback?: string;
}

export interface EmailStep {
  position: number;
  subjectLine: string;
  subjectVariantB?: string;
  body: string;
  delayDays: number;
  notes: string;
}

export interface LinkedInStep {
  position: number;
  type: "connection_request" | "message" | "inmail";
  body: string;
  delayDays: number;
  notes: string;
}

export interface WriterOutput {
  campaignName: string;
  channel: "email" | "linkedin" | "email_linkedin";
  emailSteps?: EmailStep[];
  linkedinSteps?: LinkedInStep[];
  reviewNotes: string;
}
```

From src/lib/agents/writer.ts:
```typescript
export async function runWriterAgent(input: WriterInput): Promise<WriterOutput>
export { writerConfig, writerTools }
```

<!-- User's quality rules from 08-CONTEXT.md (NON-NEGOTIABLE) -->
1. All emails under 70 words
2. No em dashes
3. No exclamation marks in subjects
4. Subject lines 3-6 words, lowercase
5. Soft CTAs only (questions)
6. No banned phrases
7. Variables uppercase, single curly braces: {FIRSTNAME}, {COMPANYNAME}
8. Only confirmed variables used
9. PVP framework (Relevance -> Value -> Pain)
10. Spintax 10-30%, no stats/CTAs/variables spun
11. All spintax options grammatically correct

<!-- LinkedIn decisions -->
- Blank connection request (no note) — higher accept rates
- 2 message follow-ups after connection
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update WriterInput type and add campaign context tool</name>
  <files>src/lib/agents/types.ts, src/lib/agents/writer.ts</files>
  <action>
**Step 1: Update WriterInput in types.ts.**

Add `campaignId` field to WriterInput:
```typescript
export interface WriterInput {
  workspaceSlug: string;
  task: string;
  channel?: "email" | "linkedin" | "email_linkedin";
  campaignName?: string;
  campaignId?: string; // NEW: Link to Campaign entity for context
  feedback?: string;
  stepNumber?: number; // NEW: For targeted step regeneration
}
```

**Step 2: Add getCampaignContext tool to writer.**

Add a new tool to writerTools in writer.ts:

```typescript
getCampaignContext: tool({
  description: "Get the Campaign entity details including linked TargetList info, existing sequences, and approval status. Use this when generating content for a specific campaign.",
  inputSchema: z.object({
    campaignId: z.string().describe("The campaign ID"),
  }),
  execute: async ({ campaignId }) => {
    const { getCampaign } = await import("@/lib/campaigns/operations");
    const campaign = await getCampaign(campaignId);
    if (!campaign) return { error: `Campaign '${campaignId}' not found` };
    return {
      name: campaign.name,
      status: campaign.status,
      channels: campaign.channels,
      targetListName: campaign.targetListName,
      targetListPeopleCount: campaign.targetListPeopleCount,
      hasEmailSequence: campaign.emailSequence !== null,
      hasLinkedinSequence: campaign.linkedinSequence !== null,
      emailSequence: campaign.emailSequence,
      linkedinSequence: campaign.linkedinSequence,
      leadsApproved: campaign.leadsApproved,
      contentApproved: campaign.contentApproved,
    };
  },
}),
```

**Step 3: Add saveCampaignSequence tool to writer.**

Add a tool that saves sequences directly to a Campaign entity (in addition to the existing saveDraft tool which saves to EmailDraft):

```typescript
saveCampaignSequence: tool({
  description: "Save email or LinkedIn sequence directly to a Campaign entity. Use this when generating content for a specific campaign (not standalone drafts).",
  inputSchema: z.object({
    campaignId: z.string().describe("The campaign ID"),
    emailSequence: z.array(z.object({
      position: z.number(),
      subjectLine: z.string(),
      subjectVariantB: z.string().optional(),
      body: z.string(),
      delayDays: z.number(),
      notes: z.string().optional(),
    })).optional().describe("Email sequence steps"),
    linkedinSequence: z.array(z.object({
      position: z.number(),
      type: z.enum(["connection_request", "message", "inmail"]),
      body: z.string(),
      delayDays: z.number(),
      notes: z.string().optional(),
    })).optional().describe("LinkedIn sequence steps"),
  }),
  execute: async ({ campaignId, emailSequence, linkedinSequence }) => {
    const { saveCampaignSequences } = await import("@/lib/campaigns/operations");
    const updated = await saveCampaignSequences(campaignId, {
      emailSequence: emailSequence ?? undefined,
      linkedinSequence: linkedinSequence ?? undefined,
    });
    return {
      status: "saved",
      campaignName: updated.name,
      emailStepCount: emailSequence?.length ?? 0,
      linkedinStepCount: linkedinSequence?.length ?? 0,
    };
  },
}),
```

**Step 4: Update buildWriterMessage to include campaignId context.**

In `buildWriterMessage(input)`:
- If `input.campaignId` is provided, add `Campaign ID: ${input.campaignId}` to the message
- If `input.stepNumber` is provided, add `Target step: ${input.stepNumber} (regenerate only this step)`
  </action>
  <verify>
    <automated>cd /Users/jjay/programs/outsignal-agents && npx tsc --noEmit 2>&1 | head -20</automated>
  </verify>
  <done>WriterInput has campaignId and stepNumber fields, getCampaignContext and saveCampaignSequence tools added to writer, buildWriterMessage includes campaign context</done>
</task>

<task type="auto">
  <name>Task 2: Rewrite Writer system prompt with production quality rules</name>
  <files>src/lib/agents/writer.ts</files>
  <action>
Replace the entire `WRITER_SYSTEM_PROMPT` string with a new version that includes the user's production quality rules. The new system prompt must contain ALL of the following sections:

**Section 1: Role and purpose** (keep similar to current but tighter)

**Section 2: Process** (updated):
1. If campaignId provided → call getCampaignContext to load campaign
2. Call getWorkspaceIntelligence for client context
3. Call searchKnowledgeBase for relevant best practices (auto-search, no admin action needed — per user decision)
4. Call getCampaignPerformance + getSequenceSteps for existing campaign data
5. Call getExistingDrafts to check prior versions
6. Generate content following quality rules
7. If campaignId → save via saveCampaignSequence; otherwise save via saveDraft

**Section 3: QUALITY RULES (hardcoded, non-negotiable)** — These are verbatim from the user's production checklist:

```
## Quality Rules (MANDATORY — every generated email MUST pass ALL rules)

1. **Word count**: All emails under 70 words. No exceptions. Count before saving.
2. **No em dashes**: Never use — (em dash). Use commas or periods instead.
3. **No exclamation marks in subjects**: Subject lines never contain "!"
4. **Subject lines**: 3-6 words, all lowercase, create curiosity or relevance. No spam triggers.
5. **Soft CTAs only**: Every CTA must be a question. "worth a chat?" not "book a call". "open to exploring?" not "schedule a demo".
6. **No banned phrases**: Never use "I hope this finds you well", "My name is", "I wanted to reach out", "touching base", "circling back", "just following up", "synergy", "leverage", "game-changer", "revolutionary", "guaranteed", "act now", "limited time", "exclusive offer", "no obligation", "free".
7. **Variables**: Uppercase with single curly braces ONLY: {FIRSTNAME}, {COMPANYNAME}, {JOBTITLE}, {LOCATION}. Never use {{double braces}} or lowercase variables.
8. **Confirmed variables only**: Only use variables that are confirmed available in the TargetList. If unsure, ask — don't guess.
9. **PVP framework**: Structure every cold email as Relevance (why them) → Value (what you offer) → Pain (what they lose without it). This is the structural backbone.
10. **Spintax**: Include spintax in 10-30% of content. Format: {option1|option2|option3}. NEVER spin statistics, CTAs, variable names, or company-specific claims. All options must be grammatically interchangeable.
11. **Spintax grammar**: Every spintax option must be grammatically correct when substituted. Read each variant aloud.
```

**Section 4: Email sequence defaults:**
- Default 3 steps: initial (day 0) + follow-up 1 (day 3) + follow-up 2 (day 7)
- Admin can request more or fewer steps
- One angle per generation. For A/B variants, admin says "write another angle"
- Always provide subject line B variant for A/B testing
- Follow-ups reference previous emails naturally, don't repeat the pitch
- Sign-off uses sender name/title from workspace data

**Section 5: LinkedIn sequence defaults:**
- Blank connection request (no note — user decision: higher accept rates in cold outreach)
- 2 message follow-ups after connection (day 3 and day 7 post-connect)
- Messages under 100 words, conversational tone
- No links in connection requests
- LinkedIn is chat, not email — more personal

**Section 6: Smart iteration behavior:**
- If feedback mentions a specific step number ("step 2 is too long"), regenerate ONLY that step — preserve others
- If feedback is general ("too formal"), regenerate ALL steps with the adjusted tone
- When revising, always load existing sequences first via getCampaignContext or getExistingDrafts

**Section 7: Reply suggestion mode** (separate from outbound):
- When task starts with "suggest reply" or "draft response", switch to reply mode
- Reply mode rules: no em dashes, under 70 words, simple language, conversational
- Reply mode does NOT use PVP framework or spintax (those are for cold outreach only)
- Context: full thread + workspace context + knowledge base search

**Section 8: Output format** (keep existing JSON structure but add `campaignId` field if campaign-based)

IMPORTANT: Keep the model as `claude-opus-4-20250514` and maxSteps as 10.
  </action>
  <verify>
    <automated>cd /Users/jjay/programs/outsignal-agents && grep -c "70 words\|em dash\|PVP\|spintax\|FIRSTNAME\|Soft CTAs\|banned phrases" src/lib/agents/writer.ts</automated>
  </verify>
  <done>Writer system prompt contains all 11 quality rules verbatim, email/LinkedIn defaults match user decisions, smart iteration and reply mode documented, PVP framework explained, spintax rules included</done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes with no errors
2. System prompt contains all 11 quality rules
3. Writer has 8 tools: getWorkspaceIntelligence, getCampaignPerformance, getSequenceSteps, searchKnowledgeBase (shared), getExistingDrafts, saveDraft, getCampaignContext, saveCampaignSequence
4. WriterInput has campaignId and stepNumber fields
5. Merge token format is {FIRSTNAME} not {{firstName}}
6. Email word count rule is 70 (not 100 as in old prompt)
7. LinkedIn connection request is explicitly blank (no note)
8. Reply suggestion mode has separate rules from outbound mode
</verification>

<success_criteria>
Writer Agent is upgraded with production-quality rules matching the user's checklist, campaign-aware generation via getCampaignContext and saveCampaignSequence tools, smart iteration for targeted step regeneration, and reply suggestion mode with appropriate rule subset.
</success_criteria>

<output>
After completion, create `.planning/phases/08-campaign-entity-writer/08-04-SUMMARY.md`
</output>
