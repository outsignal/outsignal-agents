---
phase: 07-leads-agent-dashboard
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/leads/operations.ts
autonomous: true
requirements: [LEAD-05]

must_haves:
  truths:
    - "All DB queries for search, list create, list manage, score, and export live in operations.ts — not in agent tool closures"
    - "operations.ts functions accept typed params and return typed results (no `any`)"
    - "searchPeople supports filtering by query, jobTitle, vertical, location, workspaceSlug, minIcpScore, hasVerifiedEmail, page, limit"
    - "createList creates a TargetList and returns it"
    - "addPeopleToList adds people to a TargetList with dedup"
    - "getList returns a TargetList with people count and enrichment stats"
    - "scoreList scores unscored people in a list (skips already-scored via icpScoredAt), checks icpCriteriaPrompt first"
    - "exportListToEmailBison uploads verified leads to EmailBison workspace and returns counts"
  artifacts:
    - path: "src/lib/leads/operations.ts"
      provides: "Shared operations layer for Leads Agent and future MCP tools"
      exports: ["searchPeople", "createList", "addPeopleToList", "getList", "getLists", "scoreList", "exportListToEmailBison"]
      min_lines: 150
  key_links:
    - from: "src/lib/leads/operations.ts"
      to: "prisma.person / prisma.targetList / prisma.personWorkspace"
      via: "Prisma queries"
      pattern: "prisma\\.(person|targetList|personWorkspace|targetListPerson)\\."
    - from: "src/lib/leads/operations.ts"
      to: "src/lib/icp/scorer.ts"
      via: "import scorePersonIcp"
      pattern: "import.*scorePersonIcp.*from.*icp/scorer"
    - from: "src/lib/leads/operations.ts"
      to: "src/lib/export/verification-gate.ts"
      via: "import getListExportReadiness, verifyAndFilter"
      pattern: "import.*getListExportReadiness.*from.*verification-gate"
    - from: "src/lib/leads/operations.ts"
      to: "src/lib/emailbison/client.ts"
      via: "import getClientForWorkspace"
      pattern: "getClientForWorkspace"
---

<objective>
Create the shared operations layer that all lead pipeline actions route through.

Purpose: LEAD-05 requires no logic divergence between agent tools and future MCP tools. All DB queries and business logic must live in `src/lib/leads/operations.ts` — agent tools and MCP tools are thin wrappers.

Output: `src/lib/leads/operations.ts` with 7 exported functions covering search, list CRUD, scoring, and export.
</objective>

<execution_context>
@/Users/jjay/.claude/get-shit-done/workflows/execute-plan.md
@/Users/jjay/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-leads-agent-dashboard/07-RESEARCH.md

<interfaces>
<!-- Key types and contracts the executor needs. Extracted from codebase. -->

From prisma/schema.prisma — Person model (DB table "Lead"):
```prisma
model Person {
  id             String   @id @default(cuid())
  email          String   @unique
  firstName      String?
  lastName       String?
  company        String?
  companyDomain  String?
  jobTitle       String?
  phone          String?
  linkedinUrl    String?
  location       String?
  vertical       String?
  source         String
  status         String   @default("new")
  enrichmentData String?
  workspaces     PersonWorkspace[]
  lists          TargetListPerson[]
  @@map("Lead")
}
```

From prisma/schema.prisma — PersonWorkspace model (DB table "LeadWorkspace"):
```prisma
model PersonWorkspace {
  id        String   @id @default(cuid())
  personId  String   @map("leadId")
  workspace String
  icpScore       Int?
  icpReasoning   String?
  icpConfidence  String?
  icpScoredAt    DateTime?
  person    Person   @relation(fields: [personId], references: [id], onDelete: Cascade)
  @@unique([personId, workspace], map: "LeadWorkspace_leadId_workspace_key")
  @@map("LeadWorkspace")
}
```

From prisma/schema.prisma — TargetList and TargetListPerson:
```prisma
model TargetList {
  id            String   @id @default(cuid())
  name          String
  workspaceSlug String
  description   String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  people TargetListPerson[]
}

model TargetListPerson {
  id       String   @id @default(cuid())
  listId   String
  personId String
  addedAt  DateTime @default(now())
  list   TargetList @relation(...)
  person Person     @relation(...)
  @@unique([listId, personId])
}
```

From src/lib/icp/scorer.ts:
```typescript
export async function scorePersonIcp(
  personId: string,
  workspaceSlug: string,
  forceRecrawl?: boolean,
): Promise<IcpScoreResult>
// IcpScoreResult: { score: number, reasoning: string, confidence: "high"|"medium"|"low" }
// Throws if workspace.icpCriteriaPrompt is null/empty
// Persists score to PersonWorkspace.icpScore, icpReasoning, icpConfidence, icpScoredAt
```

From src/lib/export/verification-gate.ts:
```typescript
export async function getListExportReadiness(listId: string): Promise<ExportReadiness>
// ExportReadiness: { totalCount, readyCount, needsVerificationCount, blockedCount, readyPeople, needsVerificationPeople, blockedPeople, ... }

export async function verifyAndFilter(
  people: { id: string; email: string }[]
): Promise<{ verified: VerificationResult[]; excluded: VerificationResult[] }>
```

From src/lib/workspaces.ts:
```typescript
export async function getClientForWorkspace(slug: string): Promise<EmailBisonClient>
```

From src/lib/emailbison/client.ts:
```typescript
class EmailBisonClient {
  async createLead(params: CreateLeadParams): Promise<CreateLeadResult>
  // CreateLeadParams: { email, firstName?, lastName?, jobTitle?, company?, phone?, customVariables? }
  // CreateLeadResult: { id: number, email: string, status: string }
}
```
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create operations.ts with search, list CRUD, scoring, and export functions</name>
  <files>src/lib/leads/operations.ts</files>
  <action>
Create `src/lib/leads/operations.ts` with the following exported functions. ALL Prisma queries and business logic must live here — never in agent tool closures.

**1. `searchPeople(params)`** — Search people in the database
- Params: `{ query?: string, jobTitle?: string, vertical?: string, location?: string, workspaceSlug?: string, minIcpScore?: number, hasVerifiedEmail?: boolean, page?: number, limit?: number }`
- Returns: `{ people: PersonSearchResult[], total: number, page: number }`
- `PersonSearchResult` type: `{ id, email, firstName, lastName, company, companyDomain, jobTitle, vertical, location, linkedinUrl, source, status, icpScore?, icpReasoning?, workspaces: string[] }`
- Build Prisma `AND` conditions array (same pattern as `src/app/api/people/search/route.ts`):
  - `query` → OR across email, firstName, lastName, company, jobTitle (contains, case-insensitive)
  - `jobTitle` → contains, case-insensitive (separate from query — allows "find CTOs" specifically)
  - `vertical` → exact match
  - `location` → contains, case-insensitive
  - `workspaceSlug` → `{ workspaces: { some: { workspace: workspaceSlug } } }`
  - `minIcpScore` → join through PersonWorkspace: `{ workspaces: { some: { icpScore: { gte: minIcpScore } } } }`
  - `hasVerifiedEmail` → if true, check enrichmentData contains `"emailVerificationStatus":"valid"` using Prisma `string_contains`
- Include PersonWorkspace data: `{ workspaces: { select: { workspace: true, icpScore: true, icpReasoning: true } } }`
- Default limit: 25, default page: 1
- Order by createdAt desc

**2. `createList(params)`** — Create a new TargetList
- Params: `{ name: string, workspaceSlug: string, description?: string }`
- Returns: `TargetList` (the created record)
- Simple `prisma.targetList.create()`

**3. `addPeopleToList(listId, personIds)`** — Add people to a list with dedup
- Params: `listId: string, personIds: string[]`
- Returns: `{ added: number, alreadyInList: number }`
- Use `prisma.targetListPerson.createMany({ data: ..., skipDuplicates: true })`
- Count existing before to calculate `alreadyInList`

**4. `getList(listId)`** — Get a single list with stats
- Returns: `{ id, name, workspaceSlug, description, createdAt, peopleCount, people: PersonSearchResult[] }`
- Include people with their PersonWorkspace data for ICP scores

**5. `getLists(params)`** — List all target lists
- Params: `{ workspaceSlug?: string, query?: string }`
- Returns: `{ lists: ListSummary[] }` with `ListSummary: { id, name, workspaceSlug, description, createdAt, peopleCount }`

**6. `scoreList(listId, workspaceSlug)`** — Score unscored people in a list
- Returns: `{ scored: number, skipped: number, failed: number, results: { personId: string, score: number, reasoning: string }[] }`
- CRITICAL: First check `workspace.icpCriteriaPrompt` is set — return clear error message if not (Pitfall 1)
- CRITICAL: Only score people where `PersonWorkspace.icpScoredAt IS NULL` — skip already-scored (Pitfall 5)
- Use batched parallel scoring: chunks of 5 with `Promise.allSettled` (conservative to avoid Anthropic rate limits)
- For each person, call `scorePersonIcp(personId, workspaceSlug, false)` from `@/lib/icp/scorer`
- Track failed scores and include error messages in result

**7. `exportListToEmailBison(listId, workspaceSlug)`** — Export verified leads to EmailBison
- Returns: `{ exported: number, alreadyExported: number, needsVerification: number, blocked: number, errors: string[] }`
- Call `getListExportReadiness(listId)` to categorize people
- If `needsVerificationCount > 0`, return immediately with `needsVerification` count (credit-gate — user must approve verification spend first)
- For `readyPeople`, call `getClientForWorkspace(workspaceSlug)` then loop through and call `client.createLead()` for each
- Wrap each createLead in try/catch — push failures to `errors` array
- NOTE: Export means "upload leads to EmailBison workspace" — no campaign assignment (Pitfall 3 from spike)

Define all result types as exported interfaces at the top of the file.
  </action>
  <verify>
    <automated>cd /Users/jjay/programs/outsignal-agents && npx tsc --noEmit src/lib/leads/operations.ts 2>&1 | head -30</automated>
  </verify>
  <done>
    - `src/lib/leads/operations.ts` exists with all 7 exported functions
    - TypeScript compiles without errors
    - All Prisma queries are in this file (not in agent tool closures)
    - searchPeople supports all 9 filter params (query, jobTitle, vertical, location, workspaceSlug, minIcpScore, hasVerifiedEmail, page, limit)
    - scoreList skips already-scored people (checks icpScoredAt) and checks icpCriteriaPrompt
    - exportListToEmailBison returns needsVerification count without spending credits when unverified people exist
  </done>
</task>

</tasks>

<verification>
- `npx tsc --noEmit` passes for `src/lib/leads/operations.ts`
- File exports exactly: searchPeople, createList, addPeopleToList, getList, getLists, scoreList, exportListToEmailBison
- No imports from agent tool files (operations is the foundation, not a consumer)
- Imports scorePersonIcp, getListExportReadiness, verifyAndFilter, getClientForWorkspace correctly
</verification>

<success_criteria>
- operations.ts is the single source of truth for all lead pipeline DB queries and business logic
- Every function has typed params and typed return values
- Zero business logic will need to be duplicated in agent tool closures
</success_criteria>

<output>
After completion, create `.planning/phases/07-leads-agent-dashboard/07-01-SUMMARY.md`
</output>
