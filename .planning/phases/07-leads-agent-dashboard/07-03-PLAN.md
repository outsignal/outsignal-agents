---
phase: 07-leads-agent-dashboard
plan: 03
type: execute
wave: 3
depends_on: [07-02]
files_modified:
  - src/lib/agents/orchestrator.ts
  - src/app/api/chat/route.ts
autonomous: true
requirements: [LEAD-01, LEAD-02, LEAD-03, LEAD-04, LEAD-06]

must_haves:
  truths:
    - "Orchestrator's delegateToLeads tool calls runLeadsAgent() instead of returning 'not_available'"
    - "Chat route has maxDuration = 300 to prevent Vercel timeout on scoring/export"
    - "Orchestrator system prompt updated to reflect Leads Agent as live (not 'coming soon')"
    - "Admin can type a lead search query in Cmd+J and get results through the full delegateToLeads → runLeadsAgent → operations chain"
  artifacts:
    - path: "src/lib/agents/orchestrator.ts"
      provides: "Updated orchestrator with live Leads Agent delegation"
      contains: "runLeadsAgent"
    - path: "src/app/api/chat/route.ts"
      provides: "Chat route with maxDuration for long operations"
      contains: "maxDuration"
  key_links:
    - from: "src/lib/agents/orchestrator.ts"
      to: "src/lib/agents/leads.ts"
      via: "import runLeadsAgent"
      pattern: "import.*runLeadsAgent.*from.*leads"
    - from: "src/app/api/chat/route.ts"
      to: "src/lib/agents/orchestrator.ts"
      via: "import orchestratorTools, orchestratorConfig"
      pattern: "import.*orchestratorTools.*from.*orchestrator"
---

<objective>
Wire the Leads Agent into the orchestrator and configure the chat route for production use.

Purpose: Without this wiring, the Leads Agent exists but is unreachable from the Cmd+J chat. This plan activates the full chain: user types in chat → orchestrator delegates to Leads Agent → operations layer executes → results stream back. Also adds maxDuration to prevent Vercel timeout (Pitfall 6).

Output: Updated `orchestrator.ts` with live delegation, updated `route.ts` with maxDuration.
</objective>

<execution_context>
@/Users/jjay/.claude/get-shit-done/workflows/execute-plan.md
@/Users/jjay/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-leads-agent-dashboard/07-RESEARCH.md
@.planning/phases/07-leads-agent-dashboard/07-02-SUMMARY.md

<interfaces>
<!-- From Plan 02 output: src/lib/agents/leads.ts -->
```typescript
export async function runLeadsAgent(input: LeadsInput): Promise<LeadsOutput>
// LeadsInput: { workspaceSlug?: string, task: string, conversationContext?: string }
// LeadsOutput: { action: string, summary: string, data?: unknown }
```

<!-- Current orchestrator.ts — delegateToLeads stub to replace: -->
```typescript
const delegateToLeads = tool({
  description: "Delegate a task to the Leads Agent...",
  inputSchema: z.object({
    workspaceSlug: z.string().describe("Workspace slug"),
    task: z.string().describe("What you want the Leads Agent to do"),
    limit: z.number().optional().describe("Max leads to find"),
  }),
  execute: async () => {
    return {
      status: "not_available",
      message: "The Leads Agent is not yet implemented...",
    };
  },
});
```

<!-- Current chat route.ts: -->
```typescript
// No maxDuration set — defaults to 10s on Vercel Hobby plan
export async function POST(request: Request) {
  const { messages, context } = await request.json();
  // ...streamText...
}
```
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Wire delegateToLeads to call runLeadsAgent</name>
  <files>src/lib/agents/orchestrator.ts</files>
  <action>
Update `src/lib/agents/orchestrator.ts`:

1. Add import at top: `import { runLeadsAgent } from "./leads";`

2. Replace the `delegateToLeads` stub with a live implementation:
```typescript
const delegateToLeads = tool({
  description:
    "Delegate a task to the Leads Agent. Use this when the user wants to: search for leads/people, create or manage target lists, score leads against ICP criteria, or export verified leads to EmailBison. The Leads Agent handles all lead pipeline operations via natural language.",
  inputSchema: z.object({
    workspaceSlug: z
      .string()
      .optional()
      .describe("Workspace slug (for workspace-scoped operations like scoring and export)"),
    task: z
      .string()
      .describe("What you want the Leads Agent to do. Be specific about search criteria, list names, or export targets."),
  }),
  execute: async ({ workspaceSlug, task }) => {
    try {
      const result = await runLeadsAgent({ workspaceSlug, task });
      return {
        status: "complete",
        action: result.action,
        summary: result.summary,
        data: result.data,
      };
    } catch (error) {
      return {
        status: "failed",
        error: error instanceof Error ? error.message : "Leads Agent failed",
      };
    }
  },
});
```

Note: Remove the `limit` param from inputSchema — the Leads Agent handles pagination internally.

3. Update the `ORCHESTRATOR_SYSTEM_PROMPT` — change the Leads Agent description from future tense to present tense:
   - Replace: `"- **delegateToLeads**: For lead sourcing, enrichment, scoring (coming soon)"`
   - With: `"- **delegateToLeads**: For searching people, building target lists, scoring against ICP, exporting to EmailBison"`
   - Replace the routing example: `"Find 200 leads for X" → Delegate to Leads Agent (multi-source search)`
   - With: `"Find CTOs in fintech" → Delegate to Leads Agent (database search + pipeline)`
   - Add new routing examples:
     - `"Create a list called Rise Q1" → Delegate to Leads Agent`
     - `"Score the Rise Q1 list" → Delegate to Leads Agent`
     - `"Export Rise Q1 to EmailBison" → Delegate to Leads Agent`
   - Remove or update the note about Leads Agent not being available

4. Remove the import for `limit` in the delegateToLeads tool if it was destructured (the old version had `limit` in the inputSchema).
  </action>
  <verify>
    <automated>cd /Users/jjay/programs/outsignal-agents && npx tsc --noEmit src/lib/agents/orchestrator.ts 2>&1 | head -20</automated>
  </verify>
  <done>
    - delegateToLeads calls runLeadsAgent() and returns structured result
    - Orchestrator system prompt describes Leads Agent as live with correct routing examples
    - "not_available" stub is completely removed
    - TypeScript compiles without errors
  </done>
</task>

<task type="auto">
  <name>Task 2: Add maxDuration to chat route</name>
  <files>src/app/api/chat/route.ts</files>
  <action>
Add the Vercel route segment config at the top of `src/app/api/chat/route.ts`, after the imports and before any function definitions:

```typescript
export const maxDuration = 300; // 5 minutes — Leads Agent scoring can take 60-300s for large lists
```

This is a Next.js route segment config that tells Vercel to allow up to 300 seconds (5 minutes) before timing out. Without this, the default 10s timeout on Hobby plan causes chat responses to cut off during scoring/export operations (Pitfall 6 from research).

No other changes to the chat route are needed — it already uses `streamText` and `toUIMessageStreamResponse()` which handles streaming correctly.
  </action>
  <verify>
    <automated>cd /Users/jjay/programs/outsignal-agents && grep -n "maxDuration" src/app/api/chat/route.ts</automated>
  </verify>
  <done>
    - `export const maxDuration = 300;` is present in the chat route
    - Chat route still compiles without errors
  </done>
</task>

</tasks>

<verification>
- `npx tsc --noEmit` passes for both modified files
- `grep "runLeadsAgent" src/lib/agents/orchestrator.ts` shows the import and call
- `grep "not_available" src/lib/agents/orchestrator.ts` returns NO matches for the Leads Agent (stub removed)
- `grep "maxDuration" src/app/api/chat/route.ts` returns the 300 value
- Full chain test (manual): typing a search query in Cmd+J should route through orchestrator → delegateToLeads → runLeadsAgent → operations.searchPeople → Prisma → results
</verification>

<success_criteria>
- The full delegation chain is wired: chat route → orchestrator → Leads Agent → operations layer
- Orchestrator no longer returns "not_available" for Leads Agent tasks
- Vercel timeout is set to 300s to handle long-running scoring/export operations
- All requirements LEAD-01 through LEAD-04 and LEAD-06 are satisfied end-to-end when combined with Plans 01 and 02
</success_criteria>

<output>
After completion, create `.planning/phases/07-leads-agent-dashboard/07-03-SUMMARY.md`
</output>
