---
plan: 09-02
phase: 09-client-portal-campaign-approval
title: "Portal Campaign API Routes"
wave: 1
depends_on: []
requirements:
  - PORTAL-03
  - PORTAL-05
  - PORTAL-06
  - PORTAL-07
files_modified:
  - src/app/api/portal/campaigns/route.ts
  - src/app/api/portal/campaigns/[id]/route.ts
  - src/app/api/portal/campaigns/[id]/approve-leads/route.ts
  - src/app/api/portal/campaigns/[id]/request-changes-leads/route.ts
  - src/app/api/portal/campaigns/[id]/approve-content/route.ts
  - src/app/api/portal/campaigns/[id]/request-changes-content/route.ts
autonomous: true
---

# Plan 09-02: Portal Campaign API Routes

## Goal

Create 6 portal API routes under `/api/portal/campaigns/` that handle campaign listing, campaign detail fetching, and four approval/rejection actions. Every route enforces workspace ownership via `getPortalSession()` (PORTAL-07). Lead and content approval are fully independent (PORTAL-06).

## Context

- All routes go under `/api/portal/campaigns/` so they're covered by the existing `PUBLIC_API_PREFIXES` entry `/api/portal/` in middleware.ts. This means they bypass admin auth and use portal session auth instead.
- Portal session is retrieved via `getPortalSession()` from `src/lib/portal-session.ts` which returns `{ workspaceSlug, email }`.
- Approval mutation functions (`approveCampaignLeads`, `rejectCampaignLeads`, `approveCampaignContent`, `rejectCampaignContent`) are created in Plan 09-01. If Plan 09-01 hasn't run yet, import them — they'll resolve once 09-01 executes. Alternatively, build the functions inline temporarily and refactor. **Preferred:** just import from operations.ts — the plans run in order within a wave but Task T2 of 09-01 must complete before these compile.
- Notification wiring (`notifyApproval()`) is NOT added here — it's done in Plan 09-05 which wires notifications into these routes after both the routes and the notification function exist.
- Next.js 16 route handlers use `{ params }: { params: Promise<{ id: string }> }` signature (params is a Promise).

## must_haves

- [ ] GET `/api/portal/campaigns` returns all campaigns for the session's workspace
- [ ] GET `/api/portal/campaigns/[id]` returns campaign detail with workspace ownership check
- [ ] POST `/api/portal/campaigns/[id]/approve-leads` approves leads (PORTAL-03)
- [ ] POST `/api/portal/campaigns/[id]/request-changes-leads` rejects leads with feedback text (PORTAL-03)
- [ ] POST `/api/portal/campaigns/[id]/approve-content` approves content (PORTAL-05)
- [ ] POST `/api/portal/campaigns/[id]/request-changes-content` rejects content with feedback text (PORTAL-05)
- [ ] Every route calls `getPortalSession()` first and returns 401 if no session (PORTAL-07)
- [ ] Every route with `[id]` verifies `campaign.workspaceSlug === session.workspaceSlug` and returns 403 if mismatch (PORTAL-07)
- [ ] Lead and content approval routes are completely independent — approving one does not touch the other (PORTAL-06)

## Tasks

<task id="09-02-T1">
<title>Create campaign list and detail API routes</title>
<details>

### File 1: `src/app/api/portal/campaigns/route.ts` (NEW)

```typescript
import { NextResponse } from "next/server";
import { getPortalSession } from "@/lib/portal-session";
import { listCampaigns } from "@/lib/campaigns/operations";

export async function GET() {
  let session;
  try {
    session = await getPortalSession();
  } catch {
    return NextResponse.json({ error: "Unauthorized" }, { status: 401 });
  }

  const campaigns = await listCampaigns(session.workspaceSlug);
  return NextResponse.json({ campaigns });
}
```

### File 2: `src/app/api/portal/campaigns/[id]/route.ts` (NEW)

```typescript
import { NextResponse } from "next/server";
import { getPortalSession } from "@/lib/portal-session";
import { getCampaign, getCampaignLeadSample } from "@/lib/campaigns/operations";

export async function GET(
  _req: Request,
  { params }: { params: Promise<{ id: string }> },
) {
  const { id } = await params;

  let session;
  try {
    session = await getPortalSession();
  } catch {
    return NextResponse.json({ error: "Unauthorized" }, { status: 401 });
  }

  const campaign = await getCampaign(id);
  if (!campaign) {
    return NextResponse.json({ error: "Not found" }, { status: 404 });
  }
  if (campaign.workspaceSlug !== session.workspaceSlug) {
    return NextResponse.json({ error: "Forbidden" }, { status: 403 });
  }

  // Fetch lead sample if campaign has a target list
  let leadSample = null;
  if (campaign.targetListId) {
    leadSample = await getCampaignLeadSample(
      campaign.targetListId,
      session.workspaceSlug,
    );
  }

  return NextResponse.json({ campaign, leadSample });
}
```

**Note:** This route returns both campaign detail and lead sample in one call to avoid a second round-trip from the detail page.

</details>
</task>

<task id="09-02-T2">
<title>Create four approval/rejection action routes</title>
<details>

All four routes follow the same pattern:
1. Parse `id` from params
2. Call `getPortalSession()` — return 401 on failure
3. Load campaign via `getCampaign(id)` — return 404 if missing
4. Check `campaign.workspaceSlug === session.workspaceSlug` — return 403 if mismatch
5. Call the appropriate operations function
6. Return the updated campaign

### File 1: `src/app/api/portal/campaigns/[id]/approve-leads/route.ts` (NEW)

```typescript
import { NextResponse } from "next/server";
import { getPortalSession } from "@/lib/portal-session";
import { getCampaign, approveCampaignLeads } from "@/lib/campaigns/operations";

export async function POST(
  _req: Request,
  { params }: { params: Promise<{ id: string }> },
) {
  const { id } = await params;

  let session;
  try {
    session = await getPortalSession();
  } catch {
    return NextResponse.json({ error: "Unauthorized" }, { status: 401 });
  }

  const campaign = await getCampaign(id);
  if (!campaign) {
    return NextResponse.json({ error: "Not found" }, { status: 404 });
  }
  if (campaign.workspaceSlug !== session.workspaceSlug) {
    return NextResponse.json({ error: "Forbidden" }, { status: 403 });
  }

  const updated = await approveCampaignLeads(id);

  return NextResponse.json({ campaign: updated });
}
```

### File 2: `src/app/api/portal/campaigns/[id]/request-changes-leads/route.ts` (NEW)

```typescript
import { NextResponse } from "next/server";
import { getPortalSession } from "@/lib/portal-session";
import { getCampaign, rejectCampaignLeads } from "@/lib/campaigns/operations";

export async function POST(
  req: Request,
  { params }: { params: Promise<{ id: string }> },
) {
  const { id } = await params;

  let session;
  try {
    session = await getPortalSession();
  } catch {
    return NextResponse.json({ error: "Unauthorized" }, { status: 401 });
  }

  const campaign = await getCampaign(id);
  if (!campaign) {
    return NextResponse.json({ error: "Not found" }, { status: 404 });
  }
  if (campaign.workspaceSlug !== session.workspaceSlug) {
    return NextResponse.json({ error: "Forbidden" }, { status: 403 });
  }

  const body = await req.json();
  const feedback = body.feedback;
  if (!feedback || typeof feedback !== "string" || !feedback.trim()) {
    return NextResponse.json(
      { error: "Feedback text is required" },
      { status: 400 },
    );
  }

  const updated = await rejectCampaignLeads(id, feedback.trim());

  return NextResponse.json({ campaign: updated });
}
```

### File 3: `src/app/api/portal/campaigns/[id]/approve-content/route.ts` (NEW)

Same pattern as approve-leads but calls `approveCampaignContent(id)`:

```typescript
import { NextResponse } from "next/server";
import { getPortalSession } from "@/lib/portal-session";
import { getCampaign, approveCampaignContent } from "@/lib/campaigns/operations";

export async function POST(
  _req: Request,
  { params }: { params: Promise<{ id: string }> },
) {
  const { id } = await params;

  let session;
  try {
    session = await getPortalSession();
  } catch {
    return NextResponse.json({ error: "Unauthorized" }, { status: 401 });
  }

  const campaign = await getCampaign(id);
  if (!campaign) {
    return NextResponse.json({ error: "Not found" }, { status: 404 });
  }
  if (campaign.workspaceSlug !== session.workspaceSlug) {
    return NextResponse.json({ error: "Forbidden" }, { status: 403 });
  }

  const updated = await approveCampaignContent(id);

  return NextResponse.json({ campaign: updated });
}
```

### File 4: `src/app/api/portal/campaigns/[id]/request-changes-content/route.ts` (NEW)

Same pattern as request-changes-leads but calls `rejectCampaignContent(id, feedback)`:

```typescript
import { NextResponse } from "next/server";
import { getPortalSession } from "@/lib/portal-session";
import { getCampaign, rejectCampaignContent } from "@/lib/campaigns/operations";

export async function POST(
  req: Request,
  { params }: { params: Promise<{ id: string }> },
) {
  const { id } = await params;

  let session;
  try {
    session = await getPortalSession();
  } catch {
    return NextResponse.json({ error: "Unauthorized" }, { status: 401 });
  }

  const campaign = await getCampaign(id);
  if (!campaign) {
    return NextResponse.json({ error: "Not found" }, { status: 404 });
  }
  if (campaign.workspaceSlug !== session.workspaceSlug) {
    return NextResponse.json({ error: "Forbidden" }, { status: 403 });
  }

  const body = await req.json();
  const feedback = body.feedback;
  if (!feedback || typeof feedback !== "string" || !feedback.trim()) {
    return NextResponse.json(
      { error: "Feedback text is required" },
      { status: 400 },
    );
  }

  const updated = await rejectCampaignContent(id, feedback.trim());

  return NextResponse.json({ campaign: updated });
}
```

**Key details:**
- Rejection routes require a `feedback` field in the JSON body and return 400 if missing/empty.
- Approval routes do not require a body.
- Notification wiring is NOT added here — Plan 09-05 handles that.

</details>
</task>

## Verification

```bash
# 1. All 6 route files exist
ls -la src/app/api/portal/campaigns/route.ts
ls -la src/app/api/portal/campaigns/\[id\]/route.ts
ls -la src/app/api/portal/campaigns/\[id\]/approve-leads/route.ts
ls -la src/app/api/portal/campaigns/\[id\]/request-changes-leads/route.ts
ls -la src/app/api/portal/campaigns/\[id\]/approve-content/route.ts
ls -la src/app/api/portal/campaigns/\[id\]/request-changes-content/route.ts

# 2. Every route imports getPortalSession
grep "getPortalSession" src/app/api/portal/campaigns/**/route.ts

# 3. Every [id] route checks workspace ownership
grep "workspaceSlug" src/app/api/portal/campaigns/\[id\]/**/route.ts

# 4. TypeScript compiles
npx tsc --noEmit --pretty 2>&1 | head -30
```
