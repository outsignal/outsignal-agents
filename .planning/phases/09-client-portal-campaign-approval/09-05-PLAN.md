---
plan: 09-05
phase: 09-client-portal-campaign-approval
title: "Approval Notifications (Slack + Email) + Wiring into API Routes"
wave: 3
depends_on:
  - 09-01
  - 09-02
requirements:
  - NOTIF-01
  - NOTIF-02
  - PORTAL-06
files_modified:
  - src/lib/notifications.ts
  - src/app/api/portal/campaigns/[id]/approve-leads/route.ts
  - src/app/api/portal/campaigns/[id]/request-changes-leads/route.ts
  - src/app/api/portal/campaigns/[id]/approve-content/route.ts
  - src/app/api/portal/campaigns/[id]/request-changes-content/route.ts
autonomous: true
---

# Plan 09-05: Approval Notifications (Slack + Email) + API Route Wiring

## Goal

Create `notifyApproval()` in `notifications.ts` that sends Slack and email notifications when a client approves or rejects leads or content. Wire this function into the four approval/rejection API routes as non-blocking calls. Send a distinct "fully approved" notification when dual approval triggers the `approved` status transition.

## Context

- CONTEXT.md locked decisions:
  - Structured Slack block notifications: header "[Rise] Campaign Update", body shows what was approved/rejected, feedback text if rejection, "View Campaign" action button.
  - Notifications go to a **dedicated approvals channel** (`workspace.approvalsSlackChannelId`, added in 09-01). Falls back to `workspace.slackChannelId`.
  - Email notifications include full feedback text inline.
  - Dual-approval fires a distinct "Campaign fully approved -- auto-deploy triggered" notification.
- Existing patterns: `notifyReply()` in `src/lib/notifications.ts` uses `postMessage()` from slack.ts and `sendNotificationEmail()` from resend.ts. Follow the same pattern.
- The four action API routes from 09-02 already exist. This plan adds `notifyApproval()` calls to them.
- The dual-approval check: after calling `approveCampaignLeads()` or `approveCampaignContent()`, check if the returned `campaign.status === 'approved'` (the operations function auto-transitions). If so, send the "both_approved" notification instead of the individual one.

## must_haves

- [ ] `notifyApproval()` function exists in `src/lib/notifications.ts`
- [ ] Slack notification sent to `workspace.approvalsSlackChannelId` (or fallback to `slackChannelId`)
- [ ] Slack notification uses structured blocks: header, campaign name, action status, feedback (if rejection), "View Campaign" button
- [ ] Email notification sent to `workspace.notificationEmails` with full feedback text inline
- [ ] When both leads AND content are approved (dual approval), a distinct "fully approved" notification fires (NOTIF-01, NOTIF-02)
- [ ] Notifications are non-blocking (`.catch()` pattern) -- API routes return immediately without waiting for notification delivery
- [ ] All four action API routes call `notifyApproval()` after the mutation

## Tasks

<task id="09-05-T1">
<title>Create notifyApproval() function in notifications.ts</title>
<details>

**File:** `src/lib/notifications.ts` (MODIFY)

Add the `notifyApproval()` function below the existing `notifyReply()` function. Follow the same pattern: fetch workspace, send Slack, send email.

```typescript
export async function notifyApproval(params: {
  workspaceSlug: string;
  campaignId: string;
  campaignName: string;
  action:
    | "leads_approved"
    | "leads_rejected"
    | "content_approved"
    | "content_rejected"
    | "both_approved";
  feedback: string | null;
}): Promise<void> {
  const workspace = await prisma.workspace.findUnique({
    where: { slug: params.workspaceSlug },
  });

  if (!workspace) return;

  const isFullyApproved = params.action === "both_approved";
  const isRejection = params.action.includes("rejected");

  const headerText = isFullyApproved
    ? `[${workspace.name}] Campaign Fully Approved`
    : `[${workspace.name}] Campaign Update`;

  const actionLabel: Record<string, string> = {
    leads_approved: "Leads approved",
    leads_rejected: "Changes requested for leads",
    content_approved: "Content approved",
    content_rejected: "Changes requested for content",
    both_approved:
      "Both leads and content approved — auto-deploy triggered",
  };

  const campaignUrl = `${process.env.NEXT_PUBLIC_APP_URL ?? "https://admin.outsignal.ai"}/campaigns/${params.campaignId}`;

  // ---------- Slack ----------

  // Use dedicated approvals channel, fall back to workspace reply channel
  const slackChannelId =
    (workspace as Record<string, unknown>).approvalsSlackChannelId as string | null
    ?? workspace.slackChannelId;

  if (slackChannelId) {
    try {
      await postMessage(slackChannelId, headerText, [
        {
          type: "header",
          text: { type: "plain_text", text: headerText },
        },
        {
          type: "section",
          text: {
            type: "mrkdwn",
            text: `*Campaign:* ${params.campaignName}`,
          },
        },
        {
          type: "section",
          text: {
            type: "mrkdwn",
            text: `*Status:* ${actionLabel[params.action]}`,
          },
        },
        ...(isRejection && params.feedback
          ? [
              {
                type: "section" as const,
                text: {
                  type: "mrkdwn" as const,
                  text: `*Feedback:*\n${params.feedback}`,
                },
              },
            ]
          : []),
        ...(isFullyApproved
          ? [
              {
                type: "section" as const,
                text: {
                  type: "mrkdwn" as const,
                  text: ":white_check_mark: *All approvals received. Auto-deploy will begin shortly.*",
                },
              },
            ]
          : []),
        {
          type: "actions",
          elements: [
            {
              type: "button",
              text: { type: "plain_text", text: "View Campaign" },
              url: campaignUrl,
            },
          ],
        },
      ]);
    } catch (err) {
      console.error("Slack approval notification failed:", err);
    }
  }

  // ---------- Email ----------

  if (workspace.notificationEmails) {
    try {
      const recipients: string[] = JSON.parse(workspace.notificationEmails);
      if (recipients.length > 0) {
        const subjectLine = isFullyApproved
          ? `[${workspace.name}] Campaign Fully Approved — ${params.campaignName}`
          : `[${workspace.name}] ${actionLabel[params.action]} — ${params.campaignName}`;

        await sendNotificationEmail({
          to: recipients,
          subject: subjectLine,
          html: `<div style="font-family:Arial,Helvetica,sans-serif;color:#1a1a1a;">
<h2 style="margin-bottom:16px;">${headerText}</h2>
<p><strong>Campaign:</strong> ${params.campaignName}</p>
<p><strong>Status:</strong> ${actionLabel[params.action]}</p>
${
  isRejection && params.feedback
    ? `<hr style="border:none;border-top:1px solid #e5e7eb;margin:16px 0;" />
<p style="font-size:12px;color:#6b7280;margin-bottom:4px;">CLIENT FEEDBACK</p>
<div style="background-color:#fef3c7;border-left:3px solid #f59e0b;padding:12px 16px;margin:8px 0 16px 0;border-radius:4px;">
  <p style="white-space:pre-wrap;margin:0;color:#92400e;">${params.feedback}</p>
</div>`
    : ""
}
${
  isFullyApproved
    ? `<hr style="border:none;border-top:1px solid #e5e7eb;margin:16px 0;" />
<div style="background-color:#d1fae5;border-left:3px solid #10b981;padding:12px 16px;margin:8px 0 16px 0;border-radius:4px;">
  <p style="margin:0;color:#065f46;font-weight:600;">All approvals received. Auto-deploy will begin shortly.</p>
</div>`
    : ""
}
<table role="presentation" cellpadding="0" cellspacing="0" border="0" style="margin:24px 0;">
  <tr>
    <td style="background-color:#F0FF7A;border-radius:6px;padding:0;">
      <a href="${campaignUrl}" target="_blank" style="display:inline-block;padding:12px 24px;font-size:14px;font-weight:600;color:#18181b;text-decoration:none;border-radius:6px;"><span style="color:#18181b;text-decoration:none;">View Campaign</span></a>
    </td>
  </tr>
</table>
</div>`,
        });
      }
    } catch (err) {
      console.error("Email approval notification failed:", err);
    }
  }
}
```

**IMPORTANT NOTE on `approvalsSlackChannelId`:** After the Prisma migration in 09-01, the Prisma client will have `approvalsSlackChannelId` on the Workspace type. However, if the executor encounters a type error because the generated client hasn't been updated yet, use `(workspace as Record<string, unknown>).approvalsSlackChannelId as string | null` as a safe cast. Once `prisma generate` runs, direct property access works. The code above uses the safe cast pattern — the executor should verify whether the Prisma client is regenerated and simplify the access if so (change to `workspace.approvalsSlackChannelId ?? workspace.slackChannelId`).

</details>
</task>

<task id="09-05-T2">
<title>Wire notifyApproval() into the four action API routes</title>
<details>

Modify all four action routes created in 09-02 to call `notifyApproval()` after the mutation. The call is non-blocking (fire-and-forget with `.catch()`).

### File 1: `src/app/api/portal/campaigns/[id]/approve-leads/route.ts`

Add import at the top:
```typescript
import { notifyApproval } from "@/lib/notifications";
```

After `const updated = await approveCampaignLeads(id);`, add:

```typescript
  // Determine if this triggered dual approval
  const action = updated.status === "approved" ? "both_approved" : "leads_approved";

  // Non-blocking notification
  notifyApproval({
    workspaceSlug: session.workspaceSlug,
    campaignId: id,
    campaignName: campaign.name,
    action,
    feedback: null,
  }).catch((err) => console.error("Approval notification failed:", err));
```

### File 2: `src/app/api/portal/campaigns/[id]/request-changes-leads/route.ts`

Add import and after `const updated = await rejectCampaignLeads(id, feedback.trim());`:

```typescript
  notifyApproval({
    workspaceSlug: session.workspaceSlug,
    campaignId: id,
    campaignName: campaign.name,
    action: "leads_rejected",
    feedback: feedback.trim(),
  }).catch((err) => console.error("Approval notification failed:", err));
```

### File 3: `src/app/api/portal/campaigns/[id]/approve-content/route.ts`

Add import and after `const updated = await approveCampaignContent(id);`:

```typescript
  const action = updated.status === "approved" ? "both_approved" : "content_approved";

  notifyApproval({
    workspaceSlug: session.workspaceSlug,
    campaignId: id,
    campaignName: campaign.name,
    action,
    feedback: null,
  }).catch((err) => console.error("Approval notification failed:", err));
```

### File 4: `src/app/api/portal/campaigns/[id]/request-changes-content/route.ts`

Add import and after `const updated = await rejectCampaignContent(id, feedback.trim());`:

```typescript
  notifyApproval({
    workspaceSlug: session.workspaceSlug,
    campaignId: id,
    campaignName: campaign.name,
    action: "content_rejected",
    feedback: feedback.trim(),
  }).catch((err) => console.error("Approval notification failed:", err));
```

**Key details:**
- The dual-approval detection uses `updated.status === "approved"` — the operations functions in 09-01 auto-transition status to 'approved' when both approvals are true. So we check the returned status to decide whether to send "both_approved" or the individual action notification.
- Only approval routes need the dual-approval check. Rejection routes always send their specific action.
- `.catch()` ensures the API route returns immediately. Notification failure is logged but does not fail the response.

</details>
</task>

## Verification

```bash
# 1. notifyApproval function exists
grep "export async function notifyApproval" src/lib/notifications.ts

# 2. All four action routes import notifyApproval
grep "notifyApproval" src/app/api/portal/campaigns/\[id\]/approve-leads/route.ts
grep "notifyApproval" src/app/api/portal/campaigns/\[id\]/request-changes-leads/route.ts
grep "notifyApproval" src/app/api/portal/campaigns/\[id\]/approve-content/route.ts
grep "notifyApproval" src/app/api/portal/campaigns/\[id\]/request-changes-content/route.ts

# 3. Both_approved dual-approval check present in approve routes
grep "both_approved" src/app/api/portal/campaigns/\[id\]/approve-leads/route.ts
grep "both_approved" src/app/api/portal/campaigns/\[id\]/approve-content/route.ts

# 4. Non-blocking .catch() pattern
grep "\.catch" src/app/api/portal/campaigns/\[id\]/approve-leads/route.ts

# 5. TypeScript compiles
npx tsc --noEmit --pretty 2>&1 | head -30
```
