---
milestone: v1.0
audited: 2026-02-26T23:45:00Z
status: tech_debt
scores:
  requirements: 17/17
  phases: 4/4
  integration: 16/17
  flows: 3/4
gaps:
  requirements: []
  integration:
    - id: "INT-02"
      from: "Phase 3 (MCP enrich_person)"
      to: "Phase 2 (waterfall providers)"
      issue: "MCP .mcp.json missing PROSPEO_API_KEY, FINDYMAIL_API_KEY, AIARK_API_KEY — enrich_person tool cannot reach 3 of 4 email providers or AI Ark person adapter via MCP process"
      affected_requirements: ["ENRICH-02", "ENRICH-04", "PROV-01", "PROV-02", "PROV-04"]
      severity: "critical"
      fix: "Add 3 env vars to .mcp.json env block"
  flows:
    - name: "MCP Agent enriches person"
      broken_at: "aiarkPersonAdapter call — AIARK_API_KEY undefined in MCP stdio process"
      reason: "3 provider API keys not forwarded to MCP env"
      affected_requirements: ["ENRICH-02", "ENRICH-04", "PROV-01", "PROV-02", "PROV-04"]
tech_debt:
  - phase: 01-enrichment-foundation
    items:
      - "Queue.ts line 59-66 has stale comment saying 'Phase 1 no-op'"
  - phase: 02-provider-adapters-waterfall
    items:
      - "AI Ark X-TOKEN auth header name is LOW confidence — may return 401/403 in production"
      - "FindyMail linkedin_url field name in request body is MEDIUM confidence"
      - "Firecrawl extract() used in company adapter is self-documented as deprecated — risk if endpoint removed"
      - "PROV-02 and PROV-05 not listed in SUMMARY frontmatter requirements_completed (bookkeeping gap only)"
  - phase: 03-icp-qualification-leads-agent
    items:
      - "verifyEmail() does not pass workspaceSlug to recordEnrichment — verification costs lack workspace attribution in cost dashboard"
      - "normalizationPrompt field stored on Workspace and manageable via MCP but not consumed by any normalizer code path"
      - "outreachTonePrompt field stored on Workspace and manageable via MCP but not consumed by any code path (expected Phase 5 writer agent)"
      - "export_to_emailbison outputs CSV stub instead of calling EmailBison API (explicitly scoped to Phase 5)"
      - "GET /api/enrichment/costs has no auth guard — read-only cost data exposed without authentication"
  - phase: operational
    items:
      - "No Vercel Cron schedule configured for enrichment batch processing (vercel.json absent)"
      - "CRON_SECRET env var needs to be set in Vercel for auth guards to pass in production"
      - "Cost dashboard (/enrichment-costs) not linked in sidebar navigation"
resolved_since_last_audit:
  - id: "INT-01"
    description: "Missing auth guard on enrichment API routes"
    resolved_by: "Phase 3.1 — validateCronSecret with crypto.timingSafeEqual on both POST routes"
  - description: "Pre-existing TypeScript type error in emailbison-client.test.ts:76"
    resolved_by: "Phase 3.1 Plan 02 — double cast as unknown as typeof fetch"
  - description: "dailyCostTotal absent from test mock setup"
    resolved_by: "Phase 3.1 Plan 02 — added to setup.ts with findUnique and upsert mocks"
  - description: ".mcp.json missing FIRECRAWL_API_KEY, ANTHROPIC_API_KEY, LEADMAGIC_API_KEY"
    resolved_by: "Phase 3.1 Plan 01 — added all three with ${VAR} syntax"
---

# Milestone v1.0 Audit Report

**Milestone:** v1.0 — Outsignal Lead Engine
**Audited:** 2026-02-26T23:45:00Z
**Previous audit:** 2026-02-26 (INT-01 found → Phase 3.1 inserted → re-audited → tech_debt)
**Status:** TECH DEBT — all 17 completed-phase requirements met, 1 integration gap (MCP env keys), accumulated deferred items

---

## Scope

This audit covers Phases 1–3.1 (all completed work). Phases 4 (Search + List Building) and 5 (Export + EmailBison) are planned in ROADMAP.md but not yet started — their 12 requirements (SEARCH-01–05, LIST-01–04, EXPORT-01–03) are tracked as Pending in REQUIREMENTS.md, not as audit gaps.

---

## Requirements Coverage (3-Source Cross-Reference)

**Score: 17/17 completed-phase requirements satisfied**

| REQ-ID | Description | Phase | VERIFICATION | SUMMARY | REQS.md | Final |
|--------|-------------|-------|-------------|---------|---------|-------|
| ENRICH-01 | Dedup-first local DB check | 1 | SATISFIED | 01-01 | [x] | satisfied |
| ENRICH-02 | Person waterfall (Prospeo → AI Ark → LM → FM) | 2 | SATISFIED | 02-01 | [x] | satisfied |
| ENRICH-03 | Company waterfall (AI Ark → Firecrawl) | 2 | SATISFIED | 02-01 | [x] | satisfied |
| ENRICH-04 | Email finding waterfall | 2 | SATISFIED | 02-01 | [x] | satisfied |
| ENRICH-05 | Email verification via LeadMagic (hard gate) | 3 | SATISFIED | 03-01 | [x] | satisfied |
| ENRICH-06 | Enrichment provenance tracking | 1 | SATISFIED | 01-01 | [x] | satisfied |
| ENRICH-07 | Async batch enrichment | 1 | SATISFIED | 01-03 | [x] | satisfied |
| AI-01 | Industry/vertical classification via Claude | 1 | SATISFIED | 01-02 | [x] | satisfied |
| AI-02 | Company name normalization via Claude | 1 | SATISFIED | 01-02 | [x] | satisfied |
| AI-03 | Job title + seniority extraction via Claude | 1 | SATISFIED | 01-02 | [x] | satisfied |
| AI-04 | ICP qualification via Firecrawl + Haiku | 3 | SATISFIED | 03-01, 03-03 | [x] | satisfied |
| AI-05 | Custom AI prompts per workspace | 3 | SATISFIED | 03-01, 03-03 | [x] | satisfied |
| PROV-01 | Prospeo API integration | 2 | SATISFIED | 02-02 | [x] | satisfied |
| PROV-02 | AI Ark API (person + company) | 2 | SATISFIED | — | [x] | satisfied* |
| PROV-03 | LeadMagic API integration | 2 | SATISFIED | 02-02 | [x] | satisfied |
| PROV-04 | FindyMail API integration | 2 | SATISFIED | 02-02 | [x] | satisfied |
| PROV-05 | Firecrawl integration (ICP crawling) | 2 | SATISFIED | — | [x] | satisfied* |

*PROV-02/PROV-05 missing from SUMMARY frontmatter but verified with full evidence in VERIFICATION.md.

**Orphaned requirements:** None. All 17 REQ-IDs appear in at least one phase VERIFICATION.md.

---

## Phase Status

| Phase | Name | Plans | Status | Verification |
|-------|------|-------|--------|-------------|
| 1 | Enrichment Foundation | 3/3 | Complete | passed (13/13 truths) |
| 2 | Provider Adapters + Waterfall | 6/6 | Complete | passed (19/19 truths) |
| 3 | ICP Qualification + Leads Agent | 3/3 | Complete | passed (4/4 truths) |
| 3.1 | API Security + Hardening | 2/2 | Complete | passed (8/8 truths) |

**All 4 completed phases passed verification with 44/44 total truths confirmed.**

---

## Cross-Phase Integration

**Score: 16/17 connections verified**

### Verified Connections (16)

| From → To | Connection | Status |
|-----------|------------|--------|
| dedup.ts → waterfall.ts | shouldEnrich() called before every provider | WIRED |
| log.ts → waterfall.ts | recordEnrichment() called after every provider result | WIRED |
| queue.ts → waterfall.ts | processNextChunk onProcess callback calls enrichEmail/enrichCompany | WIRED |
| All 6 providers → waterfall.ts | Imported and called in correct waterfall order | WIRED |
| costs.ts → waterfall.ts | checkDailyCap/incrementDailySpend in all provider loops | WIRED |
| normalizers → waterfall.ts | classifyJobTitle/classifyCompanyName/classifyIndustry called inline | WIRED |
| merge.ts → waterfall.ts | mergePersonData/mergeCompanyData with null-guard writes | WIRED |
| MCP tools → waterfall.ts | enrich_person imports enrichEmail/enrichCompany | WIRED |
| MCP tools → scorer.ts | score_person imports scorePersonIcp | WIRED |
| MCP tools → verification | export imports verifyEmail/getVerificationStatus | WIRED |
| crawl-cache.ts → firecrawl client | getCrawlMarkdown imports scrapeUrl | WIRED |
| scorer.ts → crawl-cache.ts | scorePersonIcp calls getCrawlMarkdown | WIRED |
| cron-auth.ts → enrichment routes | validateCronSecret as first action in both POST handlers | WIRED |
| cost dashboard → /api/enrichment/costs | fetch() in useEffect | WIRED |
| .mcp.json → MCP server | DATABASE_URL, FIRECRAWL, ANTHROPIC, LEADMAGIC keys forwarded | WIRED |
| verification → costs.ts | incrementDailySpend("leadmagic-verify") in verifyEmail | WIRED |

### Integration Gap (1)

**INT-02: MCP .mcp.json missing 3 provider API keys**

| Key | Used By | Impact |
|-----|---------|--------|
| PROSPEO_API_KEY | prospeoAdapter | enrich_person fails for Prospeo |
| FINDYMAIL_API_KEY | findymailAdapter | enrich_person fails for FindyMail |
| AIARK_API_KEY | aiarkPersonAdapter + aiarkAdapter | enrich_person fails for AI Ark person/company |

- **Scope:** MCP process only — Vercel-hosted batch routes have all keys from Vercel env
- **Fix:** Add 3 entries to `.mcp.json` env block with `${VAR}` syntax

---

## E2E Flows

**Score: 3/4 flows complete**

| Flow | Status | Notes |
|------|--------|-------|
| Batch enrichment (enqueue → waterfall → normalize → log) | Complete | Auth-guarded, all providers wired |
| ICP scoring (crawl cache → Haiku scorer → persist) | Complete | MCP tool works end-to-end |
| Export gate (verify emails → block non-valid → CSV) | Complete | Hard "valid"-only policy |
| MCP enrichment (enrich_person → waterfall) | **Broken** | 3 provider keys missing from MCP env |

---

## Tech Debt Summary

**13 items across 4 categories**

### Phase 1 (1 item)
- Stale comment in queue.ts ("Phase 1 no-op")

### Phase 2 (4 items)
- AI Ark X-TOKEN auth header — LOW confidence (may 401 in production)
- FindyMail linkedin_url field name — MEDIUM confidence
- Firecrawl extract() used in company adapter is self-documented as deprecated
- PROV-02/PROV-05 SUMMARY frontmatter gap (bookkeeping only)

### Phase 3 (5 items)
- verifyEmail() missing workspaceSlug on recordEnrichment — verification costs lack workspace attribution
- normalizationPrompt stored but not consumed by normalizers
- outreachTonePrompt stored but not consumed (expected Phase 5)
- export_to_emailbison CSV stub (explicitly Phase 5 scope)
- GET /api/enrichment/costs has no auth guard

### Operational (3 items)
- No Vercel Cron schedule for batch processing
- CRON_SECRET env var needs Vercel configuration
- Cost dashboard not linked in sidebar navigation

---

## Resolved Since Previous Audit

| Issue | Resolved By |
|-------|-------------|
| INT-01: Unauthenticated enrichment routes | Phase 3.1 — validateCronSecret |
| TS2322 in emailbison-client.test.ts | Phase 3.1 — double cast fix |
| dailyCostTotal missing from test mock | Phase 3.1 — added to setup.ts |
| .mcp.json missing FIRECRAWL, ANTHROPIC, LEADMAGIC keys | Phase 3.1 — added with ${VAR} syntax |

---

## Human Verification Items

1. **Live DB schema sync** — Confirm all Prisma models exist in Neon
2. **End-to-end person enrichment** — Trigger with real API keys, verify waterfall order
3. **End-to-end company enrichment** — Verify AI Ark → Firecrawl fallback
4. **Daily cap enforcement** — Set ENRICHMENT_DAILY_CAP_USD=0.001, verify pause
5. **Cost dashboard rendering** — Visual check of Recharts at /enrichment-costs
6. **ICP scoring end-to-end** — Configure workspace prompt, verify Haiku response
7. **Export hard gate** — Test with mixed-status emails, verify block

---

*Audited: 2026-02-26T23:45:00Z*
*Auditor: Claude (gsd audit-milestone)*
