generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["postgresqlExtensions"]
}

datasource db {
  provider   = "postgresql"
  url        = env("DATABASE_URL")
  extensions = [vector]
}

model Workspace {
  id       String  @id @default(cuid())
  slug     String  @unique
  name     String
  vertical String?
  apiToken String?
  status   String  @default("onboarding") // onboarding | pending_emailbison | active

  // Notification config
  slackChannelId            String?
  notificationEmails        String? // JSON array of email addresses
  approvalsSlackChannelId   String?
  approvalsSlackChannelName String?

  // Section 1 - LinkedIn Access
  linkedinUsername     String?
  linkedinPasswordNote String?

  // Section 2 - Sender Details
  senderFullName String?
  senderJobTitle String?
  senderPhone    String?
  senderAddress  String?

  // Section 3 - ICP
  icpCountries           String?
  icpIndustries          String?
  icpCompanySize         String?
  icpDecisionMakerTitles String?
  icpKeywords            String?
  icpExclusionCriteria   String?

  // Section 4-12 - Campaign brief
  coreOffers          String?
  pricingSalesCycle   String?
  differentiators     String?
  painPoints          String?
  caseStudies         String?
  leadMagnets         String?
  existingMessaging   String?
  supportingMaterials String?
  exclusionList       String?

  // Additional
  website            String?
  senderEmailDomains String? // JSON array of selected domains
  targetVolume       String?
  onboardingNotes    String?

  // Client portal access
  clientEmails String? // JSON array of authorized client email addresses

  // AI prompt overrides (managed via MCP tools)
  icpCriteriaPrompt    String?  // e.g. "Our ICP is SaaS companies, 50-200 employees in UK"
  normalizationPrompt  String?  // e.g. "Classify 'promo products' as 'Branded Merchandise'"
  outreachTonePrompt   String?  // e.g. "Professional but friendly"

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  senders    Sender[]
  campaigns  Campaign[]
}

model Person {
  id             String   @id @default(cuid())
  email          String   @unique
  firstName      String?
  lastName       String?
  company        String?
  companyDomain  String?
  jobTitle       String?
  phone          String?
  linkedinUrl    String?
  location       String?
  vertical       String?
  source         String // "clay" | "emailbison" | "manual"
  status         String   @default("new") // new | contacted | replied | interested | bounced | unsubscribed
  enrichmentData String?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  workspaces     PersonWorkspace[]
  lists          TargetListPerson[]

  @@index([source])
  @@index([status])
  @@index([company])
  @@index([vertical])
  @@map("Lead")
}

model PersonWorkspace {
  id        String   @id @default(cuid())
  personId  String   @map("leadId")
  workspace String
  sourceId  String?
  status    String   @default("new")
  vertical  String?
  tags      String?
  icpScore       Int?       // 0-100 ICP fit score (workspace-specific)
  icpReasoning   String?    // 1-3 sentence explanation of score
  icpConfidence  String?    // "high" | "medium" | "low" — data completeness indicator
  icpScoredAt    DateTime?  // When ICP was last scored
  createdAt DateTime @default(now())

  person    Person   @relation(fields: [personId], references: [id], onDelete: Cascade)

  @@unique([personId, workspace], map: "LeadWorkspace_leadId_workspace_key")
  @@index([workspace])
  @@index([status])
  @@map("LeadWorkspace")
}

model Company {
  id             String   @id @default(cuid())
  name           String
  domain         String   @unique
  industry       String?
  headcount      Int?
  location       String?
  website        String?
  linkedinUrl    String?
  description    String?
  revenue        String?
  yearFounded    Int?
  companyType    String?  // "private" | "public" | "nonprofit" | "government"
  techStack      String?  // JSON array
  enrichmentData String?  // JSON — extra fields from Clay
  crawlMarkdown  String?   // Raw homepage markdown from Firecrawl scrape (ICP scoring cache)
  crawledAt      DateTime? // When the homepage was last crawled (null = not yet crawled)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  @@index([industry])
  @@index([headcount])
}

model WebhookEvent {
  id          String   @id @default(cuid())
  workspace   String
  eventType   String
  campaignId  String?
  leadEmail   String?
  senderEmail String?
  payload     String
  receivedAt  DateTime @default(now())

  @@index([workspace, eventType])
  @@index([leadEmail])
  @@index([senderEmail, eventType])
}

model CachedMetrics {
  id         String   @id @default(cuid())
  workspace  String
  metricType String
  data       String
  computedAt DateTime @default(now())

  @@unique([workspace, metricType])
}

model Proposal {
  id     String @id @default(cuid())
  token  String @unique
  status String @default("draft") // draft | sent | accepted | paid | onboarding_complete

  // Client info (entered by admin)
  clientName      String
  clientEmail     String?
  companyOverview String

  // Package: "email" | "linkedin" | "email_linkedin"
  packageType String

  // Pricing in pence (defaults per package, admin can override)
  setupFee     Int @default(0)
  platformCost Int
  retainerCost Int

  // E-signature
  signedAt      DateTime?
  signatureName String?
  signatureData String?

  // Payment
  stripeSessionId   String?
  stripePaymentLink String?
  paidAt            DateTime?
  paidManually      Boolean   @default(false)

  // Link to workspace (created after onboarding)
  workspaceSlug String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model OnboardingInvite {
  id     String @id @default(cuid())
  token  String @unique
  status String @default("draft") // draft | sent | viewed | completed

  clientName  String
  clientEmail String?

  // Optional link to an existing proposal
  proposalId String?

  // Whether to create a workspace when onboarding completes
  createWorkspace Boolean @default(true)

  // Link to workspace (created after onboarding)
  workspaceSlug String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// --- Agent System ---

model AgentRun {
  id            String   @id @default(cuid())
  agent         String // "research" | "leads" | "writer" | "campaign"
  workspaceSlug String?
  input         String // JSON
  output        String? // JSON
  status        String   @default("running") // running | complete | failed
  steps         String? // JSON - tool call log
  durationMs    Int?
  error         String?
  triggeredBy   String? // "orchestrator" | "cli" | "api" | "pipeline"
  createdAt     DateTime @default(now())

  @@index([agent, workspaceSlug])
  @@index([status])
}

model WebsiteAnalysis {
  id            String   @id @default(cuid())
  workspaceSlug String
  url           String
  crawlData     String // JSON - raw page markdowns from Firecrawl
  analysis      String // JSON - structured ResearchOutput
  suggestions   String? // JSON - ICP enhancement suggestions
  status        String   @default("pending") // pending | crawling | analyzing | complete | failed
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@index([workspaceSlug])
}

model KnowledgeDocument {
  id        String   @id @default(cuid())
  title     String
  source    String // "upload" | "url"
  content   String // Full original text
  chunks    String // JSON array of text chunks
  tags      String? // Comma-separated tags for filtering
  createdAt DateTime @default(now())

  chunksRel KnowledgeChunk[]

  @@index([source])
}

model KnowledgeChunk {
  id          String   @id @default(cuid())
  documentId  String
  content     String   // The chunk text
  embedding   Unsupported("vector(1536)")? // OpenAI text-embedding-3-small dimension
  chunkIndex  Int      // Position within the document
  createdAt   DateTime @default(now())

  document KnowledgeDocument @relation(fields: [documentId], references: [id], onDelete: Cascade)

  @@index([documentId])
}

model EmailDraft {
  id              String   @id @default(cuid())
  workspaceSlug   String
  campaignName    String
  channel         String   @default("email") // "email" | "linkedin"
  sequenceStep    Int
  subjectLine     String?  // null for LinkedIn messages
  subjectVariantB String?
  bodyHtml        String?
  bodyText        String
  delayDays       Int      @default(1)
  status          String   @default("draft") // draft | review | approved | deployed
  version         Int      @default(1)
  feedback        String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([workspaceSlug, campaignName])
  @@index([status])
}

model EnrichmentLog {
  id           String   @id @default(cuid())
  entityId     String
  entityType   String   // "person" | "company"
  provider     String   // "prospeo" | "aiark" | "leadmagic" | "findymail" | "firecrawl" | "clay" | "ai-normalizer"
  status       String   @default("success") // "success" | "error" | "skipped"
  fieldsWritten String? // JSON array of field names written, e.g. ["email", "linkedinUrl"]
  costUsd      Float?   // provider cost in USD (null for free/AI calls)
  rawResponse   String?  // JSON — debug only, not indexed
  errorMessage  String?  // populated when status = "error"
  workspaceSlug String?
  runAt         DateTime @default(now())

  @@index([entityId, entityType])
  @@index([provider, status])
  @@index([runAt])
  @@index([workspaceSlug, provider])
}

model EnrichmentJob {
  id             String   @id @default(cuid())
  entityType     String   // "person" | "company"
  provider       String   // provider to run
  status         String   @default("pending") // "pending" | "running" | "complete" | "failed"
  totalCount     Int
  processedCount Int      @default(0)
  chunkSize      Int      @default(50)
  entityIds      String   // JSON array of entity IDs to process
  errorLog       String?  // JSON array of { entityId, error } for failures
  workspaceSlug  String?
  resumeAt       DateTime? // non-null when paused by daily cap; queue skips until this time
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  @@index([status])
}

model DailyCostTotal {
  id        String   @id @default(cuid())
  date      String   @unique // "YYYY-MM-DD" UTC
  totalUsd  Float    @default(0)
  breakdown String?  // JSON — per-provider breakdown { prospeo: 1.23, leadmagic: 0.45 }
  updatedAt DateTime @updatedAt
}

model TargetList {
  id            String   @id @default(cuid())
  name          String
  workspaceSlug String
  description   String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  people     TargetListPerson[]
  campaigns  Campaign[]

  @@index([workspaceSlug])
}

model TargetListPerson {
  id       String   @id @default(cuid())
  listId   String
  personId String
  addedAt  DateTime @default(now())

  list   TargetList @relation(fields: [listId], references: [id], onDelete: Cascade)
  person Person     @relation(fields: [personId], references: [id], onDelete: Cascade)

  @@unique([listId, personId])
  @@index([listId])
  @@index([personId])
}

// --- Campaign ---

model Campaign {
  id            String  @id @default(cuid())
  name          String
  workspaceSlug String
  description   String?

  // Status lifecycle
  // Transitions: draft -> internal_review -> pending_approval -> approved -> deployed -> active -> paused -> completed
  // Also: active -> paused -> active (bidirectional), any -> completed
  // Valid values: "draft" | "internal_review" | "pending_approval" | "approved" | "deployed" | "active" | "paused" | "completed"
  status String @default("draft")

  // Channel selection — JSON array: ["email"], ["linkedin"], or ["email", "linkedin"]
  channels String @default("[\"email\"]")

  // Lead ownership — nullable until a list is linked
  targetListId String?
  targetList   TargetList? @relation(fields: [targetListId], references: [id])

  // Content storage (JSON per step)
  // emailSequence: array of { position, subjectLine, subjectVariantB?, body, delayDays, notes? }
  // linkedinSequence: array of { position, type, body, delayDays, notes? }
  emailSequence    String?
  linkedinSequence String?

  // Lead approval (CAMP-04)
  leadsApproved   Boolean   @default(false)
  leadsFeedback   String?
  leadsApprovedAt DateTime?

  // Content approval (CAMP-04)
  contentApproved   Boolean   @default(false)
  contentFeedback   String?
  contentApprovedAt DateTime?

  // EmailBison linkage (used in Phase 10 deploy)
  emailBisonCampaignId Int?
  emailBisonSequenceId Int?

  // Timestamps
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  publishedAt DateTime? // When pushed for client review
  deployedAt  DateTime? // When deployed to EmailBison/LinkedIn

  // Relations
  workspace Workspace @relation(fields: [workspaceSlug], references: [slug])

  @@unique([workspaceSlug, name])
  @@index([workspaceSlug])
  @@index([status])
}

// --- LinkedIn Sequencer ---

model Sender {
  id            String  @id @default(cuid())
  workspaceSlug String
  name          String

  // Email identity (from EmailBison)
  emailAddress    String?
  emailSenderName String?

  // LinkedIn identity
  linkedinProfileUrl String?

  // LinkedIn credentials (encrypted at rest)
  linkedinEmail    String? // plaintext — not sensitive
  linkedinPassword String? // AES-256-GCM encrypted
  totpSecret       String? // AES-256-GCM encrypted
  loginMethod      String  @default("none") // "credentials" | "infinite" | "extension" | "none"

  // Session management (encrypted cookies)
  sessionData    String? // AES-256-GCM encrypted JSON
  sessionStatus  String  @default("not_setup") // not_setup | active | expired
  proxyUrl       String? // Dedicated residential proxy URL

  // Account tier
  linkedinTier String @default("free") // "free" | "premium"

  // Health metrics
  ssiScore       Int?
  acceptanceRate Float?
  healthStatus   String @default("healthy") // healthy | warning | paused | blocked | session_expired

  // Warm-up tracking
  warmupDay       Int       @default(0) // 0 = not started, 1-28 = warmup day
  warmupStartedAt DateTime?
  lastActiveAt    DateTime?

  // Rate limits (account-level, adjusted by warm-up)
  dailyConnectionLimit  Int @default(5)
  dailyMessageLimit     Int @default(10)
  dailyProfileViewLimit Int @default(15)

  status    String   @default("setup") // setup | active | paused | disabled
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  workspace   Workspace            @relation(fields: [workspaceSlug], references: [slug])
  actions     LinkedInAction[]
  dailyUsage  LinkedInDailyUsage[]
  connections LinkedInConnection[]

  @@index([workspaceSlug])
  @@index([status])
  @@index([healthStatus])
}

model LinkedInAction {
  id            String @id @default(cuid())
  senderId      String
  personId      String
  workspaceSlug String

  // Action details
  actionType  String  // "connect" | "message" | "profile_view" | "check_connection"
  messageBody String? // For message actions (template-substituted at enqueue time)

  // Scheduling & priority
  priority     Int      @default(5) // 1 = highest (warm lead), 5 = normal
  scheduledFor DateTime

  // Execution tracking
  status        String    @default("pending") // pending | running | complete | failed | cancelled | expired
  attempts      Int       @default(0)
  maxAttempts   Int       @default(3)
  lastAttemptAt DateTime?
  nextRetryAt   DateTime?

  // Result
  result      String? // JSON — success details or error info
  completedAt DateTime?

  // Linkage back to campaign context
  campaignName     String? // EmailBison campaign name
  emailBisonLeadId String? // EmailBison lead ID for sender resolution
  sequenceStepRef  String? // Which sequence step triggered this

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  sender Sender @relation(fields: [senderId], references: [id])

  @@index([status, scheduledFor])
  @@index([senderId, status])
  @@index([personId])
  @@index([priority, scheduledFor])
  @@index([workspaceSlug])
}

model LinkedInDailyUsage {
  id       String   @id @default(cuid())
  senderId String
  date     DateTime @db.Date

  connectionsSent     Int @default(0)
  messagesSent        Int @default(0)
  profileViews        Int @default(0)
  connectionsAccepted Int @default(0)

  // Health signals captured during the day
  captchaDetected   Boolean @default(false)
  restrictionNotice Boolean @default(false)

  sender Sender @relation(fields: [senderId], references: [id])

  @@unique([senderId, date])
  @@index([date])
}

model LinkedInConnection {
  id       String @id @default(cuid())
  senderId String
  personId String

  status        String    @default("none") // none | pending | connected | failed | expired
  requestSentAt DateTime?
  connectedAt   DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  sender Sender @relation(fields: [senderId], references: [id])

  @@unique([senderId, personId])
  @@index([status])
  @@index([senderId, status])
}

model CampaignSequenceRule {
  id            String @id @default(cuid())
  workspaceSlug String
  campaignName  String

  // Trigger: what event starts this rule
  triggerEvent   String  // "email_sent" | "connection_accepted" | "delay_after_previous"
  triggerStepRef String? // Reference to the email step that triggers this (e.g. "email_1")

  // Action to perform
  actionType      String  // "connect" | "message" | "profile_view"
  messageTemplate String? // Template with {{firstName}}, {{company}}, etc.
  delayMinutes    Int     @default(0) // Delay after trigger before executing

  // Conditions
  requireConnected Boolean @default(false) // Only fire if already connected

  position  Int // Order in the sequence
  createdAt DateTime @default(now())

  @@index([workspaceSlug, campaignName])
}

model MagicLinkToken {
  id            String   @id @default(cuid())
  token         String   @unique
  email         String
  workspaceSlug String
  expiresAt     DateTime
  used          Boolean  @default(false)
  createdAt     DateTime @default(now())

  @@index([token])
  @@index([email])
}
